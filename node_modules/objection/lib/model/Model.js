'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _getOwnPropertyDescriptor = require('babel-runtime/core-js/object/get-own-property-descriptor');

var _getOwnPropertyDescriptor2 = _interopRequireDefault(_getOwnPropertyDescriptor);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _dec, _dec2, _dec3, _dec4, _desc, _value, _class, _class2, _temp;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _ModelBase2 = require('./ModelBase');

var _ModelBase3 = _interopRequireDefault(_ModelBase2);

var _QueryBuilder = require('../queryBuilder/QueryBuilder');

var _QueryBuilder2 = _interopRequireDefault(_QueryBuilder);

var _inheritModel = require('./inheritModel');

var _inheritModel2 = _interopRequireDefault(_inheritModel);

var _RelationExpression = require('../queryBuilder/RelationExpression');

var _RelationExpression2 = _interopRequireDefault(_RelationExpression);

var _hiddenData = require('../utils/hiddenData');

var _hiddenData2 = require('../utils/decorators/hiddenData');

var _hiddenData3 = _interopRequireDefault(_hiddenData2);

var _deprecated = require('../utils/decorators/deprecated');

var _deprecated2 = _interopRequireDefault(_deprecated);

var _memoize = require('../utils/decorators/memoize');

var _memoize2 = _interopRequireDefault(_memoize);

var _Relation = require('../relations/Relation');

var _Relation2 = _interopRequireDefault(_Relation);

var _HasOneRelation = require('../relations/hasOne/HasOneRelation');

var _HasOneRelation2 = _interopRequireDefault(_HasOneRelation);

var _HasManyRelation = require('../relations/hasMany/HasManyRelation');

var _HasManyRelation2 = _interopRequireDefault(_HasManyRelation);

var _ManyToManyRelation = require('../relations/manyToMany/ManyToManyRelation');

var _ManyToManyRelation2 = _interopRequireDefault(_ManyToManyRelation);

var _BelongsToOneRelation = require('../relations/belongsToOne/BelongsToOneRelation');

var _BelongsToOneRelation2 = _interopRequireDefault(_BelongsToOneRelation);

var _InstanceFindOperation = require('../queryBuilder/operations/InstanceFindOperation');

var _InstanceFindOperation2 = _interopRequireDefault(_InstanceFindOperation);

var _InstanceInsertOperation = require('../queryBuilder/operations/InstanceInsertOperation');

var _InstanceInsertOperation2 = _interopRequireDefault(_InstanceInsertOperation);

var _InstanceUpdateOperation = require('../queryBuilder/operations/InstanceUpdateOperation');

var _InstanceUpdateOperation2 = _interopRequireDefault(_InstanceUpdateOperation);

var _InstanceDeleteOperation = require('../queryBuilder/operations/InstanceDeleteOperation');

var _InstanceDeleteOperation2 = _interopRequireDefault(_InstanceDeleteOperation);

var _JoinEagerOperation = require('../queryBuilder/operations/JoinEagerOperation');

var _JoinEagerOperation2 = _interopRequireDefault(_JoinEagerOperation);

var _WhereInEagerOperation = require('../queryBuilder/operations/WhereInEagerOperation');

var _WhereInEagerOperation2 = _interopRequireDefault(_WhereInEagerOperation);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {
  var desc = {};
  Object['ke' + 'ys'](descriptor).forEach(function (key) {
    desc[key] = descriptor[key];
  });
  desc.enumerable = !!desc.enumerable;
  desc.configurable = !!desc.configurable;

  if ('value' in desc || desc.initializer) {
    desc.writable = true;
  }

  desc = decorators.slice().reverse().reduce(function (desc, decorator) {
    return decorator(target, property, desc) || desc;
  }, desc);

  if (context && desc.initializer !== void 0) {
    desc.value = desc.initializer ? desc.initializer.call(context) : void 0;
    desc.initializer = undefined;
  }

  if (desc.initializer === void 0) {
    Object['define' + 'Property'](target, property, desc);
    desc = null;
  }

  return desc;
}

var JoinEagerAlgorithm = function JoinEagerAlgorithm() {
  return new _JoinEagerOperation2.default('eager');
};

var WhereInEagerAlgorithm = function WhereInEagerAlgorithm() {
  return new _WhereInEagerOperation2.default('eager');
};

var Model = (_dec = (0, _deprecated2.default)({ removedIn: '0.7.0', useInstead: 'BelongsToOneRelation' }), _dec2 = (0, _deprecated2.default)({ removedIn: '0.7.0', useInstead: 'HasManyRelation' }), _dec3 = (0, _hiddenData3.default)(), _dec4 = (0, _hiddenData3.default)(), (_class = (_temp = _class2 = function (_ModelBase) {
  (0, _inherits3.default)(Model, _ModelBase);

  function Model() {
    (0, _classCallCheck3.default)(this, Model);
    return (0, _possibleConstructorReturn3.default)(this, _ModelBase.apply(this, arguments));
  }

  /**
   * @param {*=} id
   * @returns {*}
   */
  Model.prototype.$id = function $id(id) {
    if (arguments.length > 0) {
      return setId(this, arguments[0]);
    } else {
      return getId(this);
    }
  };

  /**
   * @returns {knex}
   */


  Model.prototype.$knex = function $knex() {
    return this.constructor.knex();
  };

  /**
   * @returns {knex}
   */


  Model.prototype.$transaction = function $transaction() {
    return this.constructor.transaction();
  };

  /**
   * @param {Transaction=} trx
   * @returns {QueryBuilder}
   */


  Model.prototype.$query = function $query(trx) {
    var _this2 = this;

    var ModelClass = this.constructor;

    return ModelClass.QueryBuilder.forClass(ModelClass).transacting(trx).findOperationFactory(function () {
      return new _InstanceFindOperation2.default('find', { instance: _this2 });
    }).insertOperationFactory(function () {
      return new _InstanceInsertOperation2.default('insert', { instance: _this2 });
    }).updateOperationFactory(function () {
      return new _InstanceUpdateOperation2.default('update', { instance: _this2 });
    }).patchOperationFactory(function () {
      return new _InstanceUpdateOperation2.default('patch', { instance: _this2, modelOptions: { patch: true } });
    }).deleteOperationFactory(function () {
      return new _InstanceDeleteOperation2.default('delete', { instance: _this2 });
    }).relateOperationFactory(function () {
      throw new Error('`relate` makes no sense in this context');
    }).unrelateOperationFactory(function () {
      throw new Error('`unrelate` makes no sense in this context');
    });
  };

  /**
   * @param {string} relationName
   * @param {Transaction=} trx
   * @returns {QueryBuilder}
   */


  Model.prototype.$relatedQuery = function $relatedQuery(relationName, trx) {
    var _this3 = this;

    var ModelClass = this.constructor;
    var relation = ModelClass.getRelation(relationName);
    var RelatedModelClass = relation.relatedModelClass;

    return ModelClass.RelatedQueryBuilder.forClass(RelatedModelClass).transacting(trx).findOperationFactory(function (builder) {
      return relation.find(builder, [_this3]);
    }).insertOperationFactory(function (builder) {
      return relation.insert(builder, _this3);
    }).updateOperationFactory(function (builder) {
      return relation.update(builder, _this3);
    }).patchOperationFactory(function (builder) {
      return relation.patch(builder, _this3);
    }).deleteOperationFactory(function (builder) {
      return relation.delete(builder, _this3);
    }).relateOperationFactory(function (builder) {
      return relation.relate(builder, _this3);
    }).unrelateOperationFactory(function (builder) {
      return relation.unrelate(builder, _this3);
    });
  };

  /**
   * @param {string|RelationExpression} relationExpression
   * @param {Object.<string, function(QueryBuilder)>=} filters
   * @returns {QueryBuilder}
   */


  Model.prototype.$loadRelated = function $loadRelated(relationExpression, filters) {
    return this.constructor.loadRelated(this, relationExpression, filters);
  };

  /**
   * @param {Constructor.<Model>=} filterConstructor
   * @param {function(Model)} callback
   * @return {Model}
   */


  Model.prototype.$traverse = function $traverse(filterConstructor, callback) {
    if (_lodash2.default.isUndefined(callback)) {
      callback = filterConstructor;
      filterConstructor = null;
    }

    this.constructor.traverse(filterConstructor, this, callback);
    return this;
  };

  Model.prototype.$validate = function $validate() {
    var json = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this;
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    if (json instanceof Model) {
      // Strip away relations and other internal stuff.
      json = json.$parseJson(json.$toJson(true));
    }

    return _ModelBase.prototype.$validate.call(this, json, options);
  };

  Model.prototype.$parseDatabaseJson = function $parseDatabaseJson(json) {
    var jsonAttr = this.constructor.getJsonAttributes();

    if (jsonAttr.length) {
      for (var i = 0, l = jsonAttr.length; i < l; ++i) {
        var attr = jsonAttr[i];
        var value = json[attr];

        if (_lodash2.default.isString(value)) {
          json[attr] = JSON.parse(value);
        }
      }
    }

    return json;
  };

  Model.prototype.$formatDatabaseJson = function $formatDatabaseJson(json) {
    var jsonAttr = this.constructor.getJsonAttributes();

    if (jsonAttr.length) {
      for (var i = 0, l = jsonAttr.length; i < l; ++i) {
        var attr = jsonAttr[i];
        var value = json[attr];

        if (_lodash2.default.isObject(value)) {
          json[attr] = (0, _stringify2.default)(value);
        }
      }
    }

    return json;
  };

  Model.prototype.$setJson = function $setJson(json, options) {
    _ModelBase.prototype.$setJson.call(this, json, options);

    if (!_lodash2.default.isObject(json)) {
      return;
    }

    var relations = this.constructor.getRelations();
    var relNames = (0, _keys2.default)(relations);

    // Parse relations into Model instances.
    for (var i = 0, l = relNames.length; i < l; ++i) {
      var relationName = relNames[i];

      if (_lodash2.default.has(json, relationName)) {
        var relationJson = json[relationName];
        var relation = relations[relationName];

        if (Array.isArray(relationJson)) {
          this[relationName] = relation.relatedModelClass.ensureModelArray(relationJson, options);
        } else if (relationJson) {
          this[relationName] = relation.relatedModelClass.ensureModel(relationJson, options);
        } else {
          this[relationName] = null;
        }
      }
    }
  };

  /**
   * @param {boolean=} shallow
   */


  Model.prototype.$toJson = function $toJson(shallow) {
    if (shallow) {
      return this.$$toJson(false, this.constructor.getRelations(), null);
    } else {
      return this.$$toJson(false, null, null);
    }
  };

  /**
   * @override
   */


  Model.prototype.$toDatabaseJson = function $toDatabaseJson() {
    var jsonSchema = this.constructor.getJsonSchema();

    if (jsonSchema && this.constructor.pickJsonSchemaProperties) {
      return this.$$toJson(true, null, jsonSchema.properties);
    } else {
      return this.$$toJson(true, this.constructor.getRelations(), null);
    }
  };

  /**
   * @param {Object} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$beforeInsert = function $beforeInsert(queryContext) {};

  /**
   * @param {Object} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$afterInsert = function $afterInsert(queryContext) {};

  /**
   * @param {ModelOptions} opt
   * @param {QueryBuilderContext} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$beforeUpdate = function $beforeUpdate(opt, queryContext) {};

  /**
   * @param {ModelOptions} opt
   * @param {QueryBuilderContext} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$afterUpdate = function $afterUpdate(opt, queryContext) {};

  /**
   * @param {QueryBuilderContext} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$afterGet = function $afterGet(queryContext) {};

  /**
   * @param {QueryBuilderContext} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$beforeDelete = function $beforeDelete(queryContext) {};

  /**
   * @param {QueryBuilderContext} queryContext
   * @returns {Promise|*}
   */


  Model.prototype.$afterDelete = function $afterDelete(queryContext) {};

  /**
   * @param {Transaction=} trx
   * @returns {QueryBuilder}
   */


  Model.query = function query(trx) {
    var ModelClass = this;

    return ModelClass.QueryBuilder.forClass(ModelClass).transacting(trx).relateOperationFactory(function () {
      throw new Error('`relate` makes no sense in this context');
    }).unrelateOperationFactory(function () {
      throw new Error('`unrelate` makes no sense in this context');
    });
  };

  /**
   * @param {knex=} knex
   * @returns {knex}
   */


  Model.knex = function knex(_knex) {
    if (arguments.length) {
      this.$$knex = _knex;
    } else {
      return this.$$knex;
    }
  };

  /**
   * @returns {knex}
   */


  Model.transaction = function transaction() {
    return this.knex();
  };

  /**
   * @return {Raw}
   */


  Model.raw = function raw() {
    var knex = this.knex();
    return knex.raw.apply(knex, arguments);
  };

  /**
   * @return {Object}
   */


  Model.fn = function fn() {
    var knex = this.knex();
    return knex.fn;
  };

  /**
   * @return {Formatter}
   */


  Model.formatter = function formatter() {
    return this.knex().client.formatter();
  };

  /**
   * @returns {knex.QueryBuilder}
   */


  Model.knexQuery = function knexQuery() {
    return this.knex().table(this.tableName);
  };

  /**
   * @returns {string}
   */


  Model.uniqueTag = function uniqueTag() {
    return this.tableName;
  };

  /**
   * @param {knex} knex
   * @returns {Constructor.<Model>}
   */


  Model.bindKnex = function bindKnex(knex) {
    var ModelClass = this;

    if (!knex.$$objection) {
      Object.defineProperty(knex, '$$objection', {
        enumerable: false,
        writable: false,
        value: {
          boundModels: (0, _create2.default)(null)
        }
      });
    }

    // Check if this model class has already been bound to the given knex.
    if (knex.$$objection.boundModels[ModelClass.uniqueTag()]) {
      return knex.$$objection.boundModels[ModelClass.uniqueTag()];
    }

    // Create a new subclass of this class.
    var BoundModelClass = (0, _inheritModel2.default)(ModelClass);

    // The bound model is equal to the source model in every way. We want to copy
    // the hidden data as-is from the source so that we don't get the performance
    // penalty of calculating all memoized etc. values again.
    (0, _hiddenData.inheritHiddenData)(ModelClass, BoundModelClass);

    BoundModelClass.knex(knex);
    knex.$$objection.boundModels[ModelClass.uniqueTag()] = BoundModelClass;

    var boundRelations = (0, _create2.default)(null);
    var relations = ModelClass.getRelations();
    var relNames = (0, _keys2.default)(relations);

    for (var i = 0, l = relNames.length; i < l; ++i) {
      var relName = relNames[i];
      var relation = relations[relName];
      boundRelations[relName] = relation.bindKnex(knex);
    }

    BoundModelClass.relations = boundRelations;
    return BoundModelClass;
  };

  /**
   * @param {knex} trx
   * @returns {Constructor.<Model>}
   */


  Model.bindTransaction = function bindTransaction(trx) {
    return this.bindKnex(trx);
  };

  /**
   * @param {Model|Object} model
   * @param {ModelOptions=} options
   * @returns {Model}
   */


  Model.ensureModel = function ensureModel(model, options) {
    var ModelClass = this;

    if (!model) {
      return null;
    }

    if (model instanceof ModelClass) {
      return model;
    } else {
      return ModelClass.fromJson(model, options);
    }
  };

  /**
   * @param {Array.<Model|Object>} input
   * @param {ModelOptions=} options
   * @returns {Array.<Model>}
   */


  Model.ensureModelArray = function ensureModelArray(input, options) {
    if (!input) {
      return [];
    }

    if (Array.isArray(input)) {
      var models = new Array(input.length);

      for (var i = 0, l = input.length; i < l; ++i) {
        models[i] = this.ensureModel(input[i], options);
      }

      return models;
    } else {
      return [this.ensureModel(input, options)];
    }
  };

  /**
   * @returns {Array.<string>}
   */


  Model.getIdColumnArray = function getIdColumnArray() {
    if (Array.isArray(this.idColumn)) {
      return this.idColumn;
    } else {
      return [this.idColumn];
    }
  };

  /**
   * @returns {string|Array.<string>}
   */


  Model.getFullIdColumn = function getFullIdColumn() {
    var _this4 = this;

    if (Array.isArray(this.idColumn)) {
      return this.idColumn.map(function (col) {
        return _this4.tableName + '.' + col;
      });
    } else {
      return this.tableName + '.' + this.idColumn;
    }
  };

  /**
   * @returns {Array.<string>}
   */


  Model.getIdPropertyArray = function getIdPropertyArray() {
    var _this5 = this;

    return this.getIdColumnArray().map(function (col) {
      return idColumnToIdProperty(_this5, col);
    });
  };

  /**
   * @returns {string|Array.<string>}
   */


  Model.getIdProperty = function getIdProperty() {
    var _this6 = this;

    if (Array.isArray(this.idColumn)) {
      return this.idColumn.map(function (col) {
        return idColumnToIdProperty(_this6, col);
      });
    } else {
      return idColumnToIdProperty(this, this.idColumn);
    }
  };

  /**
   * @private
   */


  /**
   * @return {Object.<string, Relation>}
   */
  Model.getRelations = function getRelations() {
    var _this7 = this;

    var relations = this.relations;

    if (!relations) {
      relations = _lodash2.default.reduce(this.relationMappings, function (relations, mapping, relationName) {
        relations[relationName] = new mapping.relation(relationName, _this7);
        relations[relationName].setMapping(mapping);
        return relations;
      }, (0, _create2.default)(null));

      this.relations = relations;
    }

    return relations;
  };

  /**
   * @return {Relation}
   */


  Model.getRelation = function getRelation(name) {
    var relation = this.getRelations()[name];

    if (!relation) {
      throw new Error('A model class (tableName = ' + this.tableName + ') doesn\'t have relation ' + name);
    }

    return relation;
  };

  /**
   * @param {Array.<Model|Object>} $models
   * @param {string|RelationExpression} expression
   * @param {Object.<string, function(QueryBuilder)>=} filters
   * @returns {QueryBuilder}
   */


  Model.loadRelated = function loadRelated($models, expression, filters) {
    return this.query().resolve(this.ensureModelArray($models)).findOptions({ dontCallAfterGet: true }).eager(expression, filters).runAfter(function (models) {
      return Array.isArray($models) ? models : models[0];
    });
  };

  /**
   * @param {Constructor.<Model>=} filterConstructor
   * @param {Model|Array.<Model>} models
   * @param {function(Model, Model, string)} traverser
   * @return {Model}
   */


  Model.traverse = function traverse(filterConstructor, models, traverser) {
    filterConstructor = filterConstructor || null;

    if (_lodash2.default.isUndefined(traverser)) {
      traverser = models;
      models = filterConstructor;
      filterConstructor = null;
    }

    if (!_lodash2.default.isFunction(traverser)) {
      throw new Error('traverser must be a function');
    }

    _traverse(models, null, null, filterConstructor, traverser);
    return this;
  };

  /**
   * @protected
   * @returns {Array.<string>}
   */


  Model.getJsonAttributes = function getJsonAttributes() {
    var _this8 = this;

    // If the jsonAttributes property is not set, try to create it based
    // on the jsonSchema. All properties that are objects or arrays must
    // be converted to JSON.
    if (!this.jsonAttributes && this.getJsonSchema()) {
      this.jsonAttributes = [];

      _lodash2.default.forOwn(this.getJsonSchema().properties, function (prop, propName) {
        var types = _lodash2.default.compact(ensureArray(prop.type));

        if (types.length === 0 && Array.isArray(prop.anyOf)) {
          types = _lodash2.default.flattenDeep(_lodash2.default.map(prop.anyOf, 'type'));
        }

        if (types.length === 0 && Array.isArray(prop.oneOf)) {
          types = _lodash2.default.flattenDeep(_lodash2.default.map(prop.oneOf, 'type'));
        }

        if (_lodash2.default.includes(types, 'object') || _lodash2.default.includes(types, 'array')) {
          _this8.jsonAttributes.push(propName);
        }
      });
    }

    if (!Array.isArray(this.jsonAttributes)) {
      this.jsonAttributes = [];
    }

    return this.jsonAttributes;
  };

  (0, _createClass3.default)(Model, null, [{
    key: 'OneToOneRelation',
    get: function get() {
      return _BelongsToOneRelation2.default;
    }
  }, {
    key: 'OneToManyRelation',
    get: function get() {
      return _HasManyRelation2.default;
    }

    /**
     * @type {string}
     */


    /**
     * @type {string|Array.<string>}
     */


    /**
     * @type {string}
     */


    /**
     * @type {string}
     */


    /**
     * @type {string}
     */


    /**
     * @type {RegExp}
     */


    /**
     * @type {Array.<string>}
     */


    /**
     * @type {Object.<string, RelationMapping>}
     */


    /**
     * @type {Array.<string>}
     */


    /**
     * @type {boolean}
     */


    /**
     * @type {Constructor.<? extends EagerOperation>}
     */


    /**
     * @type {object}
     */


    /**
     * @private
     */

  }, {
    key: 'relations',
    get: function get() {}

    /**
     * @private
     */
    ,
    set: function set(value) {}
  }]);
  return Model;
}(_ModelBase3.default), _class2.QueryBuilder = _QueryBuilder2.default, _class2.RelatedQueryBuilder = _QueryBuilder2.default, _class2.HasOneRelation = _HasOneRelation2.default, _class2.HasManyRelation = _HasManyRelation2.default, _class2.ManyToManyRelation = _ManyToManyRelation2.default, _class2.BelongsToOneRelation = _BelongsToOneRelation2.default, _class2.JoinEagerAlgorithm = JoinEagerAlgorithm, _class2.WhereInEagerAlgorithm = WhereInEagerAlgorithm, _class2.tableName = null, _class2.idColumn = 'id', _class2.uidProp = '#id', _class2.uidRefProp = '#ref', _class2.dbRefProp = '#dbRef', _class2.propRefRegex = /#ref{([^\.]+)\.([^}]+)}/g, _class2.jsonAttributes = null, _class2.relationMappings = null, _class2.modelPaths = [], _class2.pickJsonSchemaProperties = true, _class2.defaultEagerAlgorithm = WhereInEagerAlgorithm, _class2.defaultEagerOptions = null, _class2.$$knex = null, _temp), (_applyDecoratedDescriptor(_class, 'OneToOneRelation', [_dec], (0, _getOwnPropertyDescriptor2.default)(_class, 'OneToOneRelation'), _class), _applyDecoratedDescriptor(_class, 'OneToManyRelation', [_dec2], (0, _getOwnPropertyDescriptor2.default)(_class, 'OneToManyRelation'), _class), _applyDecoratedDescriptor(_class, 'getIdColumnArray', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class, 'getIdColumnArray'), _class), _applyDecoratedDescriptor(_class, 'getFullIdColumn', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class, 'getFullIdColumn'), _class), _applyDecoratedDescriptor(_class, 'getIdPropertyArray', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class, 'getIdPropertyArray'), _class), _applyDecoratedDescriptor(_class, 'getIdProperty', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class, 'getIdProperty'), _class), _applyDecoratedDescriptor(_class, 'relations', [_dec3], (0, _getOwnPropertyDescriptor2.default)(_class, 'relations'), _class), _applyDecoratedDescriptor(_class, 'relations', [_dec4], (0, _getOwnPropertyDescriptor2.default)(_class, 'relations'), _class)), _class));
exports.default = Model;


function ensureArray(obj) {
  if (Array.isArray(obj)) {
    return obj;
  } else {
    return [obj];
  }
}

function _traverse(models, parent, relationName, modelClass, callback) {
  if (!_lodash2.default.isObject(models)) {
    return;
  }

  if (Array.isArray(models)) {
    for (var i = 0, l = models.length; i < l; ++i) {
      traverseOne(models[i], parent, relationName, modelClass, callback);
    }
  } else {
    traverseOne(models, parent, relationName, modelClass, callback);
  }
}

function traverseOne(model, parent, relationName, modelClass, callback) {
  if (!(model instanceof Model)) {
    return;
  }

  if (!modelClass || model instanceof modelClass) {
    callback(model, parent, relationName);
  }

  var relations = model.constructor.getRelations();
  var relNames = (0, _keys2.default)(relations);

  for (var i = 0, l = relNames.length; i < l; ++i) {
    var relName = relNames[i];

    if (model.hasOwnProperty(relName)) {
      _traverse(model[relName], model, relName, modelClass, callback);
    }
  }
}

function idColumnToIdProperty(ModelClass, idColumn) {
  var idProperty = ModelClass.columnNameToPropertyName(idColumn);

  if (!idProperty) {
    throw new Error(ModelClass.tableName + '.$parseDatabaseJson probably changes the value of the id column `' + idColumn + '` which is a no-no.');
  }

  return idProperty;
}

function setId(model, id) {
  var idProp = model.constructor.getIdProperty();
  var isArray = Array.isArray(idProp);

  if (Array.isArray(id)) {
    if (isArray) {
      if (id.length !== idProp.length) {
        throw new Error('trying to set an invalid identifier for a model');
      }

      for (var i = 0; i < id.length; ++i) {
        model[idProp[i]] = id[i];
      }
    } else {
      if (id.length !== 1) {
        throw new Error('trying to set an invalid identifier for a model');
      }

      model[idProp] = id[0];
    }
  } else {
    if (isArray) {
      if (idProp.length > 1) {
        throw new Error('trying to set an invalid identifier for a model');
      }

      model[idProp[0]] = id;
    } else {
      model[idProp] = id;
    }
  }
}

function getId(model) {
  var idProp = model.constructor.getIdProperty();

  if (Array.isArray(idProp)) {
    return model.$values(idProp);
  } else {
    return model[idProp];
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk1vZGVsLmpzIl0sIm5hbWVzIjpbIkpvaW5FYWdlckFsZ29yaXRobSIsIldoZXJlSW5FYWdlckFsZ29yaXRobSIsIk1vZGVsIiwicmVtb3ZlZEluIiwidXNlSW5zdGVhZCIsIiRpZCIsImlkIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwic2V0SWQiLCJnZXRJZCIsIiRrbmV4IiwiY29uc3RydWN0b3IiLCJrbmV4IiwiJHRyYW5zYWN0aW9uIiwidHJhbnNhY3Rpb24iLCIkcXVlcnkiLCJ0cngiLCJNb2RlbENsYXNzIiwiUXVlcnlCdWlsZGVyIiwiZm9yQ2xhc3MiLCJ0cmFuc2FjdGluZyIsImZpbmRPcGVyYXRpb25GYWN0b3J5IiwiaW5zdGFuY2UiLCJpbnNlcnRPcGVyYXRpb25GYWN0b3J5IiwidXBkYXRlT3BlcmF0aW9uRmFjdG9yeSIsInBhdGNoT3BlcmF0aW9uRmFjdG9yeSIsIm1vZGVsT3B0aW9ucyIsInBhdGNoIiwiZGVsZXRlT3BlcmF0aW9uRmFjdG9yeSIsInJlbGF0ZU9wZXJhdGlvbkZhY3RvcnkiLCJFcnJvciIsInVucmVsYXRlT3BlcmF0aW9uRmFjdG9yeSIsIiRyZWxhdGVkUXVlcnkiLCJyZWxhdGlvbk5hbWUiLCJyZWxhdGlvbiIsImdldFJlbGF0aW9uIiwiUmVsYXRlZE1vZGVsQ2xhc3MiLCJyZWxhdGVkTW9kZWxDbGFzcyIsIlJlbGF0ZWRRdWVyeUJ1aWxkZXIiLCJmaW5kIiwiYnVpbGRlciIsImluc2VydCIsInVwZGF0ZSIsImRlbGV0ZSIsInJlbGF0ZSIsInVucmVsYXRlIiwiJGxvYWRSZWxhdGVkIiwicmVsYXRpb25FeHByZXNzaW9uIiwiZmlsdGVycyIsImxvYWRSZWxhdGVkIiwiJHRyYXZlcnNlIiwiZmlsdGVyQ29uc3RydWN0b3IiLCJjYWxsYmFjayIsImlzVW5kZWZpbmVkIiwidHJhdmVyc2UiLCIkdmFsaWRhdGUiLCJqc29uIiwib3B0aW9ucyIsIiRwYXJzZUpzb24iLCIkdG9Kc29uIiwiJHBhcnNlRGF0YWJhc2VKc29uIiwianNvbkF0dHIiLCJnZXRKc29uQXR0cmlidXRlcyIsImkiLCJsIiwiYXR0ciIsInZhbHVlIiwiaXNTdHJpbmciLCJKU09OIiwicGFyc2UiLCIkZm9ybWF0RGF0YWJhc2VKc29uIiwiaXNPYmplY3QiLCIkc2V0SnNvbiIsInJlbGF0aW9ucyIsImdldFJlbGF0aW9ucyIsInJlbE5hbWVzIiwiaGFzIiwicmVsYXRpb25Kc29uIiwiQXJyYXkiLCJpc0FycmF5IiwiZW5zdXJlTW9kZWxBcnJheSIsImVuc3VyZU1vZGVsIiwic2hhbGxvdyIsIiQkdG9Kc29uIiwiJHRvRGF0YWJhc2VKc29uIiwianNvblNjaGVtYSIsImdldEpzb25TY2hlbWEiLCJwaWNrSnNvblNjaGVtYVByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiJGJlZm9yZUluc2VydCIsInF1ZXJ5Q29udGV4dCIsIiRhZnRlckluc2VydCIsIiRiZWZvcmVVcGRhdGUiLCJvcHQiLCIkYWZ0ZXJVcGRhdGUiLCIkYWZ0ZXJHZXQiLCIkYmVmb3JlRGVsZXRlIiwiJGFmdGVyRGVsZXRlIiwicXVlcnkiLCIkJGtuZXgiLCJyYXciLCJhcHBseSIsImZuIiwiZm9ybWF0dGVyIiwiY2xpZW50Iiwia25leFF1ZXJ5IiwidGFibGUiLCJ0YWJsZU5hbWUiLCJ1bmlxdWVUYWciLCJiaW5kS25leCIsIiQkb2JqZWN0aW9uIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJlbnVtZXJhYmxlIiwid3JpdGFibGUiLCJib3VuZE1vZGVscyIsIkJvdW5kTW9kZWxDbGFzcyIsImJvdW5kUmVsYXRpb25zIiwicmVsTmFtZSIsImJpbmRUcmFuc2FjdGlvbiIsIm1vZGVsIiwiZnJvbUpzb24iLCJpbnB1dCIsIm1vZGVscyIsImdldElkQ29sdW1uQXJyYXkiLCJpZENvbHVtbiIsImdldEZ1bGxJZENvbHVtbiIsIm1hcCIsImNvbCIsImdldElkUHJvcGVydHlBcnJheSIsImlkQ29sdW1uVG9JZFByb3BlcnR5IiwiZ2V0SWRQcm9wZXJ0eSIsInJlZHVjZSIsInJlbGF0aW9uTWFwcGluZ3MiLCJtYXBwaW5nIiwic2V0TWFwcGluZyIsIm5hbWUiLCIkbW9kZWxzIiwiZXhwcmVzc2lvbiIsInJlc29sdmUiLCJmaW5kT3B0aW9ucyIsImRvbnRDYWxsQWZ0ZXJHZXQiLCJlYWdlciIsInJ1bkFmdGVyIiwidHJhdmVyc2VyIiwiaXNGdW5jdGlvbiIsImpzb25BdHRyaWJ1dGVzIiwiZm9yT3duIiwicHJvcCIsInByb3BOYW1lIiwidHlwZXMiLCJjb21wYWN0IiwiZW5zdXJlQXJyYXkiLCJ0eXBlIiwiYW55T2YiLCJmbGF0dGVuRGVlcCIsIm9uZU9mIiwiaW5jbHVkZXMiLCJwdXNoIiwiSGFzT25lUmVsYXRpb24iLCJIYXNNYW55UmVsYXRpb24iLCJNYW55VG9NYW55UmVsYXRpb24iLCJCZWxvbmdzVG9PbmVSZWxhdGlvbiIsInVpZFByb3AiLCJ1aWRSZWZQcm9wIiwiZGJSZWZQcm9wIiwicHJvcFJlZlJlZ2V4IiwibW9kZWxQYXRocyIsImRlZmF1bHRFYWdlckFsZ29yaXRobSIsImRlZmF1bHRFYWdlck9wdGlvbnMiLCJvYmoiLCJwYXJlbnQiLCJtb2RlbENsYXNzIiwidHJhdmVyc2VPbmUiLCJoYXNPd25Qcm9wZXJ0eSIsImlkUHJvcGVydHkiLCJjb2x1bW5OYW1lVG9Qcm9wZXJ0eU5hbWUiLCJpZFByb3AiLCIkdmFsdWVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLHFCQUFxQixTQUFyQkEsa0JBQXFCLEdBQU07QUFDL0IsU0FBTyxpQ0FBdUIsT0FBdkIsQ0FBUDtBQUNELENBRkQ7O0FB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LGNBQU0sSUFBSXVCLEtBQUosQ0FBVSxpREFBVixDQUFOO0FBQ0Q7O0FBRUQwRixZQUFNeUQsTUFBTixJQUFnQjVLLEdBQUcsQ0FBSCxDQUFoQjtBQUNEO0FBQ0YsR0FoQkQsTUFnQk87QUFDTCxRQUFJMEUsT0FBSixFQUFhO0FBQ1gsVUFBSWtHLE9BQU8xSyxNQUFQLEdBQWdCLENBQXBCLEVBQXVCO0FBQ3JCLGNBQU0sSUFBSXVCLEtBQUosQ0FBVSxpREFBVixDQUFOO0FBQ0Q7O0FBRUQwRixZQUFNeUQsT0FBTyxDQUFQLENBQU4sSUFBbUI1SyxFQUFuQjtBQUNELEtBTkQsTUFNTztBQUNMbUgsWUFBTXlELE1BQU4sSUFBZ0I1SyxFQUFoQjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxTQUFTSSxLQUFULENBQWUrRyxLQUFmLEVBQXNCO0FBQ3BCLE1BQU15RCxTQUFTekQsTUFBTTdHLFdBQU4sQ0FBa0J3SCxhQUFsQixFQUFmOztBQUVBLE1BQUlyRCxNQUFNQyxPQUFOLENBQWNrRyxNQUFkLENBQUosRUFBMkI7QUFDekIsV0FBT3pELE1BQU0wRCxPQUFOLENBQWNELE1BQWQsQ0FBUDtBQUNELEdBRkQsTUFFTztBQUNMLFdBQU96RCxNQUFNeUQsTUFBTixDQUFQO0FBQ0Q7QUFDRiIsImZpbGUiOiJNb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgTW9kZWxCYXNlIGZyb20gJy4vTW9kZWxCYXNlJztcbmltcG9ydCBRdWVyeUJ1aWxkZXIgZnJvbSAnLi4vcXVlcnlCdWlsZGVyL1F1ZXJ5QnVpbGRlcic7XG5pbXBvcnQgaW5oZXJpdE1vZGVsIGZyb20gJy4vaW5oZXJpdE1vZGVsJztcbmltcG9ydCBSZWxhdGlvbkV4cHJlc3Npb24gZnJvbSAnLi4vcXVlcnlCdWlsZGVyL1JlbGF0aW9uRXhwcmVzc2lvbic7XG5pbXBvcnQge2luaGVyaXRIaWRkZW5EYXRhfSBmcm9tICcuLi91dGlscy9oaWRkZW5EYXRhJztcblxuaW1wb3J0IGhpZGRlbkRhdGEgZnJvbSAnLi4vdXRpbHMvZGVjb3JhdG9ycy9oaWRkZW5EYXRhJztcbmltcG9ydCBkZXByZWNhdGVkIGZyb20gJy4uL3V0aWxzL2RlY29yYXRvcnMvZGVwcmVjYXRlZCc7XG5pbXBvcnQgbWVtb2l6ZSBmcm9tICcuLi91dGlscy9kZWNvcmF0b3JzL21lbW9pemUnO1xuXG5pbXBvcnQgUmVsYXRpb24gZnJvbSAnLi4vcmVsYXRpb25zL1JlbGF0aW9uJztcbmltcG9ydCBIYXNPbmVSZWxhdGlvbiBmcm9tICcuLi9yZWxhdGlvbnMvaGFzT25lL0hhc09uZVJlbGF0aW9uJztcbmltcG9ydCBIYXNNYW55UmVsYXRpb24gZnJvbSAnLi4vcmVsYXRpb25zL2hhc01hbnkvSGFzTWFueVJlbGF0aW9uJztcbmltcG9ydCBNYW55VG9NYW55UmVsYXRpb24gZnJvbSAnLi4vcmVsYXRpb25zL21hbnlUb01hbnkvTWFueVRvTWFueVJlbGF0aW9uJztcbmltcG9ydCBCZWxvbmdzVG9PbmVSZWxhdGlvbiBmcm9tICcuLi9yZWxhdGlvbnMvYmVsb25nc1RvT25lL0JlbG9uZ3NUb09uZVJlbGF0aW9uJztcblxuaW1wb3J0IEluc3RhbmNlRmluZE9wZXJhdGlvbiBmcm9tICcuLi9xdWVyeUJ1aWxkZXIvb3BlcmF0aW9ucy9JbnN0YW5jZUZpbmRPcGVyYXRpb24nO1xuaW1wb3J0IEluc3RhbmNlSW5zZXJ0T3BlcmF0aW9uIGZyb20gJy4uL3F1ZXJ5QnVpbGRlci9vcGVyYXRpb25zL0luc3RhbmNlSW5zZXJ0T3BlcmF0aW9uJztcbmltcG9ydCBJbnN0YW5jZVVwZGF0ZU9wZXJhdGlvbiBmcm9tICcuLi9xdWVyeUJ1aWxkZXIvb3BlcmF0aW9ucy9JbnN0YW5jZVVwZGF0ZU9wZXJhdGlvbic7XG5pbXBvcnQgSW5zdGFuY2VEZWxldGVPcGVyYXRpb24gZnJvbSAnLi4vcXVlcnlCdWlsZGVyL29wZXJhdGlvbnMvSW5zdGFuY2VEZWxldGVPcGVyYXRpb24nO1xuXG5pbXBvcnQgSm9pbkVhZ2VyT3BlcmF0aW9uIGZyb20gJy4uL3F1ZXJ5QnVpbGRlci9vcGVyYXRpb25zL0pvaW5FYWdlck9wZXJhdGlvbic7XG5pbXBvcnQgV2hlcmVJbkVhZ2VyT3BlcmF0aW9uIGZyb20gJy4uL3F1ZXJ5QnVpbGRlci9vcGVyYXRpb25zL1doZXJlSW5FYWdlck9wZXJhdGlvbic7XG5cbmNvbnN0IEpvaW5FYWdlckFsZ29yaXRobSA9ICgpID0+IHtcbiAgcmV0dXJuIG5ldyBKb2luRWFnZXJPcGVyYXRpb24oJ2VhZ2VyJyk7XG59O1xuXG5jb25zdCBXaGVyZUluRWFnZXJBbGdvcml0aG0gPSAoKSA9PiB7XG4gIHJldHVybiBuZXcgV2hlcmVJbkVhZ2VyT3BlcmF0aW9uKCdlYWdlcicpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW9kZWwgZXh0ZW5kcyBNb2RlbEJhc2Uge1xuXG4gIHN0YXRpYyBRdWVyeUJ1aWxkZXIgPSBRdWVyeUJ1aWxkZXI7XG4gIHN0YXRpYyBSZWxhdGVkUXVlcnlCdWlsZGVyID0gUXVlcnlCdWlsZGVyO1xuXG4gIHN0YXRpYyBIYXNPbmVSZWxhdGlvbiA9IEhhc09uZVJlbGF0aW9uO1xuICBzdGF0aWMgSGFzTWFueVJlbGF0aW9uID0gSGFzTWFueVJlbGF0aW9uO1xuICBzdGF0aWMgTWFueVRvTWFueVJlbGF0aW9uID0gTWFueVRvTWFueVJlbGF0aW9uO1xuICBzdGF0aWMgQmVsb25nc1RvT25lUmVsYXRpb24gPSBCZWxvbmdzVG9PbmVSZWxhdGlvbjtcblxuICBzdGF0aWMgSm9pbkVhZ2VyQWxnb3JpdGhtID0gSm9pbkVhZ2VyQWxnb3JpdGhtO1xuICBzdGF0aWMgV2hlcmVJbkVhZ2VyQWxnb3JpdGhtID0gV2hlcmVJbkVhZ2VyQWxnb3JpdGhtO1xuXG4gIEBkZXByZWNhdGVkKHtyZW1vdmVkSW46ICcwLjcuMCcsIHVzZUluc3RlYWQ6ICdCZWxvbmdzVG9PbmVSZWxhdGlvbid9KVxuICBzdGF0aWMgZ2V0IE9uZVRvT25lUmVsYXRpb24oKSB7XG4gICAgcmV0dXJuIEJlbG9uZ3NUb09uZVJlbGF0aW9uO1xuICB9XG5cbiAgQGRlcHJlY2F0ZWQoe3JlbW92ZWRJbjogJzAuNy4wJywgdXNlSW5zdGVhZDogJ0hhc01hbnlSZWxhdGlvbid9KVxuICBzdGF0aWMgZ2V0IE9uZVRvTWFueVJlbGF0aW9uKCkge1xuICAgIHJldHVybiBIYXNNYW55UmVsYXRpb247XG4gIH1cblxuICAvKipcbiAgICogQHR5cGUge3N0cmluZ31cbiAgICovXG4gIHN0YXRpYyB0YWJsZU5hbWUgPSBudWxsO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7c3RyaW5nfEFycmF5LjxzdHJpbmc+fVxuICAgKi9cbiAgc3RhdGljIGlkQ29sdW1uID0gJ2lkJztcblxuICAvKipcbiAgICogQHR5cGUge3N0cmluZ31cbiAgICovXG4gIHN0YXRpYyB1aWRQcm9wID0gJyNpZCc7XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtzdHJpbmd9XG4gICAqL1xuICBzdGF0aWMgdWlkUmVmUHJvcCA9ICcjcmVmJztcblxuICAvKipcbiAgICogQHR5cGUge3N0cmluZ31cbiAgICovXG4gIHN0YXRpYyBkYlJlZlByb3AgPSAnI2RiUmVmJztcblxuICAvKipcbiAgICogQHR5cGUge1JlZ0V4cH1cbiAgICovXG4gIHN0YXRpYyBwcm9wUmVmUmVnZXggPSAvI3JlZnsoW15cXC5dKylcXC4oW159XSspfS9nO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7QXJyYXkuPHN0cmluZz59XG4gICAqL1xuICBzdGF0aWMganNvbkF0dHJpYnV0ZXMgPSBudWxsO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIFJlbGF0aW9uTWFwcGluZz59XG4gICAqL1xuICBzdGF0aWMgcmVsYXRpb25NYXBwaW5ncyA9IG51bGw7XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtBcnJheS48c3RyaW5nPn1cbiAgICovXG4gIHN0YXRpYyBtb2RlbFBhdGhzID0gW107XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtib29sZWFufVxuICAgKi9cbiAgc3RhdGljIHBpY2tKc29uU2NoZW1hUHJvcGVydGllcyA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtDb25zdHJ1Y3Rvci48PyBleHRlbmRzIEVhZ2VyT3BlcmF0aW9uPn1cbiAgICovXG4gIHN0YXRpYyBkZWZhdWx0RWFnZXJBbGdvcml0aG0gPSBXaGVyZUluRWFnZXJBbGdvcml0aG07XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtvYmplY3R9XG4gICAqL1xuICBzdGF0aWMgZGVmYXVsdEVhZ2VyT3B0aW9ucyA9IG51bGw7XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBzdGF0aWMgJCRrbmV4ID0gbnVsbDtcblxuICAvKipcbiAgICogQHBhcmFtIHsqPX0gaWRcbiAgICogQHJldHVybnMgeyp9XG4gICAqL1xuICAkaWQoaWQpIHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBzZXRJZCh0aGlzLCBhcmd1bWVudHNbMF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZ2V0SWQodGhpcyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtrbmV4fVxuICAgKi9cbiAgJGtuZXgoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iua25leCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtrbmV4fVxuICAgKi9cbiAgJHRyYW5zYWN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRyYW5zYWN0aW9uKCk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtUcmFuc2FjdGlvbj19IHRyeFxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyfVxuICAgKi9cbiAgJHF1ZXJ5KHRyeCkge1xuICAgIGNvbnN0IE1vZGVsQ2xhc3MgPSB0aGlzLmNvbnN0cnVjdG9yO1xuXG4gICAgcmV0dXJuIE1vZGVsQ2xhc3MuUXVlcnlCdWlsZGVyXG4gICAgICAuZm9yQ2xhc3MoTW9kZWxDbGFzcylcbiAgICAgIC50cmFuc2FjdGluZyh0cngpXG4gICAgICAuZmluZE9wZXJhdGlvbkZhY3RvcnkoKCkgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IEluc3RhbmNlRmluZE9wZXJhdGlvbignZmluZCcsIHtpbnN0YW5jZTogdGhpc30pO1xuICAgICAgfSlcbiAgICAgIC5pbnNlcnRPcGVyYXRpb25GYWN0b3J5KCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBJbnN0YW5jZUluc2VydE9wZXJhdGlvbignaW5zZXJ0Jywge2luc3RhbmNlOiB0aGlzfSk7XG4gICAgICB9KVxuICAgICAgLnVwZGF0ZU9wZXJhdGlvbkZhY3RvcnkoKCkgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IEluc3RhbmNlVXBkYXRlT3BlcmF0aW9uKCd1cGRhdGUnLCB7aW5zdGFuY2U6IHRoaXN9KTtcbiAgICAgIH0pXG4gICAgICAucGF0Y2hPcGVyYXRpb25GYWN0b3J5KCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBJbnN0YW5jZVVwZGF0ZU9wZXJhdGlvbigncGF0Y2gnLCB7aW5zdGFuY2U6IHRoaXMsIG1vZGVsT3B0aW9uczoge3BhdGNoOiB0cnVlfX0pO1xuICAgICAgfSlcbiAgICAgIC5kZWxldGVPcGVyYXRpb25GYWN0b3J5KCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBJbnN0YW5jZURlbGV0ZU9wZXJhdGlvbignZGVsZXRlJywge2luc3RhbmNlOiB0aGlzfSk7XG4gICAgICB9KVxuICAgICAgLnJlbGF0ZU9wZXJhdGlvbkZhY3RvcnkoKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ByZWxhdGVgIG1ha2VzIG5vIHNlbnNlIGluIHRoaXMgY29udGV4dCcpO1xuICAgICAgfSlcbiAgICAgIC51bnJlbGF0ZU9wZXJhdGlvbkZhY3RvcnkoKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2B1bnJlbGF0ZWAgbWFrZXMgbm8gc2Vuc2UgaW4gdGhpcyBjb250ZXh0Jyk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcmVsYXRpb25OYW1lXG4gICAqIEBwYXJhbSB7VHJhbnNhY3Rpb249fSB0cnhcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlcn1cbiAgICovXG4gICRyZWxhdGVkUXVlcnkocmVsYXRpb25OYW1lLCB0cngpIHtcbiAgICBjb25zdCBNb2RlbENsYXNzID0gdGhpcy5jb25zdHJ1Y3RvcjtcbiAgICBjb25zdCByZWxhdGlvbiA9IE1vZGVsQ2xhc3MuZ2V0UmVsYXRpb24ocmVsYXRpb25OYW1lKTtcbiAgICBjb25zdCBSZWxhdGVkTW9kZWxDbGFzcyA9IHJlbGF0aW9uLnJlbGF0ZWRNb2RlbENsYXNzO1xuXG4gICAgcmV0dXJuIE1vZGVsQ2xhc3MuUmVsYXRlZFF1ZXJ5QnVpbGRlclxuICAgICAgLmZvckNsYXNzKFJlbGF0ZWRNb2RlbENsYXNzKVxuICAgICAgLnRyYW5zYWN0aW5nKHRyeClcbiAgICAgIC5maW5kT3BlcmF0aW9uRmFjdG9yeShidWlsZGVyID0+IHtcbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uLmZpbmQoYnVpbGRlciwgW3RoaXNdKTtcbiAgICAgIH0pXG4gICAgICAuaW5zZXJ0T3BlcmF0aW9uRmFjdG9yeShidWlsZGVyID0+IHtcbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uLmluc2VydChidWlsZGVyLCB0aGlzKTtcbiAgICAgIH0pXG4gICAgICAudXBkYXRlT3BlcmF0aW9uRmFjdG9yeShidWlsZGVyID0+IHtcbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uLnVwZGF0ZShidWlsZGVyLCB0aGlzKTtcbiAgICAgIH0pXG4gICAgICAucGF0Y2hPcGVyYXRpb25GYWN0b3J5KGJ1aWxkZXIgPT4ge1xuICAgICAgICByZXR1cm4gcmVsYXRpb24ucGF0Y2goYnVpbGRlciwgdGhpcyk7XG4gICAgICB9KVxuICAgICAgLmRlbGV0ZU9wZXJhdGlvbkZhY3RvcnkoYnVpbGRlciA9PiB7XG4gICAgICAgIHJldHVybiByZWxhdGlvbi5kZWxldGUoYnVpbGRlciwgdGhpcyk7XG4gICAgICB9KVxuICAgICAgLnJlbGF0ZU9wZXJhdGlvbkZhY3RvcnkoYnVpbGRlciA9PiB7XG4gICAgICAgIHJldHVybiByZWxhdGlvbi5yZWxhdGUoYnVpbGRlciwgdGhpcyk7XG4gICAgICB9KVxuICAgICAgLnVucmVsYXRlT3BlcmF0aW9uRmFjdG9yeShidWlsZGVyID0+IHtcbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uLnVucmVsYXRlKGJ1aWxkZXIsIHRoaXMpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd8UmVsYXRpb25FeHByZXNzaW9ufSByZWxhdGlvbkV4cHJlc3Npb25cbiAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oUXVlcnlCdWlsZGVyKT49fSBmaWx0ZXJzXG4gICAqIEByZXR1cm5zIHtRdWVyeUJ1aWxkZXJ9XG4gICAqL1xuICAkbG9hZFJlbGF0ZWQocmVsYXRpb25FeHByZXNzaW9uLCBmaWx0ZXJzKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IubG9hZFJlbGF0ZWQodGhpcywgcmVsYXRpb25FeHByZXNzaW9uLCBmaWx0ZXJzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge0NvbnN0cnVjdG9yLjxNb2RlbD49fSBmaWx0ZXJDb25zdHJ1Y3RvclxuICAgKiBAcGFyYW0ge2Z1bmN0aW9uKE1vZGVsKX0gY2FsbGJhY2tcbiAgICogQHJldHVybiB7TW9kZWx9XG4gICAqL1xuICAkdHJhdmVyc2UoZmlsdGVyQ29uc3RydWN0b3IsIGNhbGxiYWNrKSB7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoY2FsbGJhY2spKSB7XG4gICAgICBjYWxsYmFjayA9IGZpbHRlckNvbnN0cnVjdG9yO1xuICAgICAgZmlsdGVyQ29uc3RydWN0b3IgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuY29uc3RydWN0b3IudHJhdmVyc2UoZmlsdGVyQ29uc3RydWN0b3IsIHRoaXMsIGNhbGxiYWNrKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gICR2YWxpZGF0ZShqc29uID0gdGhpcywgb3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKGpzb24gaW5zdGFuY2VvZiBNb2RlbCkge1xuICAgICAgLy8gU3RyaXAgYXdheSByZWxhdGlvbnMgYW5kIG90aGVyIGludGVybmFsIHN0dWZmLlxuICAgICAganNvbiA9IGpzb24uJHBhcnNlSnNvbihqc29uLiR0b0pzb24odHJ1ZSkpO1xuICAgIH1cblxuICAgIHJldHVybiBzdXBlci4kdmFsaWRhdGUoanNvbiwgb3B0aW9ucyk7XG4gIH1cblxuICAkcGFyc2VEYXRhYmFzZUpzb24oanNvbikge1xuICAgIGNvbnN0IGpzb25BdHRyID0gdGhpcy5jb25zdHJ1Y3Rvci5nZXRKc29uQXR0cmlidXRlcygpO1xuXG4gICAgaWYgKGpzb25BdHRyLmxlbmd0aCkge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBqc29uQXR0ci5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgICAgY29uc3QgYXR0ciA9IGpzb25BdHRyW2ldO1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGpzb25bYXR0cl07XG5cbiAgICAgICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7XG4gICAgICAgICAganNvblthdHRyXSA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGpzb247XG4gIH1cblxuICAkZm9ybWF0RGF0YWJhc2VKc29uKGpzb24pIHtcbiAgICBjb25zdCBqc29uQXR0ciA9IHRoaXMuY29uc3RydWN0b3IuZ2V0SnNvbkF0dHJpYnV0ZXMoKTtcblxuICAgIGlmIChqc29uQXR0ci5sZW5ndGgpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0ganNvbkF0dHIubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICAgIGNvbnN0IGF0dHIgPSBqc29uQXR0cltpXTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBqc29uW2F0dHJdO1xuXG4gICAgICAgIGlmIChfLmlzT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICAgIGpzb25bYXR0cl0gPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ganNvbjtcbiAgfVxuXG4gICRzZXRKc29uKGpzb24sIG9wdGlvbnMpIHtcbiAgICBzdXBlci4kc2V0SnNvbihqc29uLCBvcHRpb25zKTtcblxuICAgIGlmICghXy5pc09iamVjdChqc29uKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHJlbGF0aW9ucyA9IHRoaXMuY29uc3RydWN0b3IuZ2V0UmVsYXRpb25zKCk7XG4gICAgY29uc3QgcmVsTmFtZXMgPSBPYmplY3Qua2V5cyhyZWxhdGlvbnMpO1xuXG4gICAgLy8gUGFyc2UgcmVsYXRpb25zIGludG8gTW9kZWwgaW5zdGFuY2VzLlxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVsTmFtZXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICBjb25zdCByZWxhdGlvbk5hbWUgPSByZWxOYW1lc1tpXTtcblxuICAgICAgaWYgKF8uaGFzKGpzb24sIHJlbGF0aW9uTmFtZSkpIHtcbiAgICAgICAgY29uc3QgcmVsYXRpb25Kc29uID0ganNvbltyZWxhdGlvbk5hbWVdO1xuICAgICAgICBjb25zdCByZWxhdGlvbiA9IHJlbGF0aW9uc1tyZWxhdGlvbk5hbWVdO1xuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlbGF0aW9uSnNvbikpIHtcbiAgICAgICAgICB0aGlzW3JlbGF0aW9uTmFtZV0gPSByZWxhdGlvbi5yZWxhdGVkTW9kZWxDbGFzcy5lbnN1cmVNb2RlbEFycmF5KHJlbGF0aW9uSnNvbiwgb3B0aW9ucyk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVsYXRpb25Kc29uKSB7XG4gICAgICAgICAgdGhpc1tyZWxhdGlvbk5hbWVdID0gcmVsYXRpb24ucmVsYXRlZE1vZGVsQ2xhc3MuZW5zdXJlTW9kZWwocmVsYXRpb25Kc29uLCBvcHRpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzW3JlbGF0aW9uTmFtZV0gPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNoYWxsb3dcbiAgICovXG4gICR0b0pzb24oc2hhbGxvdykge1xuICAgIGlmIChzaGFsbG93KSB7XG4gICAgICByZXR1cm4gdGhpcy4kJHRvSnNvbihmYWxzZSwgdGhpcy5jb25zdHJ1Y3Rvci5nZXRSZWxhdGlvbnMoKSwgbnVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLiQkdG9Kc29uKGZhbHNlLCBudWxsLCBudWxsKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICAkdG9EYXRhYmFzZUpzb24oKSB7XG4gICAgY29uc3QganNvblNjaGVtYSA9IHRoaXMuY29uc3RydWN0b3IuZ2V0SnNvblNjaGVtYSgpO1xuXG4gICAgaWYgKGpzb25TY2hlbWEgJiYgdGhpcy5jb25zdHJ1Y3Rvci5waWNrSnNvblNjaGVtYVByb3BlcnRpZXMpIHtcbiAgICAgIHJldHVybiB0aGlzLiQkdG9Kc29uKHRydWUsIG51bGwsIGpzb25TY2hlbWEucHJvcGVydGllcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLiQkdG9Kc29uKHRydWUsIHRoaXMuY29uc3RydWN0b3IuZ2V0UmVsYXRpb25zKCksIG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcXVlcnlDb250ZXh0XG4gICAqIEByZXR1cm5zIHtQcm9taXNlfCp9XG4gICAqL1xuICAkYmVmb3JlSW5zZXJ0KHF1ZXJ5Q29udGV4dCkge31cblxuICAvKipcbiAgICogQHBhcmFtIHtPYmplY3R9IHF1ZXJ5Q29udGV4dFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZXwqfVxuICAgKi9cbiAgJGFmdGVySW5zZXJ0KHF1ZXJ5Q29udGV4dCkge31cblxuICAvKipcbiAgICogQHBhcmFtIHtNb2RlbE9wdGlvbnN9IG9wdFxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlckNvbnRleHR9IHF1ZXJ5Q29udGV4dFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZXwqfVxuICAgKi9cbiAgJGJlZm9yZVVwZGF0ZShvcHQsIHF1ZXJ5Q29udGV4dCkge31cblxuICAvKipcbiAgICogQHBhcmFtIHtNb2RlbE9wdGlvbnN9IG9wdFxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlckNvbnRleHR9IHF1ZXJ5Q29udGV4dFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZXwqfVxuICAgKi9cbiAgJGFmdGVyVXBkYXRlKG9wdCwgcXVlcnlDb250ZXh0KSB7fVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlckNvbnRleHR9IHF1ZXJ5Q29udGV4dFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZXwqfVxuICAgKi9cbiAgJGFmdGVyR2V0KHF1ZXJ5Q29udGV4dCkge31cblxuICAvKipcbiAgICogQHBhcmFtIHtRdWVyeUJ1aWxkZXJDb250ZXh0fSBxdWVyeUNvbnRleHRcbiAgICogQHJldHVybnMge1Byb21pc2V8Kn1cbiAgICovXG4gICRiZWZvcmVEZWxldGUocXVlcnlDb250ZXh0KSB7fVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlckNvbnRleHR9IHF1ZXJ5Q29udGV4dFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZXwqfVxuICAgKi9cbiAgJGFmdGVyRGVsZXRlKHF1ZXJ5Q29udGV4dCkge31cblxuICAvKipcbiAgICogQHBhcmFtIHtUcmFuc2FjdGlvbj19IHRyeFxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyfVxuICAgKi9cbiAgc3RhdGljIHF1ZXJ5KHRyeCkge1xuICAgIGNvbnN0IE1vZGVsQ2xhc3MgPSB0aGlzO1xuXG4gICAgcmV0dXJuIE1vZGVsQ2xhc3MuUXVlcnlCdWlsZGVyXG4gICAgICAuZm9yQ2xhc3MoTW9kZWxDbGFzcylcbiAgICAgIC50cmFuc2FjdGluZyh0cngpXG4gICAgICAucmVsYXRlT3BlcmF0aW9uRmFjdG9yeSgoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignYHJlbGF0ZWAgbWFrZXMgbm8gc2Vuc2UgaW4gdGhpcyBjb250ZXh0Jyk7XG4gICAgICB9KVxuICAgICAgLnVucmVsYXRlT3BlcmF0aW9uRmFjdG9yeSgoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignYHVucmVsYXRlYCBtYWtlcyBubyBzZW5zZSBpbiB0aGlzIGNvbnRleHQnKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7a25leD19IGtuZXhcbiAgICogQHJldHVybnMge2tuZXh9XG4gICAqL1xuICBzdGF0aWMga25leChrbmV4KSB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuJCRrbmV4ID0ga25leDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuJCRrbmV4O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7a25leH1cbiAgICovXG4gIHN0YXRpYyB0cmFuc2FjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5rbmV4KCk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybiB7UmF3fVxuICAgKi9cbiAgc3RhdGljIHJhdygpIHtcbiAgICBjb25zdCBrbmV4ID0gdGhpcy5rbmV4KCk7XG4gICAgcmV0dXJuIGtuZXgucmF3LmFwcGx5KGtuZXgsIGFyZ3VtZW50cyk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybiB7T2JqZWN0fVxuICAgKi9cbiAgc3RhdGljIGZuKCkge1xuICAgIGNvbnN0IGtuZXggPSB0aGlzLmtuZXgoKTtcbiAgICByZXR1cm4ga25leC5mbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtGb3JtYXR0ZXJ9XG4gICAqL1xuICBzdGF0aWMgZm9ybWF0dGVyKCkge1xuICAgIHJldHVybiB0aGlzLmtuZXgoKS5jbGllbnQuZm9ybWF0dGVyKCk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge2tuZXguUXVlcnlCdWlsZGVyfVxuICAgKi9cbiAgc3RhdGljIGtuZXhRdWVyeSgpIHtcbiAgICByZXR1cm4gdGhpcy5rbmV4KCkudGFibGUodGhpcy50YWJsZU5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAqL1xuICBzdGF0aWMgdW5pcXVlVGFnKCkge1xuICAgIHJldHVybiB0aGlzLnRhYmxlTmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge2tuZXh9IGtuZXhcbiAgICogQHJldHVybnMge0NvbnN0cnVjdG9yLjxNb2RlbD59XG4gICAqL1xuICBzdGF0aWMgYmluZEtuZXgoa25leCkge1xuICAgIGNvbnN0IE1vZGVsQ2xhc3MgPSB0aGlzO1xuXG4gICAgaWYgKCFrbmV4LiQkb2JqZWN0aW9uKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoa25leCwgJyQkb2JqZWN0aW9uJywge1xuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgd3JpdGFibGU6IGZhbHNlLFxuICAgICAgICB2YWx1ZToge1xuICAgICAgICAgIGJvdW5kTW9kZWxzOiBPYmplY3QuY3JlYXRlKG51bGwpXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoaXMgbW9kZWwgY2xhc3MgaGFzIGFscmVhZHkgYmVlbiBib3VuZCB0byB0aGUgZ2l2ZW4ga25leC5cbiAgICBpZiAoa25leC4kJG9iamVjdGlvbi5ib3VuZE1vZGVsc1tNb2RlbENsYXNzLnVuaXF1ZVRhZygpXSkge1xuICAgICAgcmV0dXJuIGtuZXguJCRvYmplY3Rpb24uYm91bmRNb2RlbHNbTW9kZWxDbGFzcy51bmlxdWVUYWcoKV07XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGEgbmV3IHN1YmNsYXNzIG9mIHRoaXMgY2xhc3MuXG4gICAgY29uc3QgQm91bmRNb2RlbENsYXNzID0gaW5oZXJpdE1vZGVsKE1vZGVsQ2xhc3MpO1xuXG4gICAgLy8gVGhlIGJvdW5kIG1vZGVsIGlzIGVxdWFsIHRvIHRoZSBzb3VyY2UgbW9kZWwgaW4gZXZlcnkgd2F5LiBXZSB3YW50IHRvIGNvcHlcbiAgICAvLyB0aGUgaGlkZGVuIGRhdGEgYXMtaXMgZnJvbSB0aGUgc291cmNlIHNvIHRoYXQgd2UgZG9uJ3QgZ2V0IHRoZSBwZXJmb3JtYW5jZVxuICAgIC8vIHBlbmFsdHkgb2YgY2FsY3VsYXRpbmcgYWxsIG1lbW9pemVkIGV0Yy4gdmFsdWVzIGFnYWluLlxuICAgIGluaGVyaXRIaWRkZW5EYXRhKE1vZGVsQ2xhc3MsIEJvdW5kTW9kZWxDbGFzcyk7XG5cbiAgICBCb3VuZE1vZGVsQ2xhc3Mua25leChrbmV4KTtcbiAgICBrbmV4LiQkb2JqZWN0aW9uLmJvdW5kTW9kZWxzW01vZGVsQ2xhc3MudW5pcXVlVGFnKCldID0gQm91bmRNb2RlbENsYXNzO1xuXG4gICAgY29uc3QgYm91bmRSZWxhdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIGNvbnN0IHJlbGF0aW9ucyA9IE1vZGVsQ2xhc3MuZ2V0UmVsYXRpb25zKCk7XG4gICAgY29uc3QgcmVsTmFtZXMgPSBPYmplY3Qua2V5cyhyZWxhdGlvbnMpO1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSByZWxOYW1lcy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGNvbnN0IHJlbE5hbWUgPSByZWxOYW1lc1tpXTtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gcmVsYXRpb25zW3JlbE5hbWVdO1xuICAgICAgYm91bmRSZWxhdGlvbnNbcmVsTmFtZV0gPSByZWxhdGlvbi5iaW5kS25leChrbmV4KTtcbiAgICB9XG5cbiAgICBCb3VuZE1vZGVsQ2xhc3MucmVsYXRpb25zID0gYm91bmRSZWxhdGlvbnM7XG4gICAgcmV0dXJuIEJvdW5kTW9kZWxDbGFzcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge2tuZXh9IHRyeFxuICAgKiBAcmV0dXJucyB7Q29uc3RydWN0b3IuPE1vZGVsPn1cbiAgICovXG4gIHN0YXRpYyBiaW5kVHJhbnNhY3Rpb24odHJ4KSB7XG4gICAgcmV0dXJuIHRoaXMuYmluZEtuZXgodHJ4KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge01vZGVsfE9iamVjdH0gbW9kZWxcbiAgICogQHBhcmFtIHtNb2RlbE9wdGlvbnM9fSBvcHRpb25zXG4gICAqIEByZXR1cm5zIHtNb2RlbH1cbiAgICovXG4gIHN0YXRpYyBlbnN1cmVNb2RlbChtb2RlbCwgb3B0aW9ucykge1xuICAgIGNvbnN0IE1vZGVsQ2xhc3MgPSB0aGlzO1xuXG4gICAgaWYgKCFtb2RlbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsIGluc3RhbmNlb2YgTW9kZWxDbGFzcykge1xuICAgICAgcmV0dXJuIG1vZGVsO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gTW9kZWxDbGFzcy5mcm9tSnNvbihtb2RlbCwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7QXJyYXkuPE1vZGVsfE9iamVjdD59IGlucHV0XG4gICAqIEBwYXJhbSB7TW9kZWxPcHRpb25zPX0gb3B0aW9uc1xuICAgKiBAcmV0dXJucyB7QXJyYXkuPE1vZGVsPn1cbiAgICovXG4gIHN0YXRpYyBlbnN1cmVNb2RlbEFycmF5KGlucHV0LCBvcHRpb25zKSB7XG4gICAgaWYgKCFpbnB1dCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KGlucHV0KSkge1xuICAgICAgbGV0IG1vZGVscyA9IG5ldyBBcnJheShpbnB1dC5sZW5ndGgpO1xuXG4gICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGlucHV0Lmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICBtb2RlbHNbaV0gPSB0aGlzLmVuc3VyZU1vZGVsKGlucHV0W2ldLCBvcHRpb25zKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG1vZGVscztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFt0aGlzLmVuc3VyZU1vZGVsKGlucHV0LCBvcHRpb25zKV07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn1cbiAgICovXG4gIEBtZW1vaXplXG4gIHN0YXRpYyBnZXRJZENvbHVtbkFycmF5KCkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuaWRDb2x1bW4pKSB7XG4gICAgICByZXR1cm4gdGhpcy5pZENvbHVtbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFt0aGlzLmlkQ29sdW1uXTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge3N0cmluZ3xBcnJheS48c3RyaW5nPn1cbiAgICovXG4gIEBtZW1vaXplXG4gIHN0YXRpYyBnZXRGdWxsSWRDb2x1bW4oKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5pZENvbHVtbikpIHtcbiAgICAgIHJldHVybiB0aGlzLmlkQ29sdW1uLm1hcChjb2wgPT4gdGhpcy50YWJsZU5hbWUgKyAnLicgKyBjb2wpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy50YWJsZU5hbWUgKyAnLicgKyB0aGlzLmlkQ29sdW1uO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59XG4gICAqL1xuICBAbWVtb2l6ZVxuICBzdGF0aWMgZ2V0SWRQcm9wZXJ0eUFycmF5KCkge1xuICAgIHJldHVybiB0aGlzLmdldElkQ29sdW1uQXJyYXkoKS5tYXAoY29sID0+IGlkQ29sdW1uVG9JZFByb3BlcnR5KHRoaXMsIGNvbCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtzdHJpbmd8QXJyYXkuPHN0cmluZz59XG4gICAqL1xuICBAbWVtb2l6ZVxuICBzdGF0aWMgZ2V0SWRQcm9wZXJ0eSgpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmlkQ29sdW1uKSkge1xuICAgICAgcmV0dXJuIHRoaXMuaWRDb2x1bW4ubWFwKGNvbCA9PiBpZENvbHVtblRvSWRQcm9wZXJ0eSh0aGlzLCBjb2wpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGlkQ29sdW1uVG9JZFByb3BlcnR5KHRoaXMsIHRoaXMuaWRDb2x1bW4pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgQGhpZGRlbkRhdGEoKVxuICBzdGF0aWMgZ2V0IHJlbGF0aW9ucygpIHt9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBAaGlkZGVuRGF0YSgpXG4gIHN0YXRpYyBzZXQgcmVsYXRpb25zKHZhbHVlKSB7fVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtPYmplY3QuPHN0cmluZywgUmVsYXRpb24+fVxuICAgKi9cbiAgc3RhdGljIGdldFJlbGF0aW9ucygpIHtcbiAgICBsZXQgcmVsYXRpb25zID0gdGhpcy5yZWxhdGlvbnM7XG5cbiAgICBpZiAoIXJlbGF0aW9ucykge1xuICAgICAgcmVsYXRpb25zID0gXy5yZWR1Y2UodGhpcy5yZWxhdGlvbk1hcHBpbmdzLCAocmVsYXRpb25zLCBtYXBwaW5nLCByZWxhdGlvbk5hbWUpID0+IHtcbiAgICAgICAgcmVsYXRpb25zW3JlbGF0aW9uTmFtZV0gPSBuZXcgbWFwcGluZy5yZWxhdGlvbihyZWxhdGlvbk5hbWUsIHRoaXMpO1xuICAgICAgICByZWxhdGlvbnNbcmVsYXRpb25OYW1lXS5zZXRNYXBwaW5nKG1hcHBpbmcpO1xuICAgICAgICByZXR1cm4gcmVsYXRpb25zO1xuICAgICAgfSwgT2JqZWN0LmNyZWF0ZShudWxsKSk7XG5cbiAgICAgIHRoaXMucmVsYXRpb25zID0gcmVsYXRpb25zO1xuICAgIH1cblxuICAgIHJldHVybiByZWxhdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybiB7UmVsYXRpb259XG4gICAqL1xuICBzdGF0aWMgZ2V0UmVsYXRpb24obmFtZSkge1xuICAgIGNvbnN0IHJlbGF0aW9uID0gdGhpcy5nZXRSZWxhdGlvbnMoKVtuYW1lXTtcblxuICAgIGlmICghcmVsYXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSBtb2RlbCBjbGFzcyAodGFibGVOYW1lID0gJHt0aGlzLnRhYmxlTmFtZX0pIGRvZXNuJ3QgaGF2ZSByZWxhdGlvbiAke25hbWV9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlbGF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7QXJyYXkuPE1vZGVsfE9iamVjdD59ICRtb2RlbHNcbiAgICogQHBhcmFtIHtzdHJpbmd8UmVsYXRpb25FeHByZXNzaW9ufSBleHByZXNzaW9uXG4gICAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIGZ1bmN0aW9uKFF1ZXJ5QnVpbGRlcik+PX0gZmlsdGVyc1xuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyfVxuICAgKi9cbiAgc3RhdGljIGxvYWRSZWxhdGVkKCRtb2RlbHMsIGV4cHJlc3Npb24sIGZpbHRlcnMpIHtcbiAgICByZXR1cm4gdGhpc1xuICAgICAgLnF1ZXJ5KClcbiAgICAgIC5yZXNvbHZlKHRoaXMuZW5zdXJlTW9kZWxBcnJheSgkbW9kZWxzKSlcbiAgICAgIC5maW5kT3B0aW9ucyh7ZG9udENhbGxBZnRlckdldDogdHJ1ZX0pXG4gICAgICAuZWFnZXIoZXhwcmVzc2lvbiwgZmlsdGVycylcbiAgICAgIC5ydW5BZnRlcihmdW5jdGlvbiAobW9kZWxzKSB7XG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KCRtb2RlbHMpID8gbW9kZWxzIDogbW9kZWxzWzBdO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtDb25zdHJ1Y3Rvci48TW9kZWw+PX0gZmlsdGVyQ29uc3RydWN0b3JcbiAgICogQHBhcmFtIHtNb2RlbHxBcnJheS48TW9kZWw+fSBtb2RlbHNcbiAgICogQHBhcmFtIHtmdW5jdGlvbihNb2RlbCwgTW9kZWwsIHN0cmluZyl9IHRyYXZlcnNlclxuICAgKiBAcmV0dXJuIHtNb2RlbH1cbiAgICovXG4gIHN0YXRpYyB0cmF2ZXJzZShmaWx0ZXJDb25zdHJ1Y3RvciwgbW9kZWxzLCB0cmF2ZXJzZXIpIHtcbiAgICBmaWx0ZXJDb25zdHJ1Y3RvciA9IGZpbHRlckNvbnN0cnVjdG9yIHx8IG51bGw7XG5cbiAgICBpZiAoXy5pc1VuZGVmaW5lZCh0cmF2ZXJzZXIpKSB7XG4gICAgICB0cmF2ZXJzZXIgPSBtb2RlbHM7XG4gICAgICBtb2RlbHMgPSBmaWx0ZXJDb25zdHJ1Y3RvcjtcbiAgICAgIGZpbHRlckNvbnN0cnVjdG9yID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNGdW5jdGlvbih0cmF2ZXJzZXIpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RyYXZlcnNlciBtdXN0IGJlIGEgZnVuY3Rpb24nKTtcbiAgICB9XG5cbiAgICB0cmF2ZXJzZShtb2RlbHMsIG51bGwsIG51bGwsIGZpbHRlckNvbnN0cnVjdG9yLCB0cmF2ZXJzZXIpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcm90ZWN0ZWRcbiAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fVxuICAgKi9cbiAgc3RhdGljIGdldEpzb25BdHRyaWJ1dGVzKCkge1xuICAgIC8vIElmIHRoZSBqc29uQXR0cmlidXRlcyBwcm9wZXJ0eSBpcyBub3Qgc2V0LCB0cnkgdG8gY3JlYXRlIGl0IGJhc2VkXG4gICAgLy8gb24gdGhlIGpzb25TY2hlbWEuIEFsbCBwcm9wZXJ0aWVzIHRoYXQgYXJlIG9iamVjdHMgb3IgYXJyYXlzIG11c3RcbiAgICAvLyBiZSBjb252ZXJ0ZWQgdG8gSlNPTi5cbiAgICBpZiAoIXRoaXMuanNvbkF0dHJpYnV0ZXMgJiYgdGhpcy5nZXRKc29uU2NoZW1hKCkpIHtcbiAgICAgIHRoaXMuanNvbkF0dHJpYnV0ZXMgPSBbXTtcblxuICAgICAgXy5mb3JPd24odGhpcy5nZXRKc29uU2NoZW1hKCkucHJvcGVydGllcywgKHByb3AsIHByb3BOYW1lKSA9PiB7XG4gICAgICAgIHZhciB0eXBlcyA9IF8uY29tcGFjdChlbnN1cmVBcnJheShwcm9wLnR5cGUpKTtcblxuICAgICAgICBpZiAodHlwZXMubGVuZ3RoID09PSAwICYmIEFycmF5LmlzQXJyYXkocHJvcC5hbnlPZikpIHtcbiAgICAgICAgICB0eXBlcyA9IF8uZmxhdHRlbkRlZXAoXy5tYXAocHJvcC5hbnlPZiwgJ3R5cGUnKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZXMubGVuZ3RoID09PSAwICYmIEFycmF5LmlzQXJyYXkocHJvcC5vbmVPZikpIHtcbiAgICAgICAgICB0eXBlcyA9IF8uZmxhdHRlbkRlZXAoXy5tYXAocHJvcC5vbmVPZiwgJ3R5cGUnKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXy5pbmNsdWRlcyh0eXBlcywgJ29iamVjdCcpIHx8IF8uaW5jbHVkZXModHlwZXMsICdhcnJheScpKSB7XG4gICAgICAgICAgdGhpcy5qc29uQXR0cmlidXRlcy5wdXNoKHByb3BOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMuanNvbkF0dHJpYnV0ZXMpKSB7XG4gICAgICB0aGlzLmpzb25BdHRyaWJ1dGVzID0gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuanNvbkF0dHJpYnV0ZXM7XG4gIH1cbn1cblxuZnVuY3Rpb24gZW5zdXJlQXJyYXkob2JqKSB7XG4gIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHtcbiAgICByZXR1cm4gb2JqO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBbb2JqXTtcbiAgfVxufVxuXG5mdW5jdGlvbiB0cmF2ZXJzZShtb2RlbHMsIHBhcmVudCwgcmVsYXRpb25OYW1lLCBtb2RlbENsYXNzLCBjYWxsYmFjaykge1xuICBpZiAoIV8uaXNPYmplY3QobW9kZWxzKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KG1vZGVscykpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIHRyYXZlcnNlT25lKG1vZGVsc1tpXSwgcGFyZW50LCByZWxhdGlvbk5hbWUsIG1vZGVsQ2xhc3MsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdHJhdmVyc2VPbmUobW9kZWxzLCBwYXJlbnQsIHJlbGF0aW9uTmFtZSwgbW9kZWxDbGFzcywgY2FsbGJhY2spXG4gIH1cbn1cblxuZnVuY3Rpb24gdHJhdmVyc2VPbmUobW9kZWwsIHBhcmVudCwgcmVsYXRpb25OYW1lLCBtb2RlbENsYXNzLCBjYWxsYmFjaykge1xuICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIE1vZGVsKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghbW9kZWxDbGFzcyB8fCBtb2RlbCBpbnN0YW5jZW9mIG1vZGVsQ2xhc3MpIHtcbiAgICBjYWxsYmFjayhtb2RlbCwgcGFyZW50LCByZWxhdGlvbk5hbWUpO1xuICB9XG5cbiAgY29uc3QgcmVsYXRpb25zID0gbW9kZWwuY29uc3RydWN0b3IuZ2V0UmVsYXRpb25zKCk7XG4gIGNvbnN0IHJlbE5hbWVzID0gT2JqZWN0LmtleXMocmVsYXRpb25zKTtcblxuICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbE5hbWVzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgIGNvbnN0IHJlbE5hbWUgPSByZWxOYW1lc1tpXTtcblxuICAgIGlmIChtb2RlbC5oYXNPd25Qcm9wZXJ0eShyZWxOYW1lKSkge1xuICAgICAgdHJhdmVyc2UobW9kZWxbcmVsTmFtZV0sIG1vZGVsLCByZWxOYW1lLCBtb2RlbENsYXNzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGlkQ29sdW1uVG9JZFByb3BlcnR5KE1vZGVsQ2xhc3MsIGlkQ29sdW1uKSB7XG4gIGxldCBpZFByb3BlcnR5ID0gTW9kZWxDbGFzcy5jb2x1bW5OYW1lVG9Qcm9wZXJ0eU5hbWUoaWRDb2x1bW4pO1xuXG4gIGlmICghaWRQcm9wZXJ0eSkge1xuICAgIHRocm93IG5ldyBFcnJvcihNb2RlbENsYXNzLnRhYmxlTmFtZSArICcuJHBhcnNlRGF0YWJhc2VKc29uIHByb2JhYmx5IGNoYW5nZXMgdGhlIHZhbHVlIG9mIHRoZSBpZCBjb2x1bW4gYCcgKyBpZENvbHVtbiArICdgIHdoaWNoIGlzIGEgbm8tbm8uJyk7XG4gIH1cblxuICByZXR1cm4gaWRQcm9wZXJ0eTtcbn1cblxuZnVuY3Rpb24gc2V0SWQobW9kZWwsIGlkKSB7XG4gIGNvbnN0IGlkUHJvcCA9IG1vZGVsLmNvbnN0cnVjdG9yLmdldElkUHJvcGVydHkoKTtcbiAgY29uc3QgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkoaWRQcm9wKTtcblxuICBpZiAoQXJyYXkuaXNBcnJheShpZCkpIHtcbiAgICBpZiAoaXNBcnJheSkge1xuICAgICAgaWYgKGlkLmxlbmd0aCAhPT0gaWRQcm9wLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RyeWluZyB0byBzZXQgYW4gaW52YWxpZCBpZGVudGlmaWVyIGZvciBhIG1vZGVsJyk7XG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaWQubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgbW9kZWxbaWRQcm9wW2ldXSA9IGlkW2ldO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaWQubGVuZ3RoICE9PSAxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigndHJ5aW5nIHRvIHNldCBhbiBpbnZhbGlkIGlkZW50aWZpZXIgZm9yIGEgbW9kZWwnKTtcbiAgICAgIH1cblxuICAgICAgbW9kZWxbaWRQcm9wXSA9IGlkWzBdO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoaXNBcnJheSkge1xuICAgICAgaWYgKGlkUHJvcC5sZW5ndGggPiAxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigndHJ5aW5nIHRvIHNldCBhbiBpbnZhbGlkIGlkZW50aWZpZXIgZm9yIGEgbW9kZWwnKTtcbiAgICAgIH1cblxuICAgICAgbW9kZWxbaWRQcm9wWzBdXSA9IGlkO1xuICAgIH0gZWxzZSB7XG4gICAgICBtb2RlbFtpZFByb3BdID0gaWQ7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldElkKG1vZGVsKSB7XG4gIGNvbnN0IGlkUHJvcCA9IG1vZGVsLmNvbnN0cnVjdG9yLmdldElkUHJvcGVydHkoKTtcblxuICBpZiAoQXJyYXkuaXNBcnJheShpZFByb3ApKSB7XG4gICAgcmV0dXJuIG1vZGVsLiR2YWx1ZXMoaWRQcm9wKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbW9kZWxbaWRQcm9wXTtcbiAgfVxufSJdfQ==