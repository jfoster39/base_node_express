'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _DelegateOperation2 = require('./DelegateOperation');

var _DelegateOperation3 = _interopRequireDefault(_DelegateOperation2);

var _GraphInserter = require('../graphInserter/GraphInserter');

var _GraphInserter2 = _interopRequireDefault(_GraphInserter);

var _dbUtils = require('../../utils/dbUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var InsertGraphOperation = function (_DelegateOperation) {
  (0, _inherits3.default)(InsertGraphOperation, _DelegateOperation);

  function InsertGraphOperation(name, opt) {
    (0, _classCallCheck3.default)(this, InsertGraphOperation);

    // Our delegate method inherits from `InsertRelation`. Disable the call-time
    // validation. We do the validation in onAfterQuery instead.
    var _this = (0, _possibleConstructorReturn3.default)(this, _DelegateOperation.call(this, name, opt));

    _this.delegate.modelOptions.skipValidation = true;
    return _this;
  }

  InsertGraphOperation.prototype.call = function call(builder, args) {
    var retVal = _DelegateOperation.prototype.call.call(this, builder, args);

    // We resolve this query here and will not execute it. This is because the root
    // value may depend on other models in the graph and cannot be inserted first.
    builder.resolve([]);

    return retVal;
  };

  InsertGraphOperation.prototype.onBefore = function onBefore() {
    // Do nothing.
  };

  InsertGraphOperation.prototype.onBeforeInternal = function onBeforeInternal() {
    // Do nothing. We override this with empty implementation so that
    // the $beforeInsert() hooks are not called twice for the root models.
  };

  InsertGraphOperation.prototype.onBeforeBuild = function onBeforeBuild() {
    // Do nothing.
  };

  InsertGraphOperation.prototype.onBuild = function onBuild() {}
  // Do nothing.


  // We overrode all other hooks but this one and do all the work in here.
  // This is a bit hacky.
  ;

  InsertGraphOperation.prototype.onAfterQuery = function onAfterQuery(builder) {
    var _this2 = this;

    var ModelClass = builder.modelClass();
    var batchSize = (0, _dbUtils.isPostgres)(builder.knex()) ? 100 : 1;

    var inserter = new _GraphInserter2.default({
      modelClass: ModelClass,
      models: this.models,
      allowedRelations: builder._allowedInsertExpression || null,
      knex: builder.knex()
    });

    return inserter.execute(function (tableInsertion) {
      var inputs = [];
      var others = [];
      var queries = [];

      var insertQuery = tableInsertion.modelClass.query().childQueryOf(builder);

      for (var i = 0, l = tableInsertion.models.length; i < l; ++i) {
        var model = tableInsertion.models[i];

        // We skipped the validation above. We need to validate here since at this point
        // the models should no longer contain any special properties.
        model.$validate();

        if (tableInsertion.isInputModel[i]) {
          inputs.push(model);
        } else {
          others.push(model);
        }
      }

      batchInsert(inputs, insertQuery.clone().copyFrom(builder, /returning/), batchSize, queries);
      batchInsert(others, insertQuery.clone(), batchSize, queries);

      return _bluebird2.default.all(queries);
    }).then(function () {
      return _DelegateOperation.prototype.onAfterQuery.call(_this2, builder, _this2.models);
    });
  };

  InsertGraphOperation.prototype.onAfterInternal = function onAfterInternal() {
    // We override this with empty implementation so that the $afterInsert() hooks
    // are not called twice for the root models.
    return this.isArray ? this.models : this.models[0] || null;
  };

  (0, _createClass3.default)(InsertGraphOperation, [{
    key: 'models',
    get: function get() {
      return this.delegate.models;
    }
  }, {
    key: 'isArray',
    get: function get() {
      return this.delegate.isArray;
    }
  }]);
  return InsertGraphOperation;
}(_DelegateOperation3.default);

exports.default = InsertGraphOperation;


function batchInsert(models, queryBuilder, batchSize, queries) {
  var batches = _lodash2.default.chunk(models, batchSize);

  for (var i = 0, l = batches.length; i < l; ++i) {
    queries.push(queryBuilder.clone().insert(batches[i]));
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkluc2VydEdyYXBoT3BlcmF0aW9uLmpzIl0sIm5hbWVzIjpbIkluc2VydEdyYXBoT3BlcmF0aW9uIiwibmFtZSIsIm9wdCIsImRlbGVnYXRlIiwibW9kZWxPcHRpb25zIiwic2tpcFZhbGlkYXRpb24iLCJjYWxsIiwiYnVpbGRlciIsImFyZ3MiLCJyZXRWYWwiLCJyZXNvbHZlIiwib25CZWZvcmUiLCJvbkJlZm9yZUludGVybmFsIiwib25CZWZvcmVCdWlsZCIsIm9uQnVpbGQiLCJvbkFmdGVyUXVlcnkiLCJNb2RlbENsYXNzIiwibW9kZWxDbGFzcyIsImJhdGNoU2l6ZSIsImtuZXgiLCJpbnNlcnRlciIsIm1vZGVscyIsImFsbG93ZWRSZWxhdGlvbnMiLCJfYWxsb3dlZEluc2VydEV4cHJlc3Npb24iLCJleGVjdXRlIiwiaW5wdXRzIiwib3RoZXJzIiwicXVlcmllcyIsImluc2VydFF1ZXJ5IiwidGFibGVJbnNlcnRpb24iLCJxdWVyeSIsImNoaWxkUXVlcnlPZiIsImkiLCJsIiwibGVuZ3RoIiwibW9kZWwiLCIkdmFsaWRhdGUiLCJpc0lucHV0TW9kZWwiLCJwdXNoIiwiYmF0Y2hJbnNlcnQiLCJjbG9uZSIsImNvcHlGcm9tIiwiYWxsIiwidGhlbiIsIm9uQWZ0ZXJJbnRlcm5hbCIsImlzQXJyYXkiLCJxdWVyeUJ1aWxkZXIiLCJiYXRjaGVzIiwiY2h1bmsiLCJpbnNlcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztJQUVxQkEsb0I7OztBQUVuQixnQ0FBWUMsSUFBWixFQUFrQkMsR0FBbEIsRUFBdUI7QUFBQTs7QUFHckI7QUFDQTtBQUpxQiwrREFDckIsOEJBQU1ELElBQU4sRUFBWUMsR0FBWixDQURxQjs7QUFLckIsVUFBS0MsUUFBTCxDQUFjQyxZQUFkLENBQTJCQyxjQUEzQixHQUE0QyxJQUE1QztBQUxxQjtBQU10Qjs7aUNBRURDLEksaUJBQUtDLE8s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QXhDLEVBQTJDLEVBQUVELENBQTdDLEVBQWdEO0FBQzlDTCxZQUFRVyxJQUFSLENBQWFRLGFBQWFOLEtBQWIsR0FBcUJTLE1BQXJCLENBQTRCRixRQUFRZixDQUFSLENBQTVCLENBQWI7QUFDRDtBQUNGIiwiZmlsZSI6Ikluc2VydEdyYXBoT3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBEZWxlZ2F0ZU9wZXJhdGlvbiBmcm9tICcuL0RlbGVnYXRlT3BlcmF0aW9uJztcbmltcG9ydCBHcmFwaEluc2VydGVyIGZyb20gJy4uL2dyYXBoSW5zZXJ0ZXIvR3JhcGhJbnNlcnRlcic7XG5pbXBvcnQge2lzUG9zdGdyZXN9IGZyb20gJy4uLy4uL3V0aWxzL2RiVXRpbHMnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbnNlcnRHcmFwaE9wZXJhdGlvbiBleHRlbmRzIERlbGVnYXRlT3BlcmF0aW9uIHtcblxuICBjb25zdHJ1Y3RvcihuYW1lLCBvcHQpIHtcbiAgICBzdXBlcihuYW1lLCBvcHQpO1xuXG4gICAgLy8gT3VyIGRlbGVnYXRlIG1ldGhvZCBpbmhlcml0cyBmcm9tIGBJbnNlcnRSZWxhdGlvbmAuIERpc2FibGUgdGhlIGNhbGwtdGltZVxuICAgIC8vIHZhbGlkYXRpb24uIFdlIGRvIHRoZSB2YWxpZGF0aW9uIGluIG9uQWZ0ZXJRdWVyeSBpbnN0ZWFkLlxuICAgIHRoaXMuZGVsZWdhdGUubW9kZWxPcHRpb25zLnNraXBWYWxpZGF0aW9uID0gdHJ1ZTtcbiAgfVxuXG4gIGNhbGwoYnVpbGRlciwgYXJncykge1xuICAgIGNvbnN0IHJldFZhbCA9IHN1cGVyLmNhbGwoYnVpbGRlciwgYXJncyk7XG5cbiAgICAvLyBXZSByZXNvbHZlIHRoaXMgcXVlcnkgaGVyZSBhbmQgd2lsbCBub3QgZXhlY3V0ZSBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZSByb290XG4gICAgLy8gdmFsdWUgbWF5IGRlcGVuZCBvbiBvdGhlciBtb2RlbHMgaW4gdGhlIGdyYXBoIGFuZCBjYW5ub3QgYmUgaW5zZXJ0ZWQgZmlyc3QuXG4gICAgYnVpbGRlci5yZXNvbHZlKFtdKTtcblxuICAgIHJldHVybiByZXRWYWw7XG4gIH1cblxuICBnZXQgbW9kZWxzKCkge1xuICAgIHJldHVybiB0aGlzLmRlbGVnYXRlLm1vZGVscztcbiAgfVxuXG4gIGdldCBpc0FycmF5KCkge1xuICAgIHJldHVybiB0aGlzLmRlbGVnYXRlLmlzQXJyYXk7XG4gIH1cblxuICBvbkJlZm9yZSgpIHtcbiAgICAvLyBEbyBub3RoaW5nLlxuICB9XG5cbiAgb25CZWZvcmVJbnRlcm5hbCgpIHtcbiAgICAvLyBEbyBub3RoaW5nLiBXZSBvdmVycmlkZSB0aGlzIHdpdGggZW1wdHkgaW1wbGVtZW50YXRpb24gc28gdGhhdFxuICAgIC8vIHRoZSAkYmVmb3JlSW5zZXJ0KCkgaG9va3MgYXJlIG5vdCBjYWxsZWQgdHdpY2UgZm9yIHRoZSByb290IG1vZGVscy5cbiAgfVxuXG4gIG9uQmVmb3JlQnVpbGQoKSB7XG4gICAgLy8gRG8gbm90aGluZy5cbiAgfVxuXG4gIG9uQnVpbGQoKSB7XG4gICAgLy8gRG8gbm90aGluZy5cbiAgfVxuXG4gIC8vIFdlIG92ZXJyb2RlIGFsbCBvdGhlciBob29rcyBidXQgdGhpcyBvbmUgYW5kIGRvIGFsbCB0aGUgd29yayBpbiBoZXJlLlxuICAvLyBUaGlzIGlzIGEgYml0IGhhY2t5LlxuICBvbkFmdGVyUXVlcnkoYnVpbGRlcikge1xuICAgIGNvbnN0IE1vZGVsQ2xhc3MgPSBidWlsZGVyLm1vZGVsQ2xhc3MoKTtcbiAgICBjb25zdCBiYXRjaFNpemUgPSBpc1Bvc3RncmVzKGJ1aWxkZXIua25leCgpKSA/IDEwMCA6IDE7XG5cbiAgICBsZXQgaW5zZXJ0ZXIgPSBuZXcgR3JhcGhJbnNlcnRlcih7XG4gICAgICBtb2RlbENsYXNzOiBNb2RlbENsYXNzLFxuICAgICAgbW9kZWxzOiB0aGlzLm1vZGVscyxcbiAgICAgIGFsbG93ZWRSZWxhdGlvbnM6IGJ1aWxkZXIuX2FsbG93ZWRJbnNlcnRFeHByZXNzaW9uIHx8IG51bGwsXG4gICAgICBrbmV4OiBidWlsZGVyLmtuZXgoKVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGluc2VydGVyLmV4ZWN1dGUodGFibGVJbnNlcnRpb24gPT4ge1xuICAgICAgY29uc3QgaW5wdXRzID0gW107XG4gICAgICBjb25zdCBvdGhlcnMgPSBbXTtcbiAgICAgIGNvbnN0IHF1ZXJpZXMgPSBbXTtcblxuICAgICAgbGV0IGluc2VydFF1ZXJ5ID0gdGFibGVJbnNlcnRpb24ubW9kZWxDbGFzc1xuICAgICAgICAucXVlcnkoKVxuICAgICAgICAuY2hpbGRRdWVyeU9mKGJ1aWxkZXIpO1xuXG4gICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRhYmxlSW5zZXJ0aW9uLm1vZGVscy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgICAgY29uc3QgbW9kZWwgPSB0YWJsZUluc2VydGlvbi5tb2RlbHNbaV07XG5cbiAgICAgICAgLy8gV2Ugc2tpcHBlZCB0aGUgdmFsaWRhdGlvbiBhYm92ZS4gV2UgbmVlZCB0byB2YWxpZGF0ZSBoZXJlIHNpbmNlIGF0IHRoaXMgcG9pbnRcbiAgICAgICAgLy8gdGhlIG1vZGVscyBzaG91bGQgbm8gbG9uZ2VyIGNvbnRhaW4gYW55IHNwZWNpYWwgcHJvcGVydGllcy5cbiAgICAgICAgbW9kZWwuJHZhbGlkYXRlKCk7XG5cbiAgICAgICAgaWYgKHRhYmxlSW5zZXJ0aW9uLmlzSW5wdXRNb2RlbFtpXSkge1xuICAgICAgICAgIGlucHV0cy5wdXNoKG1vZGVsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdGhlcnMucHVzaChtb2RlbCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgYmF0Y2hJbnNlcnQoaW5wdXRzLCBpbnNlcnRRdWVyeS5jbG9uZSgpLmNvcHlGcm9tKGJ1aWxkZXIsIC9yZXR1cm5pbmcvKSwgYmF0Y2hTaXplLCBxdWVyaWVzKTtcbiAgICAgIGJhdGNoSW5zZXJ0KG90aGVycywgaW5zZXJ0UXVlcnkuY2xvbmUoKSwgYmF0Y2hTaXplLCBxdWVyaWVzKTtcblxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHF1ZXJpZXMpO1xuICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHN1cGVyLm9uQWZ0ZXJRdWVyeShidWlsZGVyLCB0aGlzLm1vZGVscylcbiAgICB9KTtcbiAgfVxuXG4gIG9uQWZ0ZXJJbnRlcm5hbCgpIHtcbiAgICAvLyBXZSBvdmVycmlkZSB0aGlzIHdpdGggZW1wdHkgaW1wbGVtZW50YXRpb24gc28gdGhhdCB0aGUgJGFmdGVySW5zZXJ0KCkgaG9va3NcbiAgICAvLyBhcmUgbm90IGNhbGxlZCB0d2ljZSBmb3IgdGhlIHJvb3QgbW9kZWxzLlxuICAgIHJldHVybiB0aGlzLmlzQXJyYXkgPyB0aGlzLm1vZGVscyA6ICh0aGlzLm1vZGVsc1swXSB8fCBudWxsKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBiYXRjaEluc2VydChtb2RlbHMsIHF1ZXJ5QnVpbGRlciwgYmF0Y2hTaXplLCBxdWVyaWVzKSB7XG4gIGNvbnN0IGJhdGNoZXMgPSBfLmNodW5rKG1vZGVscywgYmF0Y2hTaXplKTtcblxuICBmb3IgKGxldCBpID0gMCwgbCA9IGJhdGNoZXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgcXVlcmllcy5wdXNoKHF1ZXJ5QnVpbGRlci5jbG9uZSgpLmluc2VydChiYXRjaGVzW2ldKSk7XG4gIH1cbn1cblxuIl19