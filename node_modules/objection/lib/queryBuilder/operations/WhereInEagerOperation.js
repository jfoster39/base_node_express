'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _ValidationError = require('../../ValidationError');

var _ValidationError2 = _interopRequireDefault(_ValidationError);

var _EagerOperation2 = require('./EagerOperation');

var _EagerOperation3 = _interopRequireDefault(_EagerOperation2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var WhereInEagerOperation = function (_EagerOperation) {
  (0, _inherits3.default)(WhereInEagerOperation, _EagerOperation);

  function WhereInEagerOperation() {
    (0, _classCallCheck3.default)(this, WhereInEagerOperation);
    return (0, _possibleConstructorReturn3.default)(this, _EagerOperation.apply(this, arguments));
  }

  WhereInEagerOperation.prototype.onAfterInternal = function onAfterInternal(builder, result) {
    var models = Array.isArray(result) ? result : [result];

    if (!models.length || !(models[0] instanceof builder.modelClass())) {
      return result;
    }

    var promises = [];

    this.expression.forEachChild(function (child) {
      var relation = builder.modelClass().getRelations()[child.name];

      if (!relation) {
        throw new _ValidationError2.default({ eager: 'unknown relation "' + child.name + '" in an eager expression' });
      }
    });

    var relations = builder.modelClass().getRelations();
    var relNames = (0, _keys2.default)(relations);

    for (var i = 0, l = relNames.length; i < l; ++i) {
      var relName = relNames[i];
      var relation = relations[relName];

      var childExpression = this.expression.childExpression(relation.name);

      if (childExpression) {
        promises.push(this._fetchRelation(builder, models, relation, childExpression));
      }
    }

    return _bluebird2.default.all(promises).return(result);
  };

  WhereInEagerOperation.prototype._fetchRelation = function _fetchRelation(builder, models, relation, childExpression) {
    var queryBuilder = relation.ownerModelClass.RelatedQueryBuilder.forClass(relation.relatedModelClass).childQueryOf(builder).eager(childExpression);

    queryBuilder.callQueryBuilderOperation(relation.find(queryBuilder, models), []);

    for (var i = 0, l = childExpression.args.length; i < l; ++i) {
      var filterName = childExpression.args[i];
      var filter = childExpression.filters[filterName];

      if (typeof filter !== 'function') {
        throw new _ValidationError2.default({ eager: 'could not find filter "' + filterName + '" for relation "' + relation.name + '"' });
      }

      filter(queryBuilder);
    }

    return queryBuilder;
  };

  return WhereInEagerOperation;
}(_EagerOperation3.default);

exports.default = WhereInEagerOperation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIldoZXJlSW5FYWdlck9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJXaGVyZUluRWFnZXJPcGVyYXRpb24iLCJvbkFmdGVySW50ZXJuYWwiLCJidWlsZGVyIiwicmVzdWx0IiwibW9kZWxzIiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwibW9kZWxDbGFzcyIsInByb21pc2VzIiwiZXhwcmVzc2lvbiIsImZvckVhY2hDaGlsZCIsInJlbGF0aW9uIiwiZ2V0UmVsYXRpb25zIiwiY2hpbGQiLCJuYW1lIiwiZWFnZXIiLCJyZWxhdGlvbnMiLCJyZWxOYW1lcyIsImkiLCJsIiwicmVsTmFtZSIsImNoaWxkRXhwcmVzc2lvbiIsInB1c2giLCJfZmV0Y2hSZWxhdGlvbiIsImFsbCIsInJldHVybiIsInF1ZXJ5QnVpbGRlciIsIm93bmVyTW9kZWxDbGFzcyIsIlJlbGF0ZWRRdWVyeUJ1aWxkZXIiLCJmb3JDbGFzcyIsInJlbGF0ZWRNb2RlbENsYXNzIiwiY2hpbGRRdWVyeU9mIiwiY2FsbFF1ZXJ5QnVpbGRlck9wZXJhdGlvbiIsImZpbmQiLCJhcmdzIiwiZmlsdGVyTmFtZSIsImZpbHRlciIsImZpbHRlcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7SUFFcUJBLHFCOzs7Ozs7OztrQ0FFbkJDLGUsNEJBQWdCQyxPLEVBQVNDLE0sRUFBUTtBQUMvQixRQUFNQyxTQUFTQyxNQUFNQyxPQUFOLENBQWNILE1BQWQsSUFBd0JBLE1BQXhCLEdBQWlDLENBQUNBLE1BQUQsQ0FBaEQ7O0FBRUEsUUFBSSxDQUFDQyxPQUFPRyxNQUFSLElBQWtCLEVBQUVILE9BQU8sQ0FBUCxhQUFxQkYsUUFBUU0sVUFBUixFQUF2QixDQUF0QixFQUFvRTtBQUNsRSxhQUFPTCxNQUFQO0FBQ0Q7O0FBRUQsUUFBTU0sV0FBVyxFQUFqQjs7QUFFQSxTQUFLQyxVQUFMLENBQWdCQyxZQUFoQixDQUE2QixpQkFBUztBQUNwQyxVQUFJQyxXQUFXVixRQUFRTSxVQUFSLEdBQXFCSyxZQUFyQixHQUFvQ0MsTUFBTUMsSUFBMUMsQ0FBZjs7QUFFQSxVQUFJLENBQUNILFFBQUwsRUFBZTtBQUNiLGNBQU0sOEJBQW9CLEVBQUNJLE9BQU8sdUJBQXVCRixNQUFNQyxJQUE3QixHQUFvQywwQkFBNUMsRUFBcEIsQ0FBTjtBQUNEO0FBQ0YsS0FORDs7QUFRQSxRQUFNRSxZQUFZZixRQUFRTSxVQUFSLEdBQXFCSyxZQUFyQixFQUFsQjtBQUNBLFFBQU1LLFdBQVcsb0JBQVlELFNBQVosQ0FBakI7O0FBRUEsU0FBSyxJQUFJRSxJQUFJLENBQVIsRUFBV0MsSUFBSUYsU0FBU1gsTUFBN0IsRUFBcUNZLElBQUlDLENBQXpDLEVBQTRDLEVBQUVELENBQTlDLEVBQWlEO0FBQy9DLFVBQU1FLFVBQVVILFNBQVNDLENBQVQsQ0FBaEI7QUFDQSxVQUFNUCxXQUFXSyxVQUFVSSxPQUFWLENBQWpCOztBQUVBLFVBQUlDLGtCQUFrQixLQUFLWixVQUFMLENBQWdCWSxlQUFoQixDQUFnQ1YsU0FBU0csSUFBekMsQ0FBdEI7O0FBRUEsVUFBSU8sZUFBSixFQUFxQjtBQUNuQmIsaUJBQVNjLElBQVQsQ0FBYyxLQUFLQyxjQUFMLENBQW9CdEIsT0FBcEIsRUFBNkJFLE1BQTdCLEVBQXFDUSxRQUFyQyxFQUErQ1UsZUFBL0MsQ0FBZDtBQUNEO0FBQ0Y7O0FBRUQsV0FBTyxtQkFBUUcsR0FBUixDQUFZaEIsUUFBWixFQUFzQmlCLE1BQXRCLENBQTZCdkIsTUFBN0IsQ0FBUDtBQUNELEc7O2tDQUVEcUIsYywyQkFBZXRCLE8sRUFBU0UsTSxFQUFRUSxRLEVBQVVVLGUsRUFBaUI7QUFDekQsUUFBTUssZUFBZWYsU0FBU2dCLGVBQVQsQ0FBeUJDLG1CQUF6QixDQUNsQkMsUUFEa0IsQ0FDVGxCLFNBQVNtQixpQkFEQSxFQUVsQkMsWUFGa0IsQ0FFTDlCLE9BRkssRUFHbEJjLEtBSGtCLENBR1pNLGVBSFksQ0FBckI7O0FBS0FLLGlCQUFhTSx5QkFBYixDQUF1Q3JCLFNBQVNzQixJQUFULENBQWNQLFlBQWQsRUFBNEJ2QixNQUE1QixDQUF2QyxFQUE0RSxFQUE1RTs7QUFFQSxTQUFLLElBQUllLElBQUksQ0FBUixFQUFXQyxJQUFJRSxnQkFBZ0JhLElBQWhCLENBQXFCNUIsTUFBekMsRUFBaURZLElBQUlDLENBQXJELEVBQXdELEVBQUVELENBQTFELEVBQTZEO0FBQzNELFVBQU1pQixhQUFhZCxnQkFBZ0JhLElBQWhCLENBQXFCaEIsQ0FBckIsQ0FBbkI7QUFDQSxVQUFNa0IsU0FBU2YsZ0JBQWdCZ0IsT0FBaEIsQ0FBd0JGLFVBQXhCLENBQWY7O0FBRUEsVUFBSSxPQUFPQyxNQUFQLEtBQWtCLFVBQXRCLEVBQWtDO0FBQ2hDLGNBQU0sOEJBQW9CLEVBQUNyQixPQUFPLDRCQUE0Qm9CLFVBQTVCLEdBQXlDLGtCQUF6QyxHQUE4RHhCLFNBQVNHLElBQXZFLEdBQThFLEdBQXRGLEVBQXBCLENBQU47QUFDRDs7QUFFRHNCLGFBQU9WLFlBQVA7QUFDRDs7QUFFRCxXQUFPQSxZQUFQO0FBQ0QsRzs7Ozs7a0JBeERrQjNCLHFCIiwiZmlsZSI6IldoZXJlSW5FYWdlck9wZXJhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBWYWxpZGF0aW9uRXJyb3IgZnJvbSAnLi4vLi4vVmFsaWRhdGlvbkVycm9yJ1xuaW1wb3J0IEVhZ2VyT3BlcmF0aW9uIGZyb20gJy4vRWFnZXJPcGVyYXRpb24nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXaGVyZUluRWFnZXJPcGVyYXRpb24gZXh0ZW5kcyBFYWdlck9wZXJhdGlvbiB7XG5cbiAgb25BZnRlckludGVybmFsKGJ1aWxkZXIsIHJlc3VsdCkge1xuICAgIGNvbnN0IG1vZGVscyA9IEFycmF5LmlzQXJyYXkocmVzdWx0KSA/IHJlc3VsdCA6IFtyZXN1bHRdO1xuXG4gICAgaWYgKCFtb2RlbHMubGVuZ3RoIHx8ICEobW9kZWxzWzBdIGluc3RhbmNlb2YgYnVpbGRlci5tb2RlbENsYXNzKCkpKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGNvbnN0IHByb21pc2VzID0gW107XG5cbiAgICB0aGlzLmV4cHJlc3Npb24uZm9yRWFjaENoaWxkKGNoaWxkID0+IHtcbiAgICAgIGxldCByZWxhdGlvbiA9IGJ1aWxkZXIubW9kZWxDbGFzcygpLmdldFJlbGF0aW9ucygpW2NoaWxkLm5hbWVdO1xuXG4gICAgICBpZiAoIXJlbGF0aW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3Ioe2VhZ2VyOiAndW5rbm93biByZWxhdGlvbiBcIicgKyBjaGlsZC5uYW1lICsgJ1wiIGluIGFuIGVhZ2VyIGV4cHJlc3Npb24nfSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCByZWxhdGlvbnMgPSBidWlsZGVyLm1vZGVsQ2xhc3MoKS5nZXRSZWxhdGlvbnMoKTtcbiAgICBjb25zdCByZWxOYW1lcyA9IE9iamVjdC5rZXlzKHJlbGF0aW9ucyk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbE5hbWVzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3QgcmVsTmFtZSA9IHJlbE5hbWVzW2ldO1xuICAgICAgY29uc3QgcmVsYXRpb24gPSByZWxhdGlvbnNbcmVsTmFtZV07XG5cbiAgICAgIGxldCBjaGlsZEV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24uY2hpbGRFeHByZXNzaW9uKHJlbGF0aW9uLm5hbWUpO1xuXG4gICAgICBpZiAoY2hpbGRFeHByZXNzaW9uKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2godGhpcy5fZmV0Y2hSZWxhdGlvbihidWlsZGVyLCBtb2RlbHMsIHJlbGF0aW9uLCBjaGlsZEV4cHJlc3Npb24pKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpLnJldHVybihyZXN1bHQpO1xuICB9XG5cbiAgX2ZldGNoUmVsYXRpb24oYnVpbGRlciwgbW9kZWxzLCByZWxhdGlvbiwgY2hpbGRFeHByZXNzaW9uKSB7XG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID0gcmVsYXRpb24ub3duZXJNb2RlbENsYXNzLlJlbGF0ZWRRdWVyeUJ1aWxkZXJcbiAgICAgIC5mb3JDbGFzcyhyZWxhdGlvbi5yZWxhdGVkTW9kZWxDbGFzcylcbiAgICAgIC5jaGlsZFF1ZXJ5T2YoYnVpbGRlcilcbiAgICAgIC5lYWdlcihjaGlsZEV4cHJlc3Npb24pO1xuXG4gICAgcXVlcnlCdWlsZGVyLmNhbGxRdWVyeUJ1aWxkZXJPcGVyYXRpb24ocmVsYXRpb24uZmluZChxdWVyeUJ1aWxkZXIsIG1vZGVscyksIFtdKTtcblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gY2hpbGRFeHByZXNzaW9uLmFyZ3MubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICBjb25zdCBmaWx0ZXJOYW1lID0gY2hpbGRFeHByZXNzaW9uLmFyZ3NbaV07XG4gICAgICBjb25zdCBmaWx0ZXIgPSBjaGlsZEV4cHJlc3Npb24uZmlsdGVyc1tmaWx0ZXJOYW1lXTtcblxuICAgICAgaWYgKHR5cGVvZiBmaWx0ZXIgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcih7ZWFnZXI6ICdjb3VsZCBub3QgZmluZCBmaWx0ZXIgXCInICsgZmlsdGVyTmFtZSArICdcIiBmb3IgcmVsYXRpb24gXCInICsgcmVsYXRpb24ubmFtZSArICdcIid9KTtcbiAgICAgIH1cblxuICAgICAgZmlsdGVyKHF1ZXJ5QnVpbGRlcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHF1ZXJ5QnVpbGRlcjtcbiAgfVxufSJdfQ==