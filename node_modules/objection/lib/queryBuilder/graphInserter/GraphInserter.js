'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _DependencyGraph = require('./DependencyGraph');

var _DependencyGraph2 = _interopRequireDefault(_DependencyGraph);

var _TableInsertion = require('./TableInsertion');

var _TableInsertion2 = _interopRequireDefault(_TableInsertion);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var GraphInserter = function () {
  function GraphInserter(_ref) {
    var modelClass = _ref.modelClass;
    var models = _ref.models;
    var allowedRelations = _ref.allowedRelations;
    var knex = _ref.knex;
    (0, _classCallCheck3.default)(this, GraphInserter);

    /**
     * @type {Constructor.<Model>}
     */
    this.modelClass = modelClass;

    /**
     * @type {Model|Array.<Model>}
     */
    this.models = models;

    /**
     * @type {RelationExpression}
     */
    this.allowedRelations = allowedRelations || null;

    /**
     * @type {boolean}
     */
    this.done = false;

    /**
     * @type {DependencyGraph}
     */
    this.graph = this._buildDependencyGraph();

    /**
     * @type {knex}
     */
    this.knex = knex;
  }

  /**
   * @param {function(TableInsertion)} inserter
   * @return {Promise}
   */


  GraphInserter.prototype.execute = function execute(inserter) {
    return this._executeNextBatch(inserter);
  };

  /**
   * @returns {DependencyGraph}
   * @private
   */


  GraphInserter.prototype._buildDependencyGraph = function _buildDependencyGraph() {
    var graph = new _DependencyGraph2.default(this.allowedRelations);
    graph.build(this.modelClass, this.models);
    return graph;
  };

  /**
   * @param {function(TableInsertion)} inserter
   * @returns {Promise}
   * @private
   */


  GraphInserter.prototype._executeNextBatch = function _executeNextBatch(inserter) {
    var _this = this;

    var batch = this._nextBatch();

    if (!batch) {
      // If we get here, we are done. All we need to do now is to finalize the object graph
      // and return it as the final output.
      return this._finalize();
    }

    // Insert the batch using the `inserter` function.
    return _bluebird2.default.all((0, _keys2.default)(batch).map(function (tableName) {
      var tableInsertion = batch[tableName];
      var uids = void 0;

      if (!tableInsertion.isJoinTableInsertion) {
        // We need to omit the uid properties so that they don't get inserted
        // into the database. Join table insertions never have uids.
        uids = _this._omitUids(tableInsertion);
      }

      return inserter(tableInsertion).then(function () {
        if (!tableInsertion.isJoinTableInsertion) {
          // Resolve dependencies to the inserted objects. Join table insertions
          // never resolve any dependencies.
          _this._resolveDepsForInsertion(tableInsertion, uids);
        }
      });
    })).then(function () {
      return _this._executeNextBatch(inserter);
    });
  };

  /**
   * @private
   * @returns {Object.<string, TableInsertion>}
   */


  GraphInserter.prototype._nextBatch = function _nextBatch() {
    if (this.done) {
      return null;
    }

    var batch = this._createBatch();

    if (_lodash2.default.isEmpty(batch)) {
      this.done = true;
      return this._createManyToManyRelationJoinRowBatch();
    } else {
      this._markBatchHandled(batch);
      return batch;
    }
  };

  /**
   * @private
   * @returns {Object.<string, TableInsertion>}
   */


  GraphInserter.prototype._createBatch = function _createBatch() {
    var batch = (0, _create2.default)(null);
    var nodes = this.graph.nodes;

    for (var n = 0, ln = nodes.length; n < ln; ++n) {
      var node = nodes[n];

      if (!node.handled && node.needs.length === node.numHandledNeeds) {
        var tableInsertion = batch[node.modelClass.tableName];

        if (!tableInsertion) {
          tableInsertion = new _TableInsertion2.default(node.modelClass, false);
          batch[node.modelClass.tableName] = tableInsertion;
        }

        tableInsertion.models.push(node.model);
        tableInsertion.isInputModel.push(!!this.graph.inputNodesById[node.id]);
      }
    }

    return batch;
  };

  /**
   * @private
   * @param {Object.<string, TableInsertion>} batch
   */


  GraphInserter.prototype._markBatchHandled = function _markBatchHandled(batch) {
    var models = _lodash2.default.flatten(_lodash2.default.map(batch, 'models'));
    var nodes = this.graph.nodesById;

    for (var m = 0, lm = models.length; m < lm; ++m) {
      var id = models[m][models[m].constructor.uidProp];
      var node = nodes[id];

      for (var nb = 0, lnb = node.isNeededBy.length; nb < lnb; ++nb) {
        var dep = node.isNeededBy[nb];
        dep.node.numHandledNeeds++;
      }

      node.handled = true;
    }
  };

  /**
   * @private
   * @returns {Object.<string, TableInsertion>}
   */


  GraphInserter.prototype._createManyToManyRelationJoinRowBatch = function _createManyToManyRelationJoinRowBatch() {
    var batch = (0, _create2.default)(null);

    for (var n = 0, ln = this.graph.nodes.length; n < ln; ++n) {
      var node = this.graph.nodes[n];

      for (var m = 0, lm = node.manyToManyConnections.length; m < lm; ++m) {
        var conn = node.manyToManyConnections[m];
        var tableInsertion = batch[conn.relation.joinTable];

        var ownerProp = node.model.$values(conn.relation.ownerProp);
        var modelClass = conn.relation.joinTableModelClass(this.knex);
        var joinModel = conn.relation.createJoinModels(ownerProp, [conn.node.model])[0];

        if (conn.refNode) {
          // Also take extra properties from the referring model, it there was one.
          for (var k = 0, lk = conn.relation.joinTableExtraProps.length; k < lk; ++k) {
            var extraProp = conn.relation.joinTableExtraProps[k];

            if (!_lodash2.default.isUndefined(conn.refNode.model[extraProp])) {
              joinModel[extraProp] = conn.refNode.model[extraProp];
            }
          }
        }

        joinModel = modelClass.fromJson(joinModel);

        if (!tableInsertion) {
          tableInsertion = new _TableInsertion2.default(modelClass, true);
          batch[modelClass.tableName] = tableInsertion;
        }

        tableInsertion.models.push(joinModel);
        tableInsertion.isInputModel.push(false);
      }
    }

    var modelNames = (0, _keys2.default)(batch);
    // Remove duplicates.
    for (var i = 0, l = modelNames.length; i < l; ++i) {
      var modelName = modelNames[i];
      var _tableInsertion = batch[modelName];

      if (_tableInsertion.models.length) {
        (function () {
          var keys = _lodash2.default.keys(_tableInsertion.models[0]);

          _tableInsertion.models = _lodash2.default.uniqBy(_tableInsertion.models, function (model) {
            return model.$propKey(keys);
          });
          _tableInsertion.isInputModel = _lodash2.default.times(_tableInsertion.models.length, _lodash2.default.constant(false));
        })();
      }
    }

    return batch;
  };

  /**
   * @private
   */


  GraphInserter.prototype._omitUids = function _omitUids(tableInsertion) {
    var ids = _lodash2.default.map(tableInsertion.models, tableInsertion.modelClass.uidProp);

    for (var m = 0, lm = tableInsertion.models.length; m < lm; ++m) {
      tableInsertion.models[m].$omit(tableInsertion.modelClass.uidProp);
    }

    return ids;
  };

  /**
   * @private
   * @param {TableInsertion} tableInsertion
   * @param {Array.<string>} uids
   */


  GraphInserter.prototype._resolveDepsForInsertion = function _resolveDepsForInsertion(tableInsertion, uids) {
    for (var m = 0, lm = tableInsertion.models.length; m < lm; ++m) {
      var node = this.graph.nodesById[uids[m]];
      var model = tableInsertion.models[m];

      for (var d = 0, ld = node.isNeededBy.length; d < ld; ++d) {
        node.isNeededBy[d].resolve(model);
      }
    }
  };

  /**
   * @private
   * @return {Promise}
   */


  GraphInserter.prototype._finalize = function _finalize() {
    for (var n = 0, ln = this.graph.nodes.length; n < ln; ++n) {
      var refNode = this.graph.nodes[n];
      var ref = refNode.model[refNode.modelClass.uidRefProp];

      if (ref) {
        // Copy all the properties to the reference nodes.
        var actualNode = this.graph.nodesById[ref];
        var relations = actualNode.modelClass.getRelations();
        var keys = (0, _keys2.default)(actualNode.model);

        for (var i = 0, l = keys.length; i < l; ++i) {
          var key = keys[i];
          var value = actualNode.model[key];

          if (!relations[key] && !_lodash2.default.isFunction(value)) {
            refNode.model[key] = value;
          }
        }

        refNode.model.$omit(refNode.modelClass.uidProp, refNode.modelClass.uidRefProp);
      }
    }

    return _bluebird2.default.resolve(this.models);
  };

  return GraphInserter;
}();

exports.default = GraphInserter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdyYXBoSW5zZXJ0ZXIuanMiXSwibmFtZXMiOlsiR3JhcGhJbnNlcnRlciIsIm1vZGVsQ2xhc3MiLCJtb2RlbHMiLCJhbGxvd2VkUmVsYXRpb25zIiwia25leCIsImRvbmUiLCJncmFwaCIsIl9idWlsZERlcGVuZGVuY3lHcmFwaCIsImV4ZWN1dGUiLCJpbnNlcnRlciIsIl9leGVjdXRlTmV4dEJhdGNoIiwiYnVpbGQiLCJiYXRjaCIsIl9uZXh0QmF0Y2giLCJfZmluYWxpemUiLCJhbGwiLCJtYXAiLCJ0YWJsZUluc2VydGlvbiIsInRhYmxlTmFtZSIsInVpZHMiLCJpc0pvaW5UYWJsZUluc2VydGlvbiIsIl9vbWl0VWlkcyIsInRoZW4iLCJfcmVzb2x2ZURlcHNGb3JJbnNlcnRpb24iLCJfY3JlYXRlQmF0Y2giLCJpc0VtcHR5IiwiX2NyZWF0ZU1hbnlUb01hbnlSZWxhdGlvbkpvaW5Sb3dCYXRjaCIsIl9tYXJrQmF0Y2hIYW5kbGVkIiwibm9kZXMiLCJuIiwibG4iLCJsZW5ndGgiLCJub2RlIiwiaGFuZGxlZCIsIm5lZWRzIiwibnVtSGFuZGxlZE5lZWRzIiwicHVzaCIsIm1vZGVsIiwiaXNJbnB1dE1vZGVsIiwiaW5wdXROb2Rlc0J5SWQiLCJpZCIsImZsYXR0ZW4iLCJub2Rlc0J5SWQiLCJtIiwibG0iLCJjb25zdHJ1Y3RvciIsInVpZFByb3AiLCJuYiIsImxuYiIsImlzTmVlZGVkQnkiLCJkZXAiLCJtYW55VG9NYW55Q29ubmVjdGlvbnMiLCJjb25uIiwicmVsYXRpb24iLCJqb2luVGFibGUiLCJvd25lclByb3AiLCIkdmFsdWVzIiwiam9pblRhYmxlTW9kZWxDbGFzcyIsImpvaW5Nb2RlbCIsImNyZWF0ZUpvaW5Nb2RlbHMiLCJyZWZOb2RlIiwiayIsImxrIiwiam9pblRhYmxlRXh0cmFQcm9wcyIsImV4dHJhUHJvcCIsImlzVW5kZWZpbmVkIiwiZnJvbUpzb24iLCJtb2RlbE5hbWVzIiwiaSIsImwiLCJtb2RlbE5hbWUiLCJrZXlzIiwidW5pcUJ5IiwiJHByb3BLZXkiLCJ0aW1lcyIsImNvbnN0YW50IiwiaWRzIiwiJG9taXQiLCJkIiwibGQiLCJyZXNvbHZlIiwicmVmIiwidWlkUmVmUHJvcCIsImFjdHVhbE5vZGUiLCJyZWxhdGlvbnMiLCJnZXRSZWxhdGlvbnMiLCJrZXkiLCJ2YWx1ZSIsImlzRnVuY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7Ozs7O0lBRXFCQSxhO0FBRW5CLCtCQUEwRDtBQUFBLFFBQTdDQyxVQUE2QyxRQUE3Q0EsVUFBNkM7QUFBQSxRQUFqQ0MsTUFBaUMsUUFBakNBLE1BQWlDO0FBQUEsUUFBekJDLGdCQUF5QixRQUF6QkEsZ0JBQXlCO0FBQUEsUUFBUEMsSUFBTyxRQUFQQSxJQUFPO0FBQUE7O0FBQ3hEOzs7QUFHQSxTQUFLSCxVQUFMLEdBQWtCQSxVQUFsQjs7QUFFQTs7O0FBR0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkOztBQUVBOzs7QUFHQSxTQUFLQyxnQkFBTCxHQUF3QkEsb0JBQW9CLElBQTVDOztBQUVBOzs7QUFHQSxTQUFLRSxJQUFMLEdBQVksS0FBWjs7QUFFQTs7O0FBR0EsU0FBS0MsS0FBTCxHQUFhLEtBQUtDLHFCQUFMLEVBQWI7O0FBRUE7OztBQUdBLFNBQUtILElBQUwsR0FBWUEsSUFBWjtBQUNEOztBQUVEOzs7Ozs7MEJBSUFJLE8sb0JBQVFDLFEsRUFBVTtBQUNoQixXQUFPLEtBQUtDLGlCQUFMLENBQXVCRCxRQUF2QixDQUFQO0FBQ0QsRzs7QUFFRDs7Ozs7OzBCQUlBRixxQixvQ0FBd0I7QUFDdEIsUUFBSUQsUUFBUSw4QkFBb0IsS0FBS0gsZ0JBQXpCLENBQVo7QUFDQUcsVUFBTUssS0FBTixDQUFZLEtBQUtWLFVBQWpCLEVBQTZCLEtBQUtDLE1BQWxDO0FBQ0EsV0FBT0ksS0FBUDtBQUNELEc7O0FBRUQ7Ozs7Ozs7MEJBS0FJLGlCLDhCQUFrQkQsUSxFQUFVO0FBQUE7O0FBQzFCLFFBQUlHLFFBQVEsS0FBS0MsVUFB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QUF6QixFQUFpQ3FDLElBQUlDLENBQXJDLEVBQXdDLEVBQUVELENBQTFDLEVBQTZDO0FBQzNDLGNBQU1rQixNQUFNZixLQUFLSCxDQUFMLENBQVo7QUFDQSxjQUFNbUIsUUFBUUosV0FBVzlDLEtBQVgsQ0FBaUJpRCxHQUFqQixDQUFkOztBQUVBLGNBQUksQ0FBQ0YsVUFBVUUsR0FBVixDQUFELElBQW1CLENBQUMsaUJBQUVFLFVBQUYsQ0FBYUQsS0FBYixDQUF4QixFQUE2QztBQUMzQzNCLG9CQUFRdkIsS0FBUixDQUFjaUQsR0FBZCxJQUFxQkMsS0FBckI7QUFDRDtBQUNGOztBQUVEM0IsZ0JBQVF2QixLQUFSLENBQWN3QyxLQUFkLENBQW9CakIsUUFBUTNELFVBQVIsQ0FBbUI2QyxPQUF2QyxFQUFnRGMsUUFBUTNELFVBQVIsQ0FBbUJpRixVQUFuRTtBQUNEO0FBQ0Y7O0FBRUQsV0FBTyxtQkFBUUYsT0FBUixDQUFnQixLQUFLOUUsTUFBckIsQ0FBUDtBQUNELEc7Ozs7O2tCQWpSa0JGLGEiLCJmaWxlIjoiR3JhcGhJbnNlcnRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5cbmltcG9ydCBEZXBlbmRlbmN5R3JhcGggZnJvbSAnLi9EZXBlbmRlbmN5R3JhcGgnO1xuaW1wb3J0IFRhYmxlSW5zZXJ0aW9uIGZyb20gJy4vVGFibGVJbnNlcnRpb24nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHcmFwaEluc2VydGVyIHtcblxuICBjb25zdHJ1Y3Rvcih7bW9kZWxDbGFzcywgbW9kZWxzLCBhbGxvd2VkUmVsYXRpb25zLCBrbmV4fSkge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtDb25zdHJ1Y3Rvci48TW9kZWw+fVxuICAgICAqL1xuICAgIHRoaXMubW9kZWxDbGFzcyA9IG1vZGVsQ2xhc3M7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7TW9kZWx8QXJyYXkuPE1vZGVsPn1cbiAgICAgKi9cbiAgICB0aGlzLm1vZGVscyA9IG1vZGVscztcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtSZWxhdGlvbkV4cHJlc3Npb259XG4gICAgICovXG4gICAgdGhpcy5hbGxvd2VkUmVsYXRpb25zID0gYWxsb3dlZFJlbGF0aW9ucyB8fCBudWxsO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgdGhpcy5kb25lID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7RGVwZW5kZW5jeUdyYXBofVxuICAgICAqL1xuICAgIHRoaXMuZ3JhcGggPSB0aGlzLl9idWlsZERlcGVuZGVuY3lHcmFwaCgpO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge2tuZXh9XG4gICAgICovXG4gICAgdGhpcy5rbmV4ID0ga25leDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge2Z1bmN0aW9uKFRhYmxlSW5zZXJ0aW9uKX0gaW5zZXJ0ZXJcbiAgICogQHJldHVybiB7UHJvbWlzZX1cbiAgICovXG4gIGV4ZWN1dGUoaW5zZXJ0ZXIpIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZU5leHRCYXRjaChpbnNlcnRlcik7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge0RlcGVuZGVuY3lHcmFwaH1cbiAgICogQHByaXZhdGVcbiAgICovXG4gIF9idWlsZERlcGVuZGVuY3lHcmFwaCgpIHtcbiAgICBsZXQgZ3JhcGggPSBuZXcgRGVwZW5kZW5jeUdyYXBoKHRoaXMuYWxsb3dlZFJlbGF0aW9ucyk7XG4gICAgZ3JhcGguYnVpbGQodGhpcy5tb2RlbENsYXNzLCB0aGlzLm1vZGVscyk7XG4gICAgcmV0dXJuIGdyYXBoO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24oVGFibGVJbnNlcnRpb24pfSBpbnNlcnRlclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICogQHByaXZhdGVcbiAgICovXG4gIF9leGVjdXRlTmV4dEJhdGNoKGluc2VydGVyKSB7XG4gICAgbGV0IGJhdGNoID0gdGhpcy5fbmV4dEJhdGNoKCk7XG5cbiAgICBpZiAoIWJhdGNoKSB7XG4gICAgICAvLyBJZiB3ZSBnZXQgaGVyZSwgd2UgYXJlIGRvbmUuIEFsbCB3ZSBuZWVkIHRvIGRvIG5vdyBpcyB0byBmaW5hbGl6ZSB0aGUgb2JqZWN0IGdyYXBoXG4gICAgICAvLyBhbmQgcmV0dXJuIGl0IGFzIHRoZSBmaW5hbCBvdXRwdXQuXG4gICAgICByZXR1cm4gdGhpcy5fZmluYWxpemUoKTtcbiAgICB9XG5cbiAgICAvLyBJbnNlcnQgdGhlIGJhdGNoIHVzaW5nIHRoZSBgaW5zZXJ0ZXJgIGZ1bmN0aW9uLlxuICAgIHJldHVybiBQcm9taXNlLmFsbChPYmplY3Qua2V5cyhiYXRjaCkubWFwKHRhYmxlTmFtZSA9PiB7XG4gICAgICBjb25zdCB0YWJsZUluc2VydGlvbiA9IGJhdGNoW3RhYmxlTmFtZV07XG4gICAgICBsZXQgdWlkcztcblxuICAgICAgaWYgKCF0YWJsZUluc2VydGlvbi5pc0pvaW5UYWJsZUluc2VydGlvbikge1xuICAgICAgICAvLyBXZSBuZWVkIHRvIG9taXQgdGhlIHVpZCBwcm9wZXJ0aWVzIHNvIHRoYXQgdGhleSBkb24ndCBnZXQgaW5zZXJ0ZWRcbiAgICAgICAgLy8gaW50byB0aGUgZGF0YWJhc2UuIEpvaW4gdGFibGUgaW5zZXJ0aW9ucyBuZXZlciBoYXZlIHVpZHMuXG4gICAgICAgIHVpZHMgPSB0aGlzLl9vbWl0VWlkcyh0YWJsZUluc2VydGlvbik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBpbnNlcnRlcih0YWJsZUluc2VydGlvbikudGhlbigoKSA9PiB7XG4gICAgICAgIGlmICghdGFibGVJbnNlcnRpb24uaXNKb2luVGFibGVJbnNlcnRpb24pIHtcbiAgICAgICAgICAvLyBSZXNvbHZlIGRlcGVuZGVuY2llcyB0byB0aGUgaW5zZXJ0ZWQgb2JqZWN0cy4gSm9pbiB0YWJsZSBpbnNlcnRpb25zXG4gICAgICAgICAgLy8gbmV2ZXIgcmVzb2x2ZSBhbnkgZGVwZW5kZW5jaWVzLlxuICAgICAgICAgIHRoaXMuX3Jlc29sdmVEZXBzRm9ySW5zZXJ0aW9uKHRhYmxlSW5zZXJ0aW9uLCB1aWRzKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSkpLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVOZXh0QmF0Y2goaW5zZXJ0ZXIpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywgVGFibGVJbnNlcnRpb24+fVxuICAgKi9cbiAgX25leHRCYXRjaCgpIHtcbiAgICBpZiAodGhpcy5kb25lKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBsZXQgYmF0Y2ggPSB0aGlzLl9jcmVhdGVCYXRjaCgpO1xuXG4gICAgaWYgKF8uaXNFbXB0eShiYXRjaCkpIHtcbiAgICAgIHRoaXMuZG9uZSA9IHRydWU7XG4gICAgICByZXR1cm4gdGhpcy5fY3JlYXRlTWFueVRvTWFueVJlbGF0aW9uSm9pblJvd0JhdGNoKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX21hcmtCYXRjaEhhbmRsZWQoYmF0Y2gpO1xuICAgICAgcmV0dXJuIGJhdGNoO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsIFRhYmxlSW5zZXJ0aW9uPn1cbiAgICovXG4gIF9jcmVhdGVCYXRjaCgpIHtcbiAgICBsZXQgYmF0Y2ggPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIGxldCBub2RlcyA9IHRoaXMuZ3JhcGgubm9kZXM7XG5cbiAgICBmb3IgKGxldCBuID0gMCwgbG4gPSBub2Rlcy5sZW5ndGg7IG4gPCBsbjsgKytuKSB7XG4gICAgICBsZXQgbm9kZSA9IG5vZGVzW25dO1xuXG4gICAgICBpZiAoIW5vZGUuaGFuZGxlZCAmJiBub2RlLm5lZWRzLmxlbmd0aCA9PT0gbm9kZS5udW1IYW5kbGVkTmVlZHMpIHtcbiAgICAgICAgbGV0IHRhYmxlSW5zZXJ0aW9uID0gYmF0Y2hbbm9kZS5tb2RlbENsYXNzLnRhYmxlTmFtZV07XG5cbiAgICAgICAgaWYgKCF0YWJsZUluc2VydGlvbikge1xuICAgICAgICAgIHRhYmxlSW5zZXJ0aW9uID0gbmV3IFRhYmxlSW5zZXJ0aW9uKG5vZGUubW9kZWxDbGFzcywgZmFsc2UpO1xuICAgICAgICAgIGJhdGNoW25vZGUubW9kZWxDbGFzcy50YWJsZU5hbWVdID0gdGFibGVJbnNlcnRpb247XG4gICAgICAgIH1cblxuICAgICAgICB0YWJsZUluc2VydGlvbi5tb2RlbHMucHVzaChub2RlLm1vZGVsKTtcbiAgICAgICAgdGFibGVJbnNlcnRpb24uaXNJbnB1dE1vZGVsLnB1c2goISF0aGlzLmdyYXBoLmlucHV0Tm9kZXNCeUlkW25vZGUuaWRdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYmF0Y2g7XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgVGFibGVJbnNlcnRpb24+fSBiYXRjaFxuICAgKi9cbiAgX21hcmtCYXRjaEhhbmRsZWQoYmF0Y2gpIHtcbiAgICBsZXQgbW9kZWxzID0gXy5mbGF0dGVuKF8ubWFwKGJhdGNoLCAnbW9kZWxzJykpO1xuICAgIGxldCBub2RlcyA9IHRoaXMuZ3JhcGgubm9kZXNCeUlkO1xuXG4gICAgZm9yIChsZXQgbSA9IDAsIGxtID0gbW9kZWxzLmxlbmd0aDsgbSA8IGxtOyArK20pIHtcbiAgICAgIGxldCBpZCA9IG1vZGVsc1ttXVttb2RlbHNbbV0uY29uc3RydWN0b3IudWlkUHJvcF07XG4gICAgICBsZXQgbm9kZSA9IG5vZGVzW2lkXTtcblxuICAgICAgZm9yIChsZXQgbmIgPSAwLCBsbmIgPSBub2RlLmlzTmVlZGVkQnkubGVuZ3RoOyBuYiA8IGxuYjsgKytuYikge1xuICAgICAgICBsZXQgZGVwID0gbm9kZS5pc05lZWRlZEJ5W25iXTtcbiAgICAgICAgZGVwLm5vZGUubnVtSGFuZGxlZE5lZWRzKys7XG4gICAgICB9XG5cbiAgICAgIG5vZGUuaGFuZGxlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywgVGFibGVJbnNlcnRpb24+fVxuICAgKi9cbiAgX2NyZWF0ZU1hbnlUb01hbnlSZWxhdGlvbkpvaW5Sb3dCYXRjaCgpIHtcbiAgICBsZXQgYmF0Y2ggPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gICAgZm9yIChsZXQgbiA9IDAsIGxuID0gdGhpcy5ncmFwaC5ub2Rlcy5sZW5ndGg7IG4gPCBsbjsgKytuKSB7XG4gICAgICBsZXQgbm9kZSA9IHRoaXMuZ3JhcGgubm9kZXNbbl07XG5cbiAgICAgIGZvciAobGV0IG0gPSAwLCBsbSA9IG5vZGUubWFueVRvTWFueUNvbm5lY3Rpb25zLmxlbmd0aDsgbSA8IGxtOyArK20pIHtcbiAgICAgICAgbGV0IGNvbm4gPSBub2RlLm1hbnlUb01hbnlDb25uZWN0aW9uc1ttXTtcbiAgICAgICAgbGV0IHRhYmxlSW5zZXJ0aW9uID0gYmF0Y2hbY29ubi5yZWxhdGlvbi5qb2luVGFibGVdO1xuXG4gICAgICAgIGxldCBvd25lclByb3AgPSBub2RlLm1vZGVsLiR2YWx1ZXMoY29ubi5yZWxhdGlvbi5vd25lclByb3ApO1xuICAgICAgICBsZXQgbW9kZWxDbGFzcyA9IGNvbm4ucmVsYXRpb24uam9pblRhYmxlTW9kZWxDbGFzcyh0aGlzLmtuZXgpO1xuICAgICAgICBsZXQgam9pbk1vZGVsID0gY29ubi5yZWxhdGlvbi5jcmVhdGVKb2luTW9kZWxzKG93bmVyUHJvcCwgW2Nvbm4ubm9kZS5tb2RlbF0pWzBdO1xuXG4gICAgICAgIGlmIChjb25uLnJlZk5vZGUpIHtcbiAgICAgICAgICAvLyBBbHNvIHRha2UgZXh0cmEgcHJvcGVydGllcyBmcm9tIHRoZSByZWZlcnJpbmcgbW9kZWwsIGl0IHRoZXJlIHdhcyBvbmUuXG4gICAgICAgICAgZm9yIChsZXQgayA9IDAsIGxrID0gY29ubi5yZWxhdGlvbi5qb2luVGFibGVFeHRyYVByb3BzLmxlbmd0aDsgayA8IGxrOyArK2spIHtcbiAgICAgICAgICAgIGxldCBleHRyYVByb3AgPSBjb25uLnJlbGF0aW9uLmpvaW5UYWJsZUV4dHJhUHJvcHNba107XG5cbiAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChjb25uLnJlZk5vZGUubW9kZWxbZXh0cmFQcm9wXSkpIHtcbiAgICAgICAgICAgICAgam9pbk1vZGVsW2V4dHJhUHJvcF0gPSBjb25uLnJlZk5vZGUubW9kZWxbZXh0cmFQcm9wXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBqb2luTW9kZWwgPSBtb2RlbENsYXNzLmZyb21Kc29uKGpvaW5Nb2RlbCk7XG5cbiAgICAgICAgaWYgKCF0YWJsZUluc2VydGlvbikge1xuICAgICAgICAgIHRhYmxlSW5zZXJ0aW9uID0gbmV3IFRhYmxlSW5zZXJ0aW9uKG1vZGVsQ2xhc3MsIHRydWUpO1xuICAgICAgICAgIGJhdGNoW21vZGVsQ2xhc3MudGFibGVOYW1lXSA9IHRhYmxlSW5zZXJ0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgdGFibGVJbnNlcnRpb24ubW9kZWxzLnB1c2goam9pbk1vZGVsKTtcbiAgICAgICAgdGFibGVJbnNlcnRpb24uaXNJbnB1dE1vZGVsLnB1c2goZmFsc2UpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsTmFtZXMgPSBPYmplY3Qua2V5cyhiYXRjaCk7XG4gICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBtb2RlbE5hbWVzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3QgbW9kZWxOYW1lID0gbW9kZWxOYW1lc1tpXTtcbiAgICAgIGNvbnN0IHRhYmxlSW5zZXJ0aW9uID0gYmF0Y2hbbW9kZWxOYW1lXTtcblxuICAgICAgaWYgKHRhYmxlSW5zZXJ0aW9uLm1vZGVscy5sZW5ndGgpIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IF8ua2V5cyh0YWJsZUluc2VydGlvbi5tb2RlbHNbMF0pO1xuXG4gICAgICAgIHRhYmxlSW5zZXJ0aW9uLm1vZGVscyA9IF8udW5pcUJ5KHRhYmxlSW5zZXJ0aW9uLm1vZGVscywgbW9kZWwgPT4gbW9kZWwuJHByb3BLZXkoa2V5cykpO1xuICAgICAgICB0YWJsZUluc2VydGlvbi5pc0lucHV0TW9kZWwgPSBfLnRpbWVzKHRhYmxlSW5zZXJ0aW9uLm1vZGVscy5sZW5ndGgsIF8uY29uc3RhbnQoZmFsc2UpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYmF0Y2g7XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICovXG4gIF9vbWl0VWlkcyh0YWJsZUluc2VydGlvbikge1xuICAgIGxldCBpZHMgPSBfLm1hcCh0YWJsZUluc2VydGlvbi5tb2RlbHMsIHRhYmxlSW5zZXJ0aW9uLm1vZGVsQ2xhc3MudWlkUHJvcCk7XG5cbiAgICBmb3IgKGxldCBtID0gMCwgbG0gPSB0YWJsZUluc2VydGlvbi5tb2RlbHMubGVuZ3RoOyBtIDwgbG07ICsrbSkge1xuICAgICAgdGFibGVJbnNlcnRpb24ubW9kZWxzW21dLiRvbWl0KHRhYmxlSW5zZXJ0aW9uLm1vZGVsQ2xhc3MudWlkUHJvcCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlkcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0ge1RhYmxlSW5zZXJ0aW9ufSB0YWJsZUluc2VydGlvblxuICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSB1aWRzXG4gICAqL1xuICBfcmVzb2x2ZURlcHNGb3JJbnNlcnRpb24odGFibGVJbnNlcnRpb24sIHVpZHMpIHtcbiAgICBmb3IgKGxldCBtID0gMCwgbG0gPSB0YWJsZUluc2VydGlvbi5tb2RlbHMubGVuZ3RoOyBtIDwgbG07ICsrbSkge1xuICAgICAgbGV0IG5vZGUgPSB0aGlzLmdyYXBoLm5vZGVzQnlJZFt1aWRzW21dXTtcbiAgICAgIGxldCBtb2RlbCA9IHRhYmxlSW5zZXJ0aW9uLm1vZGVsc1ttXTtcblxuICAgICAgZm9yIChsZXQgZCA9IDAsIGxkID0gbm9kZS5pc05lZWRlZEJ5Lmxlbmd0aDsgZCA8IGxkOyArK2QpIHtcbiAgICAgICAgbm9kZS5pc05lZWRlZEJ5W2RdLnJlc29sdmUobW9kZWwpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuIHtQcm9taXNlfVxuICAgKi9cbiAgX2ZpbmFsaXplKCkge1xuICAgIGZvciAobGV0IG4gPSAwLCBsbiA9IHRoaXMuZ3JhcGgubm9kZXMubGVuZ3RoOyBuIDwgbG47ICsrbikge1xuICAgICAgbGV0IHJlZk5vZGUgPSB0aGlzLmdyYXBoLm5vZGVzW25dO1xuICAgICAgbGV0IHJlZiA9IHJlZk5vZGUubW9kZWxbcmVmTm9kZS5tb2RlbENsYXNzLnVpZFJlZlByb3BdO1xuXG4gICAgICBpZiAocmVmKSB7XG4gICAgICAgIC8vIENvcHkgYWxsIHRoZSBwcm9wZXJ0aWVzIHRvIHRoZSByZWZlcmVuY2Ugbm9kZXMuXG4gICAgICAgIGNvbnN0IGFjdHVhbE5vZGUgPSB0aGlzLmdyYXBoLm5vZGVzQnlJZFtyZWZdO1xuICAgICAgICBjb25zdCByZWxhdGlvbnMgPSBhY3R1YWxOb2RlLm1vZGVsQ2xhc3MuZ2V0UmVsYXRpb25zKCk7XG4gICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhY3R1YWxOb2RlLm1vZGVsKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGFjdHVhbE5vZGUubW9kZWxba2V5XTtcblxuICAgICAgICAgIGlmICghcmVsYXRpb25zW2tleV0gJiYgIV8uaXNGdW5jdGlvbih2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJlZk5vZGUubW9kZWxba2V5XSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJlZk5vZGUubW9kZWwuJG9taXQocmVmTm9kZS5tb2RlbENsYXNzLnVpZFByb3AsIHJlZk5vZGUubW9kZWxDbGFzcy51aWRSZWZQcm9wKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMubW9kZWxzKTtcbiAgfVxufSJdfQ==