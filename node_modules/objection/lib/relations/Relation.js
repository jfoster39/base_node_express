'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _getOwnPropertyDescriptor = require('babel-runtime/core-js/object/get-own-property-descriptor');

var _getOwnPropertyDescriptor2 = _interopRequireDefault(_getOwnPropertyDescriptor);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _desc, _value, _class;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _memoize = require('../utils/decorators/memoize');

var _memoize2 = _interopRequireDefault(_memoize);

var _classUtils = require('../utils/classUtils');

var _hiddenData = require('../utils/hiddenData');

var _QueryBuilder = require('../queryBuilder/QueryBuilder');

var _QueryBuilder2 = _interopRequireDefault(_QueryBuilder);

var _RelationFindOperation = require('./RelationFindOperation');

var _RelationFindOperation2 = _interopRequireDefault(_RelationFindOperation);

var _RelationUpdateOperation = require('./RelationUpdateOperation');

var _RelationUpdateOperation2 = _interopRequireDefault(_RelationUpdateOperation);

var _RelationDeleteOperation = require('./RelationDeleteOperation');

var _RelationDeleteOperation2 = _interopRequireDefault(_RelationDeleteOperation);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) {
  var desc = {};
  Object['ke' + 'ys'](descriptor).forEach(function (key) {
    desc[key] = descriptor[key];
  });
  desc.enumerable = !!desc.enumerable;
  desc.configurable = !!desc.configurable;

  if ('value' in desc || desc.initializer) {
    desc.writable = true;
  }

  desc = decorators.slice().reverse().reduce(function (desc, decorator) {
    return decorator(target, property, desc) || desc;
  }, desc);

  if (context && desc.initializer !== void 0) {
    desc.value = desc.initializer ? desc.initializer.call(context) : void 0;
    desc.initializer = undefined;
  }

  if (desc.initializer === void 0) {
    Object['define' + 'Property'](target, property, desc);
    desc = null;
  }

  return desc;
}

/**
 * @typedef {Object} RelationJoin

 * @property {string|Array.<string>} from
 * @property {string|Array.<string>} to
 * @property {Object} through
 * @property {Constructor.<Model>} through.modelClass
 * @property {string|Array.<string>} through.from
 * @property {string|Array.<string>} through.to
 * @property {Array.<string>} through.extra
 */

/**
 * @typedef {Object} RelationMapping
 *
 * @property {Constructor.<Model>|string} modelClass
 * @property {Relation} relation
 * @property {Object|function(QueryBuilder)} modify
 * @property {Object|function(QueryBuilder)} filter
 * @property {RelationJoin} [join]
 */

/**
 * @abstract
 */
var Relation = (_class = function () {
  function Relation(relationName, OwnerClass) {
    (0, _classCallCheck3.default)(this, Relation);

    /**
     * @type {string}
     */
    this.name = relationName;

    /**
     * @type {Constructor.<Model>}
     */
    this.ownerModelClass = OwnerClass;

    /**
     * @type {Constructor.<Model>}
     */
    this.relatedModelClass = null;

    /**
     * @type {Constructor.<Model>}
     */
    this._joinTableModelClass = null;

    /**
     * @type {Array.<string>}
     */
    this.ownerCol = null;

    /**
     * @type {Array.<string>}
     */
    this.ownerProp = null;

    /**
     * @type {Array.<string>}
     */
    this.relatedCol = null;

    /**
     * @type {Array.<string>}
     */
    this.relatedProp = null;

    /**
     * @type {string}
     */
    this.joinTable = null;

    /**
     * @type {Array.<string>}
     */
    this.joinTableOwnerCol = null;

    /**
     * @type {Array.<string>}
     */
    this.joinTableOwnerProp = null;

    /**
     * @type {Array.<string>}
     */
    this.joinTableRelatedCol = null;

    /**
     * @type {Array.<string>}
     */
    this.joinTableRelatedProp = null;

    /**
     * @type {Array.<string>}
     */
    this.joinTableExtraCols = null;

    /**
     * @type {Array.<string>}
     */
    this.joinTableExtraProps = null;

    /**
     * @type {function (QueryBuilder)}
     */
    this.modify = null;

    (0, _hiddenData.init)(this);
  }

  /**
   * @param {function=} subclassConstructor
   * @return {Constructor.<Model>}
   */


  Relation.extend = function extend(subclassConstructor) {
    (0, _classUtils.inherits)(subclassConstructor, this);
    return subclassConstructor;
  };

  /**
   * @param {RelationMapping} mapping
   */


  Relation.prototype.setMapping = function setMapping(mapping) {
    // Avoid require loop and import here.
    var Model = require(__dirname + '/../model/Model').default;

    if (!(0, _classUtils.isSubclassOf)(this.ownerModelClass, Model)) {
      this.throwError('Relation\'s owner is not a subclass of Model');
    }

    if (!mapping.modelClass) {
      this.throwError('modelClass is not defined');
    }

    this.relatedModelClass = this.resolveModel(Model, mapping.modelClass, 'modelClass');

    if (!mapping.relation) {
      this.throwError('relation is not defined');
    }

    if (!(0, _classUtils.isSubclassOf)(mapping.relation, Relation)) {
      this.throwError('relation is not a subclass of Relation');
    }

    if (!mapping.join || !mapping.join.from || !mapping.join.to) {
      this.throwError('join must be an object that maps the columns of the related models together. For example: {from: "SomeTable.id", to: "SomeOtherTable.someModelId"}');
    }

    var joinOwner = null;
    var joinRelated = null;

    var joinFrom = this.parseReference(mapping.join.from);
    var joinTo = this.parseReference(mapping.join.to);

    if (!joinFrom.table || _lodash2.default.isEmpty(joinFrom.columns)) {
      this.throwError('join.from must have format TableName.columnName. For example "SomeTable.id" or in case of composite key ["SomeTable.a", "SomeTable.b"].');
    }

    if (!joinTo.table || _lodash2.default.isEmpty(joinTo.columns)) {
      this.throwError('join.to must have format TableName.columnName. For example "SomeTable.id" or in case of composite key ["SomeTable.a", "SomeTable.b"].');
    }

    if (joinFrom.table === this.ownerModelClass.tableName) {
      joinOwner = joinFrom;
      joinRelated = joinTo;
    } else if (joinTo.table === this.ownerModelClass.tableName) {
      joinOwner = joinTo;
      joinRelated = joinFrom;
    } else {
      this.throwError('join: either `from` or `to` must point to the owner model table.');
    }

    if (joinRelated.table !== this.relatedModelClass.tableName) {
      this.throwError('join: either `from` or `to` must point to the related model table.');
    }

    this.ownerCol = joinOwner.columns;
    this.ownerProp = this.propertyName(this.ownerCol, this.ownerModelClass);
    this.relatedCol = joinRelated.columns;
    this.relatedProp = this.propertyName(this.relatedCol, this.relatedModelClass);
    this.modify = this.parseModify(mapping);
  };

  /**
   * @return {boolean}
   */


  Relation.prototype.isOneToOne = function isOneToOne() {
    return false;
  };

  /**
   * @type {Constructor.<Model>}
   */


  Relation.prototype.joinTableModelClass = function joinTableModelClass(knex) {
    if (knex && knex !== this._joinTableModelClass.knex()) {
      return this._joinTableModelClass.bindKnex(knex);
    } else {
      return this._joinTableModelClass;
    }
  };

  /**
   * @returns {Array.<string>}
   */


  Relation.prototype.fullOwnerCol = function fullOwnerCol() {
    var _this = this;

    return this.ownerCol.map(function (col) {
      return _this.ownerModelClass.tableName + '.' + col;
    });
  };

  /**
   * @returns {Array.<string>}
   */


  Relation.prototype.fullRelatedCol = function fullRelatedCol() {
    var _this2 = this;

    return this.relatedCol.map(function (col) {
      return _this2.relatedModelClass.tableName + '.' + col;
    });
  };

  /**
   * @returns {string}
   */


  Relation.prototype.relatedTableAlias = function relatedTableAlias() {
    return this.relatedModelClass.tableName + '_rel_' + this.name;
  };

  /**
   * @returns {Relation}
   */


  Relation.prototype.clone = function clone() {
    var relation = new this.constructor(this.name, this.ownerModelClass);

    relation.relatedModelClass = this.relatedModelClass;
    relation.ownerCol = this.ownerCol;
    relation.ownerProp = this.ownerProp;
    relation.relatedCol = this.relatedCol;
    relation.relatedProp = this.relatedProp;
    relation.modify = this.modify;

    relation._joinTableModelClass = this._joinTableModelClass;
    relation.joinTable = this.joinTable;
    relation.joinTableOwnerCol = this.joinTableOwnerCol;
    relation.joinTableOwnerProp = this.joinTableOwnerProp;
    relation.joinTableRelatedCol = this.joinTableRelatedCol;
    relation.joinTableRelatedProp = this.joinTableRelatedProp;
    relation.joinTableExtraCols = this.joinTableExtraCols;
    relation.joinTableExtraProps = this.joinTableExtraProps;

    (0, _hiddenData.copyHiddenData)(this, relation);

    return relation;
  };

  /**
   * @param {knex} knex
   * @returns {Relation}
   */


  Relation.prototype.bindKnex = function bindKnex(knex) {
    var bound = this.clone();

    bound.relatedModelClass = this.relatedModelClass.bindKnex(knex);
    bound.ownerModelClass = this.ownerModelClass.bindKnex(knex);

    return bound;
  };

  /**
   * @param {QueryBuilder} builder
   * @param {object} opt
   * @param {Array.<string>|Array.<Array.<(string|number)>>} opt.ownerIds
   * @param {boolean=} opt.isColumnRef
   * @returns {QueryBuilder}
   */


  Relation.prototype.findQuery = function findQuery(builder, opt) {
    var fullRelatedCol = this.fullRelatedCol();

    if (opt.isColumnRef) {
      for (var i = 0, l = fullRelatedCol.length; i < l; ++i) {
        builder.whereRef(fullRelatedCol[i], opt.ownerIds[i]);
      }
    } else {
      var hasIds = false;

      for (var _i = 0, _l = opt.ownerIds.length; _i < _l; ++_i) {
        var id = opt.ownerIds[_i];

        if (id) {
          hasIds = true;
          break;
        }
      }

      if (hasIds) {
        builder.whereInComposite(fullRelatedCol, opt.ownerIds);
      } else {
        builder.resolve([]);
      }
    }

    return builder.modify(this.modify);
  };

  /**
   * @param {QueryBuilder} builder
   * @param {object=} opt
   * @returns {QueryBuilder}
   */


  Relation.prototype.join = function join(builder, opt) {
    opt = opt || {};

    opt.joinOperation = opt.joinOperation || 'join';
    opt.relatedTableAlias = opt.relatedTableAlias || this.relatedTableAlias();
    opt.relatedJoinSelectQuery = opt.relatedJoinSelectQuery || this.relatedModelClass.query().childQueryOf(builder);
    opt.relatedTable = opt.relatedTable || this.relatedModelClass.tableName;
    opt.ownerTable = opt.ownerTable || this.ownerModelClass.tableName;

    var relatedCol = this.relatedCol.map(function (col) {
      return opt.relatedTableAlias + '.' + col;
    });
    var ownerCol = this.ownerCol.map(function (col) {
      return opt.ownerTable + '.' + col;
    });

    var relatedJoinSelectQuery = opt.relatedJoinSelectQuery.modify(this.modify).as(opt.relatedTableAlias);

    return builder[opt.joinOperation](relatedJoinSelectQuery, function (join) {
      for (var i = 0, l = relatedCol.length; i < l; ++i) {
        join.on(relatedCol[i], '=', ownerCol[i]);
      }
    });
  };

  /* istanbul ignore next */
  /**
   * @abstract
   * @param {QueryBuilder} builder
   * @param {Model} owner
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.insert = function insert(builder, owner) {
    this.throwError('not implemented');
  };

  /**
   * @param {QueryBuilder} builder
   * @param {Model} owner
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.update = function update(builder, owner) {
    return new _RelationUpdateOperation2.default('update', {
      relation: this,
      owner: owner
    });
  };

  /**
   * @param {QueryBuilder} builder
   * @param {Model} owner
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.patch = function patch(builder, owner) {
    return new _RelationUpdateOperation2.default('patch', {
      relation: this,
      owner: owner,
      modelOptions: { patch: true }
    });
  };

  /**
   * @param {QueryBuilder} builder
   * @param {Array.<Model>} owners
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.find = function find(builder, owners) {
    return new _RelationFindOperation2.default('find', {
      relation: this,
      owners: owners
    });
  };

  /**
   * @param {QueryBuilder} builder
   * @param {Model} owner
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.delete = function _delete(builder, owner) {
    return new _RelationDeleteOperation2.default('delete', {
      relation: this,
      owner: owner
    });
  };

  /* istanbul ignore next */
  /**
   * @abstract
   * @param {QueryBuilder} builder
   * @param {Model} owner
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.relate = function relate(builder, owner) {
    this.throwError('not implemented');
  };

  /* istanbul ignore next */
  /**
   * @abstract
   * @param {QueryBuilder} builder
   * @param {Model} owner
   * @returns {QueryBuilderOperation}
   */


  Relation.prototype.unrelate = function unrelate(builder, owner) {
    this.throwError('not implemented');
  };

  /* istanbul ignore next */
  /**
   * @abstract
   * @protected
   */


  Relation.prototype.createRelationProp = function createRelationProp(owners, related) {
    this.throwError('not implemented');
  };

  /**
   * @protected
   */


  Relation.prototype.propertyName = function propertyName(columns, modelClass) {
    var _this3 = this;

    return columns.map(function (column) {
      var propertyName = modelClass.columnNameToPropertyName(column);

      if (!propertyName) {
        throw new Error(modelClass.name + '.$parseDatabaseJson probably transforms the value of the column ' + column + '.' + ' This is a no-no because ' + column + ' is needed in the relation ' + _this3.ownerModelClass.tableName + '.' + _this3.name);
      }

      return propertyName;
    });
  };

  /**
   * @protected
   */


  Relation.prototype.parseModify = function parseModify(mapping) {
    var modify = mapping.modify || mapping.filter;

    if (_lodash2.default.isFunction(modify)) {
      return modify;
    } else if (_lodash2.default.isObject(modify)) {
      return function (queryBuilder) {
        queryBuilder.where(modify);
      };
    } else {
      return _lodash2.default.noop;
    }
  };

  /**
   * @protected
   */


  Relation.prototype.parseReference = function parseReference(ref) {
    if (!_lodash2.default.isArray(ref)) {
      ref = [ref];
    }

    var table = null;
    var columns = [];

    for (var i = 0; i < ref.length; ++i) {
      var refItem = ref[i];
      var ndx = refItem.lastIndexOf('.');

      var tableName = refItem.substr(0, ndx).trim();
      var columnName = refItem.substr(ndx + 1, refItem.length).trim();

      if (!tableName || table && table !== tableName || !columnName) {
        return {
          table: null,
          columns: []
        };
      } else {
        table = tableName;
      }

      columns.push(columnName);
    }

    return {
      table: table,
      columns: columns
    };
  };

  /**
   * @protected
   */


  Relation.prototype.mergeModels = function mergeModels(models1, models2) {
    var modelClass = void 0;

    models1 = _lodash2.default.compact(models1);
    models2 = _lodash2.default.compact(models2);

    if (_lodash2.default.isEmpty(models1) && _lodash2.default.isEmpty(models2)) {
      return [];
    }

    if (!_lodash2.default.isEmpty(models1)) {
      modelClass = models1[0].constructor;
    } else {
      modelClass = models2[0].constructor;
    }

    var idProperty = modelClass.getIdPropertyArray();
    var modelsById = (0, _create2.default)(null);

    for (var i = 0, l = models1.length; i < l; ++i) {
      var model = models1[i];
      var key = model.$propKey(idProperty);

      modelsById[key] = model;
    }

    for (var _i2 = 0, _l2 = models2.length; _i2 < _l2; ++_i2) {
      var _model = models2[_i2];
      var _key = _model.$propKey(idProperty);

      modelsById[_key] = _model;
    }

    return _lodash2.default.sortBy(_lodash2.default.values(modelsById), idProperty);
  };

  /**
   * @protected
   */


  Relation.prototype.resolveModel = function resolveModel(Model, modelClass, logPrefix) {
    var _this4 = this;

    var requireModel = function requireModel(path) {
      var ModelClass = void 0;

      try {
        // babel 6 style of exposing es6 exports to commonjs https://github.com/babel/babel/issues/2683
        var module = require(path);

        ModelClass = (0, _classUtils.isSubclassOf)(module.default, Model) ? module.default : module;
      } catch (err) {
        return null;
      }

      if (!(0, _classUtils.isSubclassOf)(ModelClass, Model)) {
        return null;
      }

      return ModelClass;
    };

    if (_lodash2.default.isString(modelClass)) {
      var _ret = function () {
        var ModelClass = null;

        if (isAbsolutePath(modelClass)) {
          ModelClass = requireModel(modelClass);
        } else {
          // If the path is not a absolute, try the modelPaths of the owner model class.
          _lodash2.default.each(_this4.ownerModelClass.modelPaths, function (modelPath) {
            ModelClass = requireModel(_path2.default.join(modelPath, modelClass));

            if ((0, _classUtils.isSubclassOf)(ModelClass, Model)) {
              // Break the loop.
              return false;
            }
          });
        }

        if (!(0, _classUtils.isSubclassOf)(ModelClass, Model)) {
          _this4.throwError(logPrefix + ': ' + modelClass + ' is an invalid file path to a model class');
        }

        return {
          v: ModelClass
        };
      }();

      if ((typeof _ret === 'undefined' ? 'undefined' : (0, _typeof3.default)(_ret)) === "object") return _ret.v;
    } else {
      if (!(0, _classUtils.isSubclassOf)(modelClass, Model)) {
        this.throwError(logPrefix + ' is not a subclass of Model or a file path to a module that exports one.');
      }

      return modelClass;
    }
  };

  /**
   * @protected
   */


  Relation.prototype.throwError = function throwError(message) {
    if (this.ownerModelClass && this.ownerModelClass.name && this.name) {
      throw new Error(this.ownerModelClass.name + '.relationMappings.' + this.name + ': ' + message);
    } else {
      throw new Error(this.constructor.name + ': ' + message);
    }
  };

  return Relation;
}(), (_applyDecoratedDescriptor(_class.prototype, 'fullOwnerCol', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class.prototype, 'fullOwnerCol'), _class.prototype), _applyDecoratedDescriptor(_class.prototype, 'fullRelatedCol', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class.prototype, 'fullRelatedCol'), _class.prototype), _applyDecoratedDescriptor(_class.prototype, 'relatedTableAlias', [_memoize2.default], (0, _getOwnPropertyDescriptor2.default)(_class.prototype, 'relatedTableAlias'), _class.prototype)), _class);
exports.default = Relation;


function isAbsolutePath(pth) {
  return _path2.default.normalize(pth + '/') === _path2.default.normalize(_path2.default.resolve(pth) + '/');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlbGF0aW9uLmpzIl0sIm5hbWVzIjpbIlJlbGF0aW9uIiwicmVsYXRpb25OYW1lIiwiT3duZXJDbGFzcyIsIm5hbWUiLCJvd25lck1vZGVsQ2xhc3MiLCJyZWxhdGVkTW9kZWxDbGFzcyIsIl9qb2luVGFibGVNb2RlbENsYXNzIiwib3duZXJDb2wiLCJvd25lclByb3AiLCJyZWxhdGVkQ29sIiwicmVsYXRlZFByb3AiLCJqb2luVGFibGUiLCJqb2luVGFibGVPd25lckNvbCIsImpvaW5UYWJsZU93bmVyUHJvcCIsImpvaW5UYWJsZVJlbGF0ZWRDb2wiLCJqb2luVGFibGVSZWxhdGVkUHJvcCIsImpvaW5UYWJsZUV4dHJhQ29scyIsImpvaW5UYWJsZUV4dHJhUHJvcHMiLCJtb2RpZnkiLCJleHRlbmQiLCJzdWJjbGFzc0NvbnN0cnVjdG9yIiwic2V0TWFwcGluZyIsIm1hcHBpbmciLCJNb2RlbCIsInJlcXVpcmUiLCJfX2Rpcm5hbWUiLCJkZWZhdWx0IiwidGhyb3dFcnJvciIsIm1vZGVsQ2xhc3MiLCJyZXNvbHZlTW9kZWwiLCJyZWxhdGlvbiIsImpvaW4iLCJmcm9tIiwidG8iLCJqb2luT3duZXIiLCJqb2luUmVsYXRlZCIsImpvaW5Gcm9tIiwicGFyc2VSZWZlcmVuY2UiLCJqb2luVG8iLCJ0YWJsZSIsImlzRW1wdHkiLCJjb2x1bW5zIiwidGFibGVOYW1lIiwicHJvcGVydHlOYW1lIiwicGFyc2VNb2RpZnkiLCJpc09uZVRvT25lIiwiam9pblRhYmxlTW9kZWxDbGFzcyIsImtuZXgiLCJiaW5kS25leCIsImZ1bGxPd25lckNvbCIsIm1hcCIsImNvbCIsImZ1bGxSZWxhdGVkQ29sIiwicmVsYXRlZFRhYmxlQWxpYXMiLCJjbG9uZSIsImNvbnN0cnVjdG9yIiwiYm91bmQiLCJmaW5kUXVlcnkiLCJidWlsZGVyIiwib3B0IiwiaXNDb2x1bW5SZWYiLCJpIiwibCIsImxlbmd0aCIsIndoZXJlUmVmIiwib3duZXJJZHMiLCJoYXNJZHMiLCJpZCIsIndoZXJlSW5Db21wb3NpdGUiLCJyZXNvbHZlIiwiam9pbk9wZXJhdGlvbiIsInJlbGF0ZWRKb2luU2VsZWN0UXVlcnkiLCJxdWVyeSIsImNoaWxkUXVlcnlPZiIsInJlbGF0ZWRUYWJsZSIsIm93bmVyVGFibGUiLCJhcyIsIm9uIiwiaW5zZXJ0Iiwib3duZXIiLCJ1cGRhdGUiLCJwYXRjaCIsIm1vZGVsT3B0aW9ucyIsImZpbmQiLCJvd25lcnMiLCJkZWxldGUiLCJyZWxhdGUiLCJ1bnJlbGF0ZSIsImNyZWF0ZVJlbGF0aW9uUHJvcCIsInJlbGF0ZWQiLCJjb2x1bW5OYW1lVG9Qcm9wZXJ0eU5hbWUiLCJjb2x1bW4iLCJFcnJvciIsImZpbHRlciIsImlzRnVuY3Rpb24iLCJpc09iamVjdCIsInF1ZXJ5QnVpbGRlciIsIndoZXJlIiwibm9vcCIsInJlZiIsImlzQXJyYXkiLCJyZWZJdGVtIiwibmR4IiwibGFzdEluZGV4T2YiLCJzdWJzdHIiLCJ0cmltIiwiY29sdW1uTmFtZSIsInB1c2giLCJtZXJnZU1vZGVscyIsIm1vZGVsczEiLCJtb2RlbHMyIiwiY29tcGFjdCIsImlkUHJvcGVydHkiLCJnZXRJZFByb3BlcnR5QXJyYXkiLCJtb2RlbHNCeUlkIiwibW9kZWwiLCJrZXkiLCIkcHJvcEtleSIsInNvcnRCeSIsInZhbHVlcyIsImxvZ1ByZWZpeCIsInJlcXVpcmVNb2RlbCIsInBhdGgiLCJNb2RlbENsYXNzIiwibW9kdWxlIiwiZXJyIiwiaXNTdHJpbmciLCJpc0Fic29sdXRlUGF0aCIsImVhY2giLCJtb2RlbFBhdGhzIiwibW9kZWxQYXRoIiwibWVzc2FnZSIsInB0aCIsIm5vcm1hbGl6ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOzs7Ozs7Ozs7Ozs7QUFZQTs7Ozs7Ozs7OztBQVVBOzs7SUFH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bUI2RixTQUFuQixVQUFpQzVGLFVBQWpDO0FBQ0Q7O0FBRUQ7QUFBQSxhQUFPK0Y7QUFBUDtBQXJCMEI7O0FBQUE7QUFzQjNCLEtBdEJELE1Bc0JPO0FBQ0wsVUFBSSxDQUFDLDhCQUFhL0YsVUFBYixFQUF5QkwsS0FBekIsQ0FBTCxFQUFzQztBQUNwQyxhQUFLSSxVQUFMLENBQW1CNkYsU0FBbkI7QUFDRDs7QUFFRCxhQUFPNUYsVUFBUDtBQUNEO0FBQ0YsRzs7QUFFRDs7Ozs7cUJBR0FELFUsdUJBQVd3RyxPLEVBQVM7QUFDbEIsUUFBSSxLQUFLL0gsZUFBTCxJQUF3QixLQUFLQSxlQUFMLENBQXFCRCxJQUE3QyxJQUFxRCxLQUFLQSxJQUE5RCxFQUFvRTtBQUNsRSxZQUFNLElBQUl5RixLQUFKLENBQWEsS0FBS3hGLGVBQUwsQ0FBcUJELElBQWxDLDBCQUEyRCxLQUFLQSxJQUFoRSxVQUF5RWdJLE9BQXpFLENBQU47QUFDRCxLQUZELE1BRU87QUFDTCxZQUFNLElBQUl2QyxLQUFKLENBQWEsS0FBS3JDLFdBQUwsQ0FBaUJwRCxJQUE5QixVQUF1Q2dJLE9BQXZDLENBQU47QUFDRDtBQUNGLEc7Ozs7a0JBNWpCa0JuSSxROzs7QUErakJyQixTQUFTK0gsY0FBVCxDQUF3QkssR0FBeEIsRUFBNkI7QUFDM0IsU0FBTyxlQUFLQyxTQUFMLENBQWVELE1BQU0sR0FBckIsTUFBOEIsZUFBS0MsU0FBTCxDQUFlLGVBQUtoRSxPQUFMLENBQWErRCxHQUFiLElBQW9CLEdBQW5DLENBQXJDO0FBQ0QiLCJmaWxlIjoiUmVsYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbWVtb2l6ZSBmcm9tICcuLi91dGlscy9kZWNvcmF0b3JzL21lbW9pemUnO1xuaW1wb3J0IHtpbmhlcml0cywgaXNTdWJjbGFzc09mfSBmcm9tICcuLi91dGlscy9jbGFzc1V0aWxzJztcbmltcG9ydCB7aW5pdCwgY29weUhpZGRlbkRhdGF9IGZyb20gJy4uL3V0aWxzL2hpZGRlbkRhdGEnO1xuaW1wb3J0IFF1ZXJ5QnVpbGRlciBmcm9tICcuLi9xdWVyeUJ1aWxkZXIvUXVlcnlCdWlsZGVyJztcblxuaW1wb3J0IFJlbGF0aW9uRmluZE9wZXJhdGlvbiBmcm9tICcuL1JlbGF0aW9uRmluZE9wZXJhdGlvbic7XG5pbXBvcnQgUmVsYXRpb25VcGRhdGVPcGVyYXRpb24gZnJvbSAnLi9SZWxhdGlvblVwZGF0ZU9wZXJhdGlvbic7XG5pbXBvcnQgUmVsYXRpb25EZWxldGVPcGVyYXRpb24gZnJvbSAnLi9SZWxhdGlvbkRlbGV0ZU9wZXJhdGlvbic7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVsYXRpb25Kb2luXG5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfEFycmF5LjxzdHJpbmc+fSBmcm9tXG4gKiBAcHJvcGVydHkge3N0cmluZ3xBcnJheS48c3RyaW5nPn0gdG9cbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSB0aHJvdWdoXG4gKiBAcHJvcGVydHkge0NvbnN0cnVjdG9yLjxNb2RlbD59IHRocm91Z2gubW9kZWxDbGFzc1xuICogQHByb3BlcnR5IHtzdHJpbmd8QXJyYXkuPHN0cmluZz59IHRocm91Z2guZnJvbVxuICogQHByb3BlcnR5IHtzdHJpbmd8QXJyYXkuPHN0cmluZz59IHRocm91Z2gudG9cbiAqIEBwcm9wZXJ0eSB7QXJyYXkuPHN0cmluZz59IHRocm91Z2guZXh0cmFcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJlbGF0aW9uTWFwcGluZ1xuICpcbiAqIEBwcm9wZXJ0eSB7Q29uc3RydWN0b3IuPE1vZGVsPnxzdHJpbmd9IG1vZGVsQ2xhc3NcbiAqIEBwcm9wZXJ0eSB7UmVsYXRpb259IHJlbGF0aW9uXG4gKiBAcHJvcGVydHkge09iamVjdHxmdW5jdGlvbihRdWVyeUJ1aWxkZXIpfSBtb2RpZnlcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fGZ1bmN0aW9uKFF1ZXJ5QnVpbGRlcil9IGZpbHRlclxuICogQHByb3BlcnR5IHtSZWxhdGlvbkpvaW59IFtqb2luXVxuICovXG5cbi8qKlxuICogQGFic3RyYWN0XG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlbGF0aW9uIHtcblxuICBjb25zdHJ1Y3RvcihyZWxhdGlvbk5hbWUsIE93bmVyQ2xhc3MpIHtcbiAgICAvKipcbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRoaXMubmFtZSA9IHJlbGF0aW9uTmFtZTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtDb25zdHJ1Y3Rvci48TW9kZWw+fVxuICAgICAqL1xuICAgIHRoaXMub3duZXJNb2RlbENsYXNzID0gT3duZXJDbGFzcztcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtDb25zdHJ1Y3Rvci48TW9kZWw+fVxuICAgICAqL1xuICAgIHRoaXMucmVsYXRlZE1vZGVsQ2xhc3MgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge0NvbnN0cnVjdG9yLjxNb2RlbD59XG4gICAgICovXG4gICAgdGhpcy5fam9pblRhYmxlTW9kZWxDbGFzcyA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7QXJyYXkuPHN0cmluZz59XG4gICAgICovXG4gICAgdGhpcy5vd25lckNvbCA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7QXJyYXkuPHN0cmluZz59XG4gICAgICovXG4gICAgdGhpcy5vd25lclByb3AgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge0FycmF5LjxzdHJpbmc+fVxuICAgICAqL1xuICAgIHRoaXMucmVsYXRlZENvbCA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7QXJyYXkuPHN0cmluZz59XG4gICAgICovXG4gICAgdGhpcy5yZWxhdGVkUHJvcCA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRoaXMuam9pblRhYmxlID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtBcnJheS48c3RyaW5nPn1cbiAgICAgKi9cbiAgICB0aGlzLmpvaW5UYWJsZU93bmVyQ29sID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtBcnJheS48c3RyaW5nPn1cbiAgICAgKi9cbiAgICB0aGlzLmpvaW5UYWJsZU93bmVyUHJvcCA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7QXJyYXkuPHN0cmluZz59XG4gICAgICovXG4gICAgdGhpcy5qb2luVGFibGVSZWxhdGVkQ29sID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtBcnJheS48c3RyaW5nPn1cbiAgICAgKi9cbiAgICB0aGlzLmpvaW5UYWJsZVJlbGF0ZWRQcm9wID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtBcnJheS48c3RyaW5nPn1cbiAgICAgKi9cbiAgICB0aGlzLmpvaW5UYWJsZUV4dHJhQ29scyA9IG51bGw7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7QXJyYXkuPHN0cmluZz59XG4gICAgICovXG4gICAgdGhpcy5qb2luVGFibGVFeHRyYVByb3BzID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtmdW5jdGlvbiAoUXVlcnlCdWlsZGVyKX1cbiAgICAgKi9cbiAgICB0aGlzLm1vZGlmeSA9IG51bGw7XG5cbiAgICBpbml0KHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBzdWJjbGFzc0NvbnN0cnVjdG9yXG4gICAqIEByZXR1cm4ge0NvbnN0cnVjdG9yLjxNb2RlbD59XG4gICAqL1xuICBzdGF0aWMgZXh0ZW5kKHN1YmNsYXNzQ29uc3RydWN0b3IpIHtcbiAgICBpbmhlcml0cyhzdWJjbGFzc0NvbnN0cnVjdG9yLCB0aGlzKTtcbiAgICByZXR1cm4gc3ViY2xhc3NDb25zdHJ1Y3RvcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1JlbGF0aW9uTWFwcGluZ30gbWFwcGluZ1xuICAgKi9cbiAgc2V0TWFwcGluZyhtYXBwaW5nKSB7XG4gICAgLy8gQXZvaWQgcmVxdWlyZSBsb29wIGFuZCBpbXBvcnQgaGVyZS5cbiAgICBsZXQgTW9kZWwgPSByZXF1aXJlKF9fZGlybmFtZSArICcvLi4vbW9kZWwvTW9kZWwnKS5kZWZhdWx0O1xuXG4gICAgaWYgKCFpc1N1YmNsYXNzT2YodGhpcy5vd25lck1vZGVsQ2xhc3MsIE1vZGVsKSkge1xuICAgICAgdGhpcy50aHJvd0Vycm9yKCdSZWxhdGlvblxcJ3Mgb3duZXIgaXMgbm90IGEgc3ViY2xhc3Mgb2YgTW9kZWwnKTtcbiAgICB9XG5cbiAgICBpZiAoIW1hcHBpbmcubW9kZWxDbGFzcykge1xuICAgICAgdGhpcy50aHJvd0Vycm9yKCdtb2RlbENsYXNzIGlzIG5vdCBkZWZpbmVkJyk7XG4gICAgfVxuXG4gICAgdGhpcy5yZWxhdGVkTW9kZWxDbGFzcyA9IHRoaXMucmVzb2x2ZU1vZGVsKE1vZGVsLCBtYXBwaW5nLm1vZGVsQ2xhc3MsICdtb2RlbENsYXNzJyk7XG5cbiAgICBpZiAoIW1hcHBpbmcucmVsYXRpb24pIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvcigncmVsYXRpb24gaXMgbm90IGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIWlzU3ViY2xhc3NPZihtYXBwaW5nLnJlbGF0aW9uLCBSZWxhdGlvbikpIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvcigncmVsYXRpb24gaXMgbm90IGEgc3ViY2xhc3Mgb2YgUmVsYXRpb24nKTtcbiAgICB9XG5cbiAgICBpZiAoIW1hcHBpbmcuam9pbiB8fCAhbWFwcGluZy5qb2luLmZyb20gfHwgIW1hcHBpbmcuam9pbi50bykge1xuICAgICAgdGhpcy50aHJvd0Vycm9yKCdqb2luIG11c3QgYmUgYW4gb2JqZWN0IHRoYXQgbWFwcyB0aGUgY29sdW1ucyBvZiB0aGUgcmVsYXRlZCBtb2RlbHMgdG9nZXRoZXIuIEZvciBleGFtcGxlOiB7ZnJvbTogXCJTb21lVGFibGUuaWRcIiwgdG86IFwiU29tZU90aGVyVGFibGUuc29tZU1vZGVsSWRcIn0nKTtcbiAgICB9XG5cbiAgICBsZXQgam9pbk93bmVyID0gbnVsbDtcbiAgICBsZXQgam9pblJlbGF0ZWQgPSBudWxsO1xuXG4gICAgbGV0IGpvaW5Gcm9tID0gdGhpcy5wYXJzZVJlZmVyZW5jZShtYXBwaW5nLmpvaW4uZnJvbSk7XG4gICAgbGV0IGpvaW5UbyA9IHRoaXMucGFyc2VSZWZlcmVuY2UobWFwcGluZy5qb2luLnRvKTtcblxuICAgIGlmICgham9pbkZyb20udGFibGUgfHwgXy5pc0VtcHR5KGpvaW5Gcm9tLmNvbHVtbnMpKSB7XG4gICAgICB0aGlzLnRocm93RXJyb3IoJ2pvaW4uZnJvbSBtdXN0IGhhdmUgZm9ybWF0IFRhYmxlTmFtZS5jb2x1bW5OYW1lLiBGb3IgZXhhbXBsZSBcIlNvbWVUYWJsZS5pZFwiIG9yIGluIGNhc2Ugb2YgY29tcG9zaXRlIGtleSBbXCJTb21lVGFibGUuYVwiLCBcIlNvbWVUYWJsZS5iXCJdLicpO1xuICAgIH1cblxuICAgIGlmICgham9pblRvLnRhYmxlIHx8IF8uaXNFbXB0eShqb2luVG8uY29sdW1ucykpIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvcignam9pbi50byBtdXN0IGhhdmUgZm9ybWF0IFRhYmxlTmFtZS5jb2x1bW5OYW1lLiBGb3IgZXhhbXBsZSBcIlNvbWVUYWJsZS5pZFwiIG9yIGluIGNhc2Ugb2YgY29tcG9zaXRlIGtleSBbXCJTb21lVGFibGUuYVwiLCBcIlNvbWVUYWJsZS5iXCJdLicpO1xuICAgIH1cblxuICAgIGlmIChqb2luRnJvbS50YWJsZSA9PT0gdGhpcy5vd25lck1vZGVsQ2xhc3MudGFibGVOYW1lKSB7XG4gICAgICBqb2luT3duZXIgPSBqb2luRnJvbTtcbiAgICAgIGpvaW5SZWxhdGVkID0gam9pblRvO1xuICAgIH0gZWxzZSBpZiAoam9pblRvLnRhYmxlID09PSB0aGlzLm93bmVyTW9kZWxDbGFzcy50YWJsZU5hbWUpIHtcbiAgICAgIGpvaW5Pd25lciA9IGpvaW5UbztcbiAgICAgIGpvaW5SZWxhdGVkID0gam9pbkZyb207XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvcignam9pbjogZWl0aGVyIGBmcm9tYCBvciBgdG9gIG11c3QgcG9pbnQgdG8gdGhlIG93bmVyIG1vZGVsIHRhYmxlLicpO1xuICAgIH1cblxuICAgIGlmIChqb2luUmVsYXRlZC50YWJsZSAhPT0gdGhpcy5yZWxhdGVkTW9kZWxDbGFzcy50YWJsZU5hbWUpIHtcbiAgICAgIHRoaXMudGhyb3dFcnJvcignam9pbjogZWl0aGVyIGBmcm9tYCBvciBgdG9gIG11c3QgcG9pbnQgdG8gdGhlIHJlbGF0ZWQgbW9kZWwgdGFibGUuJyk7XG4gICAgfVxuXG4gICAgdGhpcy5vd25lckNvbCA9IGpvaW5Pd25lci5jb2x1bW5zO1xuICAgIHRoaXMub3duZXJQcm9wID0gdGhpcy5wcm9wZXJ0eU5hbWUodGhpcy5vd25lckNvbCwgdGhpcy5vd25lck1vZGVsQ2xhc3MpO1xuICAgIHRoaXMucmVsYXRlZENvbCA9IGpvaW5SZWxhdGVkLmNvbHVtbnM7XG4gICAgdGhpcy5yZWxhdGVkUHJvcCA9IHRoaXMucHJvcGVydHlOYW1lKHRoaXMucmVsYXRlZENvbCwgdGhpcy5yZWxhdGVkTW9kZWxDbGFzcyk7XG4gICAgdGhpcy5tb2RpZnkgPSB0aGlzLnBhcnNlTW9kaWZ5KG1hcHBpbmcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBpc09uZVRvT25lKCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZSB7Q29uc3RydWN0b3IuPE1vZGVsPn1cbiAgICovXG4gIGpvaW5UYWJsZU1vZGVsQ2xhc3Moa25leCkge1xuICAgIGlmIChrbmV4ICYmIGtuZXggIT09IHRoaXMuX2pvaW5UYWJsZU1vZGVsQ2xhc3Mua25leCgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5fam9pblRhYmxlTW9kZWxDbGFzcy5iaW5kS25leChrbmV4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuX2pvaW5UYWJsZU1vZGVsQ2xhc3M7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn1cbiAgICovXG4gIEBtZW1vaXplXG4gIGZ1bGxPd25lckNvbCgpIHtcbiAgICByZXR1cm4gdGhpcy5vd25lckNvbC5tYXAoY29sID0+IHRoaXMub3duZXJNb2RlbENsYXNzLnRhYmxlTmFtZSArICcuJyArIGNvbCk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fVxuICAgKi9cbiAgQG1lbW9pemVcbiAgZnVsbFJlbGF0ZWRDb2woKSB7XG4gICAgcmV0dXJuIHRoaXMucmVsYXRlZENvbC5tYXAoY29sID0+IHRoaXMucmVsYXRlZE1vZGVsQ2xhc3MudGFibGVOYW1lICsgJy4nICsgY29sKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgKi9cbiAgQG1lbW9pemVcbiAgcmVsYXRlZFRhYmxlQWxpYXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVsYXRlZE1vZGVsQ2xhc3MudGFibGVOYW1lICsgJ19yZWxfJyArIHRoaXMubmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7UmVsYXRpb259XG4gICAqL1xuICBjbG9uZSgpIHtcbiAgICBjb25zdCByZWxhdGlvbiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubmFtZSwgdGhpcy5vd25lck1vZGVsQ2xhc3MpO1xuXG4gICAgcmVsYXRpb24ucmVsYXRlZE1vZGVsQ2xhc3MgPSB0aGlzLnJlbGF0ZWRNb2RlbENsYXNzO1xuICAgIHJlbGF0aW9uLm93bmVyQ29sID0gdGhpcy5vd25lckNvbDtcbiAgICByZWxhdGlvbi5vd25lclByb3AgPSB0aGlzLm93bmVyUHJvcDtcbiAgICByZWxhdGlvbi5yZWxhdGVkQ29sID0gdGhpcy5yZWxhdGVkQ29sO1xuICAgIHJlbGF0aW9uLnJlbGF0ZWRQcm9wID0gdGhpcy5yZWxhdGVkUHJvcDtcbiAgICByZWxhdGlvbi5tb2RpZnkgPSB0aGlzLm1vZGlmeTtcblxuICAgIHJlbGF0aW9uLl9qb2luVGFibGVNb2RlbENsYXNzID0gdGhpcy5fam9pblRhYmxlTW9kZWxDbGFzcztcbiAgICByZWxhdGlvbi5qb2luVGFibGUgPSB0aGlzLmpvaW5UYWJsZTtcbiAgICByZWxhdGlvbi5qb2luVGFibGVPd25lckNvbCA9IHRoaXMuam9pblRhYmxlT3duZXJDb2w7XG4gICAgcmVsYXRpb24uam9pblRhYmxlT3duZXJQcm9wID0gdGhpcy5qb2luVGFibGVPd25lclByb3A7XG4gICAgcmVsYXRpb24uam9pblRhYmxlUmVsYXRlZENvbCA9IHRoaXMuam9pblRhYmxlUmVsYXRlZENvbDtcbiAgICByZWxhdGlvbi5qb2luVGFibGVSZWxhdGVkUHJvcCA9IHRoaXMuam9pblRhYmxlUmVsYXRlZFByb3A7XG4gICAgcmVsYXRpb24uam9pblRhYmxlRXh0cmFDb2xzID0gdGhpcy5qb2luVGFibGVFeHRyYUNvbHM7XG4gICAgcmVsYXRpb24uam9pblRhYmxlRXh0cmFQcm9wcyA9IHRoaXMuam9pblRhYmxlRXh0cmFQcm9wcztcblxuICAgIGNvcHlIaWRkZW5EYXRhKHRoaXMsIHJlbGF0aW9uKTtcblxuICAgIHJldHVybiByZWxhdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge2tuZXh9IGtuZXhcbiAgICogQHJldHVybnMge1JlbGF0aW9ufVxuICAgKi9cbiAgYmluZEtuZXgoa25leCkge1xuICAgIGNvbnN0IGJvdW5kID0gdGhpcy5jbG9uZSgpO1xuXG4gICAgYm91bmQucmVsYXRlZE1vZGVsQ2xhc3MgPSB0aGlzLnJlbGF0ZWRNb2RlbENsYXNzLmJpbmRLbmV4KGtuZXgpO1xuICAgIGJvdW5kLm93bmVyTW9kZWxDbGFzcyA9IHRoaXMub3duZXJNb2RlbENsYXNzLmJpbmRLbmV4KGtuZXgpO1xuXG4gICAgcmV0dXJuIGJvdW5kO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7UXVlcnlCdWlsZGVyfSBidWlsZGVyXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRcbiAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nPnxBcnJheS48QXJyYXkuPChzdHJpbmd8bnVtYmVyKT4+fSBvcHQub3duZXJJZHNcbiAgICogQHBhcmFtIHtib29sZWFuPX0gb3B0LmlzQ29sdW1uUmVmXG4gICAqIEByZXR1cm5zIHtRdWVyeUJ1aWxkZXJ9XG4gICAqL1xuICBmaW5kUXVlcnkoYnVpbGRlciwgb3B0KSB7XG4gICAgY29uc3QgZnVsbFJlbGF0ZWRDb2wgPSB0aGlzLmZ1bGxSZWxhdGVkQ29sKCk7XG5cbiAgICBpZiAob3B0LmlzQ29sdW1uUmVmKSB7XG4gICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGZ1bGxSZWxhdGVkQ29sLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICBidWlsZGVyLndoZXJlUmVmKGZ1bGxSZWxhdGVkQ29sW2ldLCBvcHQub3duZXJJZHNbaV0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgaGFzSWRzID0gZmFsc2U7XG5cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gb3B0Lm93bmVySWRzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICBjb25zdCBpZCA9IG9wdC5vd25lcklkc1tpXTtcblxuICAgICAgICBpZiAoaWQpIHtcbiAgICAgICAgICBoYXNJZHMgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChoYXNJZHMpIHtcbiAgICAgICAgYnVpbGRlci53aGVyZUluQ29tcG9zaXRlKGZ1bGxSZWxhdGVkQ29sLCBvcHQub3duZXJJZHMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnVpbGRlci5yZXNvbHZlKFtdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYnVpbGRlci5tb2RpZnkodGhpcy5tb2RpZnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7UXVlcnlCdWlsZGVyfSBidWlsZGVyXG4gICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0XG4gICAqIEByZXR1cm5zIHtRdWVyeUJ1aWxkZXJ9XG4gICAqL1xuICBqb2luKGJ1aWxkZXIsIG9wdCkge1xuICAgIG9wdCA9IG9wdCB8fCB7fTtcblxuICAgIG9wdC5qb2luT3BlcmF0aW9uID0gb3B0LmpvaW5PcGVyYXRpb24gfHwgJ2pvaW4nO1xuICAgIG9wdC5yZWxhdGVkVGFibGVBbGlhcyA9IG9wdC5yZWxhdGVkVGFibGVBbGlhcyB8fCB0aGlzLnJlbGF0ZWRUYWJsZUFsaWFzKCk7XG4gICAgb3B0LnJlbGF0ZWRKb2luU2VsZWN0UXVlcnkgPSBvcHQucmVsYXRlZEpvaW5TZWxlY3RRdWVyeSB8fCB0aGlzLnJlbGF0ZWRNb2RlbENsYXNzLnF1ZXJ5KCkuY2hpbGRRdWVyeU9mKGJ1aWxkZXIpO1xuICAgIG9wdC5yZWxhdGVkVGFibGUgPSBvcHQucmVsYXRlZFRhYmxlIHx8IHRoaXMucmVsYXRlZE1vZGVsQ2xhc3MudGFibGVOYW1lO1xuICAgIG9wdC5vd25lclRhYmxlID0gb3B0Lm93bmVyVGFibGUgfHwgdGhpcy5vd25lck1vZGVsQ2xhc3MudGFibGVOYW1lO1xuXG4gICAgY29uc3QgcmVsYXRlZENvbCA9IHRoaXMucmVsYXRlZENvbC5tYXAoY29sID0+IGAke29wdC5yZWxhdGVkVGFibGVBbGlhc30uJHtjb2x9YCk7XG4gICAgY29uc3Qgb3duZXJDb2wgPSB0aGlzLm93bmVyQ29sLm1hcChjb2wgPT4gYCR7b3B0Lm93bmVyVGFibGV9LiR7Y29sfWApO1xuXG4gICAgY29uc3QgcmVsYXRlZEpvaW5TZWxlY3RRdWVyeSA9IG9wdC5yZWxhdGVkSm9pblNlbGVjdFF1ZXJ5XG4gICAgICAubW9kaWZ5KHRoaXMubW9kaWZ5KVxuICAgICAgLmFzKG9wdC5yZWxhdGVkVGFibGVBbGlhcyk7XG5cbiAgICByZXR1cm4gYnVpbGRlclxuICAgICAgW29wdC5qb2luT3BlcmF0aW9uXShyZWxhdGVkSm9pblNlbGVjdFF1ZXJ5LCBqb2luID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSByZWxhdGVkQ29sLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICAgIGpvaW4ub24ocmVsYXRlZENvbFtpXSwgJz0nLCBvd25lckNvbFtpXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgLyoqXG4gICAqIEBhYnN0cmFjdFxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlcn0gYnVpbGRlclxuICAgKiBAcGFyYW0ge01vZGVsfSBvd25lclxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyT3BlcmF0aW9ufVxuICAgKi9cbiAgaW5zZXJ0KGJ1aWxkZXIsIG93bmVyKSB7XG4gICAgdGhpcy50aHJvd0Vycm9yKCdub3QgaW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlcn0gYnVpbGRlclxuICAgKiBAcGFyYW0ge01vZGVsfSBvd25lclxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyT3BlcmF0aW9ufVxuICAgKi9cbiAgdXBkYXRlKGJ1aWxkZXIsIG93bmVyKSB7XG4gICAgcmV0dXJuIG5ldyBSZWxhdGlvblVwZGF0ZU9wZXJhdGlvbigndXBkYXRlJywge1xuICAgICAgcmVsYXRpb246IHRoaXMsXG4gICAgICBvd25lcjogb3duZXJcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlcn0gYnVpbGRlclxuICAgKiBAcGFyYW0ge01vZGVsfSBvd25lclxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyT3BlcmF0aW9ufVxuICAgKi9cbiAgcGF0Y2goYnVpbGRlciwgb3duZXIpIHtcbiAgICByZXR1cm4gbmV3IFJlbGF0aW9uVXBkYXRlT3BlcmF0aW9uKCdwYXRjaCcsIHtcbiAgICAgIHJlbGF0aW9uOiB0aGlzLFxuICAgICAgb3duZXI6IG93bmVyLFxuICAgICAgbW9kZWxPcHRpb25zOiB7cGF0Y2g6IHRydWV9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtRdWVyeUJ1aWxkZXJ9IGJ1aWxkZXJcbiAgICogQHBhcmFtIHtBcnJheS48TW9kZWw+fSBvd25lcnNcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlck9wZXJhdGlvbn1cbiAgICovXG4gIGZpbmQoYnVpbGRlciwgb3duZXJzKSB7XG4gICAgcmV0dXJuIG5ldyBSZWxhdGlvbkZpbmRPcGVyYXRpb24oJ2ZpbmQnLCB7XG4gICAgICByZWxhdGlvbjogdGhpcyxcbiAgICAgIG93bmVyczogb3duZXJzXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtRdWVyeUJ1aWxkZXJ9IGJ1aWxkZXJcbiAgICogQHBhcmFtIHtNb2RlbH0gb3duZXJcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlck9wZXJhdGlvbn1cbiAgICovXG4gIGRlbGV0ZShidWlsZGVyLCBvd25lcikge1xuICAgIHJldHVybiBuZXcgUmVsYXRpb25EZWxldGVPcGVyYXRpb24oJ2RlbGV0ZScsIHtcbiAgICAgIHJlbGF0aW9uOiB0aGlzLFxuICAgICAgb3duZXI6IG93bmVyXG4gICAgfSk7XG4gIH1cblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAvKipcbiAgICogQGFic3RyYWN0XG4gICAqIEBwYXJhbSB7UXVlcnlCdWlsZGVyfSBidWlsZGVyXG4gICAqIEBwYXJhbSB7TW9kZWx9IG93bmVyXG4gICAqIEByZXR1cm5zIHtRdWVyeUJ1aWxkZXJPcGVyYXRpb259XG4gICAqL1xuICByZWxhdGUoYnVpbGRlciwgb3duZXIpIHtcbiAgICB0aGlzLnRocm93RXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgLyoqXG4gICAqIEBhYnN0cmFjdFxuICAgKiBAcGFyYW0ge1F1ZXJ5QnVpbGRlcn0gYnVpbGRlclxuICAgKiBAcGFyYW0ge01vZGVsfSBvd25lclxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyT3BlcmF0aW9ufVxuICAgKi9cbiAgdW5yZWxhdGUoYnVpbGRlciwgb3duZXIpIHtcbiAgICB0aGlzLnRocm93RXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgLyoqXG4gICAqIEBhYnN0cmFjdFxuICAgKiBAcHJvdGVjdGVkXG4gICAqL1xuICBjcmVhdGVSZWxhdGlvblByb3Aob3duZXJzLCByZWxhdGVkKSB7XG4gICAgdGhpcy50aHJvd0Vycm9yKCdub3QgaW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJvdGVjdGVkXG4gICAqL1xuICBwcm9wZXJ0eU5hbWUoY29sdW1ucywgbW9kZWxDbGFzcykge1xuICAgIHJldHVybiBjb2x1bW5zLm1hcChjb2x1bW4gPT4ge1xuICAgICAgbGV0IHByb3BlcnR5TmFtZSA9IG1vZGVsQ2xhc3MuY29sdW1uTmFtZVRvUHJvcGVydHlOYW1lKGNvbHVtbik7XG5cbiAgICAgIGlmICghcHJvcGVydHlOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihtb2RlbENsYXNzLm5hbWUgK1xuICAgICAgICAgICcuJHBhcnNlRGF0YWJhc2VKc29uIHByb2JhYmx5IHRyYW5zZm9ybXMgdGhlIHZhbHVlIG9mIHRoZSBjb2x1bW4gJyArIGNvbHVtbiArICcuJyArXG4gICAgICAgICAgJyBUaGlzIGlzIGEgbm8tbm8gYmVjYXVzZSAnICsgY29sdW1uICtcbiAgICAgICAgICAnIGlzIG5lZWRlZCBpbiB0aGUgcmVsYXRpb24gJyArIHRoaXMub3duZXJNb2RlbENsYXNzLnRhYmxlTmFtZSArICcuJyArIHRoaXMubmFtZSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcm9wZXJ0eU5hbWU7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHByb3RlY3RlZFxuICAgKi9cbiAgcGFyc2VNb2RpZnkobWFwcGluZykge1xuICAgIGxldCBtb2RpZnkgPSBtYXBwaW5nLm1vZGlmeSB8fCBtYXBwaW5nLmZpbHRlcjtcblxuICAgIGlmIChfLmlzRnVuY3Rpb24obW9kaWZ5KSkge1xuICAgICAgcmV0dXJuIG1vZGlmeTtcbiAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QobW9kaWZ5KSkge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uIChxdWVyeUJ1aWxkZXIpIHtcbiAgICAgICAgcXVlcnlCdWlsZGVyLndoZXJlKG1vZGlmeSk7XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gXy5ub29wO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJvdGVjdGVkXG4gICAqL1xuICBwYXJzZVJlZmVyZW5jZShyZWYpIHtcbiAgICBpZiAoIV8uaXNBcnJheShyZWYpKSB7XG4gICAgICByZWYgPSBbcmVmXTtcbiAgICB9XG5cbiAgICBsZXQgdGFibGUgPSBudWxsO1xuICAgIGxldCBjb2x1bW5zID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlZi5sZW5ndGg7ICsraSkge1xuICAgICAgY29uc3QgcmVmSXRlbSA9IHJlZltpXTtcbiAgICAgIGNvbnN0IG5keCA9IHJlZkl0ZW0ubGFzdEluZGV4T2YoJy4nKTtcblxuICAgICAgbGV0IHRhYmxlTmFtZSA9IHJlZkl0ZW0uc3Vic3RyKDAsIG5keCkudHJpbSgpO1xuICAgICAgbGV0IGNvbHVtbk5hbWUgPSByZWZJdGVtLnN1YnN0cihuZHggKyAxLCByZWZJdGVtLmxlbmd0aCkudHJpbSgpO1xuXG4gICAgICBpZiAoIXRhYmxlTmFtZSB8fCAodGFibGUgJiYgdGFibGUgIT09IHRhYmxlTmFtZSkgfHwgIWNvbHVtbk5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0YWJsZTogbnVsbCxcbiAgICAgICAgICBjb2x1bW5zOiBbXVxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGFibGUgPSB0YWJsZU5hbWU7XG4gICAgICB9XG5cbiAgICAgIGNvbHVtbnMucHVzaChjb2x1bW5OYW1lKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgdGFibGU6IHRhYmxlLFxuICAgICAgY29sdW1uczogY29sdW1uc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQHByb3RlY3RlZFxuICAgKi9cbiAgbWVyZ2VNb2RlbHMobW9kZWxzMSwgbW9kZWxzMikge1xuICAgIGxldCBtb2RlbENsYXNzO1xuXG4gICAgbW9kZWxzMSA9IF8uY29tcGFjdChtb2RlbHMxKTtcbiAgICBtb2RlbHMyID0gXy5jb21wYWN0KG1vZGVsczIpO1xuXG4gICAgaWYgKF8uaXNFbXB0eShtb2RlbHMxKSAmJiBfLmlzRW1wdHkobW9kZWxzMikpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNFbXB0eShtb2RlbHMxKSkge1xuICAgICAgbW9kZWxDbGFzcyA9IG1vZGVsczFbMF0uY29uc3RydWN0b3I7XG4gICAgfSBlbHNlIHtcbiAgICAgIG1vZGVsQ2xhc3MgPSBtb2RlbHMyWzBdLmNvbnN0cnVjdG9yO1xuICAgIH1cblxuICAgIGxldCBpZFByb3BlcnR5ID0gbW9kZWxDbGFzcy5nZXRJZFByb3BlcnR5QXJyYXkoKTtcbiAgICBsZXQgbW9kZWxzQnlJZCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IG1vZGVsczEubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICBjb25zdCBtb2RlbCA9IG1vZGVsczFbaV07XG4gICAgICBjb25zdCBrZXkgPSBtb2RlbC4kcHJvcEtleShpZFByb3BlcnR5KTtcblxuICAgICAgbW9kZWxzQnlJZFtrZXldID0gbW9kZWw7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBtb2RlbHMyLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3QgbW9kZWwgPSBtb2RlbHMyW2ldO1xuICAgICAgY29uc3Qga2V5ID0gbW9kZWwuJHByb3BLZXkoaWRQcm9wZXJ0eSk7XG5cbiAgICAgIG1vZGVsc0J5SWRba2V5XSA9IG1vZGVsO1xuICAgIH1cblxuICAgIHJldHVybiBfLnNvcnRCeShfLnZhbHVlcyhtb2RlbHNCeUlkKSwgaWRQcm9wZXJ0eSk7XG4gIH1cblxuICAvKipcbiAgICogQHByb3RlY3RlZFxuICAgKi9cbiAgcmVzb2x2ZU1vZGVsKE1vZGVsLCBtb2RlbENsYXNzLCBsb2dQcmVmaXgpIHtcbiAgICBjb25zdCByZXF1aXJlTW9kZWwgPSAocGF0aCkgPT4ge1xuICAgICAgbGV0IE1vZGVsQ2xhc3M7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIGJhYmVsIDYgc3R5bGUgb2YgZXhwb3NpbmcgZXM2IGV4cG9ydHMgdG8gY29tbW9uanMgaHR0cHM6Ly9naXRodWIuY29tL2JhYmVsL2JhYmVsL2lzc3Vlcy8yNjgzXG4gICAgICAgIGxldCBtb2R1bGUgPSByZXF1aXJlKHBhdGgpO1xuXG4gICAgICAgIE1vZGVsQ2xhc3MgPSBpc1N1YmNsYXNzT2YobW9kdWxlLmRlZmF1bHQsIE1vZGVsKVxuICAgICAgICAgID8gbW9kdWxlLmRlZmF1bHRcbiAgICAgICAgICA6IG1vZHVsZTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpc1N1YmNsYXNzT2YoTW9kZWxDbGFzcywgTW9kZWwpKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gTW9kZWxDbGFzcztcbiAgICB9O1xuXG4gICAgaWYgKF8uaXNTdHJpbmcobW9kZWxDbGFzcykpIHtcbiAgICAgIGxldCBNb2RlbENsYXNzID0gbnVsbDtcblxuICAgICAgaWYgKGlzQWJzb2x1dGVQYXRoKG1vZGVsQ2xhc3MpKSB7XG4gICAgICAgIE1vZGVsQ2xhc3MgPSByZXF1aXJlTW9kZWwobW9kZWxDbGFzcyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBJZiB0aGUgcGF0aCBpcyBub3QgYSBhYnNvbHV0ZSwgdHJ5IHRoZSBtb2RlbFBhdGhzIG9mIHRoZSBvd25lciBtb2RlbCBjbGFzcy5cbiAgICAgICAgXy5lYWNoKHRoaXMub3duZXJNb2RlbENsYXNzLm1vZGVsUGF0aHMsIG1vZGVsUGF0aCA9PiB7XG4gICAgICAgICAgTW9kZWxDbGFzcyA9IHJlcXVpcmVNb2RlbChwYXRoLmpvaW4obW9kZWxQYXRoLCBtb2RlbENsYXNzKSk7XG5cbiAgICAgICAgICBpZiAoaXNTdWJjbGFzc09mKE1vZGVsQ2xhc3MsIE1vZGVsKSkge1xuICAgICAgICAgICAgLy8gQnJlYWsgdGhlIGxvb3AuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpc1N1YmNsYXNzT2YoTW9kZWxDbGFzcywgTW9kZWwpKSB7XG4gICAgICAgIHRoaXMudGhyb3dFcnJvcihgJHtsb2dQcmVmaXh9OiAke21vZGVsQ2xhc3N9IGlzIGFuIGludmFsaWQgZmlsZSBwYXRoIHRvIGEgbW9kZWwgY2xhc3NgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIE1vZGVsQ2xhc3M7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghaXNTdWJjbGFzc09mKG1vZGVsQ2xhc3MsIE1vZGVsKSkge1xuICAgICAgICB0aGlzLnRocm93RXJyb3IoYCR7bG9nUHJlZml4fSBpcyBub3QgYSBzdWJjbGFzcyBvZiBNb2RlbCBvciBhIGZpbGUgcGF0aCB0byBhIG1vZHVsZSB0aGF0IGV4cG9ydHMgb25lLmApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbW9kZWxDbGFzcztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHByb3RlY3RlZFxuICAgKi9cbiAgdGhyb3dFcnJvcihtZXNzYWdlKSB7XG4gICAgaWYgKHRoaXMub3duZXJNb2RlbENsYXNzICYmIHRoaXMub3duZXJNb2RlbENsYXNzLm5hbWUgJiYgdGhpcy5uYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dGhpcy5vd25lck1vZGVsQ2xhc3MubmFtZX0ucmVsYXRpb25NYXBwaW5ncy4ke3RoaXMubmFtZX06ICR7bWVzc2FnZX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMuY29uc3RydWN0b3IubmFtZX06ICR7bWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNBYnNvbHV0ZVBhdGgocHRoKSB7XG4gIHJldHVybiBwYXRoLm5vcm1hbGl6ZShwdGggKyAnLycpID09PSBwYXRoLm5vcm1hbGl6ZShwYXRoLnJlc29sdmUocHRoKSArICcvJyk7XG59Il19